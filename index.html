<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ã–zel Ders Takip Sistemi</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --text-main: #2b2d42;
      --text-muted: #8d99ae;
      --border-radius: 16px;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 8px 24px rgba(67, 97, 238, 0.08);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      padding-bottom: 80px; /* Mobil navigasyon iÃ§in boÅŸluk */
    }

    /* Navbar & Header */
    .main-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      padding-bottom: 3rem;
      border-bottom-left-radius: 30px;
      border-bottom-right-radius: 30px;
      margin-bottom: -2rem;
      color: white;
      box-shadow: 0 4px 20px rgba(63, 55, 201, 0.3);
    }

    .navbar-brand {
      color: white !important;
      font-weight: 600;
      font-size: 1.25rem;
    }
    
    .navbar-brand img {
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* Sticky Tabs Navigation */
    .sticky-tabs {
      position: sticky;
      top: 10px;
      z-index: 1020;
      margin: 0 auto;
      max-width: 96%;
    }

    .nav-pills {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 0.5rem;
      border-radius: 50px;
      box-shadow: var(--shadow-md);
      display: flex;
      justify-content: space-between;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .nav-pills .nav-item {
      flex: 1;
      text-align: center;
    }

    .nav-pills .nav-link {
      color: var(--text-muted);
      font-weight: 500;
      border-radius: 40px;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      padding: 0.75rem 0.5rem;
    }

    .nav-pills .nav-link:hover {
      background-color: rgba(67, 97, 238, 0.05);
      color: var(--primary-color);
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary-color);
      color: #fff;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4);
    }
    
    .nav-pills .nav-link i {
      font-size: 1.1rem;
      margin-right: 4px;
      vertical-align: text-bottom;
    }

    /* Cards */
    .app-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0,0,0,0.03);
      transition: transform 0.2s;
      overflow: hidden;
    }
    
    .section-title {
      font-weight: 600;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      border-bottom: 2px solid #f0f2f5;
      padding-bottom: 0.5rem;
    }

    /* Form Elements */
    .form-control, .form-select {
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      background-color: #fcfcfc;
      transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 4px rgba(72, 149, 239, 0.15);
      background-color: #fff;
    }

    label.form-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
      margin-left: 0.2rem;
    }

    /* Buttons */
    .btn {
      border-radius: 12px;
      padding: 0.6rem 1.2rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
    
    .btn-primary:hover {
      background-color: var(--secondary-color);
      transform: translateY(-1px);
    }
    
    .btn-success {
      background-color: #10b981;
      border: none;
    }

    /* Lists */
    .list-group-item {
      border: none;
      border-bottom: 1px solid #f0f2f5;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: #fff;
      border-radius: 12px !important;
      transition: background 0.2s;
    }
    
    .list-group-item:last-child {
      border-bottom: none;
    }

    .list-group-item:hover {
      background-color: #fafafa;
    }

    .list-fit .list-group-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      border: 1px solid #f0f0f0;
    }

    /* Utilities */
    .form-row-gap { row-gap: 1rem; }
    .small-muted { font-size: 0.85rem; color: #9ca3af; }
    .qr-center { display: flex; align-items: center; justify-content: center; min-height: 240px; background: #f8f9fa; border-radius: 16px; border: 2px dashed #e0e0e0; }
    
    /* Mobile Responsive Fixes */
    @media (max-width: 576px) {
      .nav-pills .nav-link span { display: none; } /* Sadece ikon gÃ¶ster */
      .nav-pills .nav-link i { font-size: 1.4rem; margin: 0; }
      .app-card { padding: 1.5rem !important; }
    }
  </style>

  <script>
    // Firebase yapÄ±landÄ±rma (Korundu)
    const firebaseConfig = {
      apiKey: "AIzaSyD4Ctf-F5BSU_4fHK2WgTQUj_okrzyI7OI",
      authDomain: "birebir-1df98.firebaseapp.com",
      databaseURL: "https://birebir-1df98-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "birebir-1df98",
      storageBucket: "birebir-1df98.firebasestorage.app",
      messagingSenderId: "145327250159",
      appId: "1:145327250159:web:f4d8be51e312f5552f591a",
      measurementId: "G-8CB54NS9QW"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
</head>
<body>

  <header class="main-header">
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
          <img src="https://i.ibb.co/F4cDX7MX/logom.jpg" alt="Logo" height="38" class="rounded-circle bg-white p-1" />
          <span>Ã–zel Ders Takip</span>
        </a>
      </div>
    </nav>
    <div class="container mt-3 mb-4">
      <h6 class="text-white-50 mb-1">HoÅŸ Geldiniz,</h6>
      <h4 class="fw-bold mb-0">Ã–ÄŸrenci YÃ¶netim Paneli</h4>
    </div>
  </header>

  <div class="sticky-tabs">
    <ul class="nav nav-pills" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-ogrenci" data-bs-toggle="pill" data-bs-target="#pnl-ogrenci" type="button" role="tab">
          <i class="bi bi-people-fill"></i> <span>Ã–ÄŸrenciler</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-haftalik" data-bs-toggle="pill" data-bs-target="#pnl-haftalik" type="button" role="tab">
          <i class="bi bi-calendar-check-fill"></i> <span>DeÄŸerlendirme</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-rapor" data-bs-toggle="pill" data-bs-target="#pnl-rapor" type="button" role="tab">
          <i class="bi bi-whatsapp"></i> <span>Raporlar</span>
        </button>
      </li>
    </ul>
  </div>

  <div class="container mt-5">
    <div class="tab-content">

      <div class="tab-pane fade show active" id="pnl-ogrenci" role="tabpanel">
        
        <div class="app-card p-4 mb-4">
          <h2 class="section-title"><i class="bi bi-person-plus"></i> Ã–ÄŸrenci KaydÄ±</h2>
          <div class="row g-3 form-row-gap">
            <div class="col-md-6">
              <label class="form-label">Ã–ÄŸrenci AdÄ±</label>
              <input type="text" id="ogrenciAd" class="form-control" placeholder="Ad Soyad giriniz" />
            </div>
            <div class="col-md-6">
              <label class="form-label">SÄ±nÄ±f Seviyesi</label>
              <select id="ogrenciSinif" class="form-select">
                <option value="">SeÃ§im YapÄ±nÄ±z</option>
                <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
                <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
              </select>
            </div>
            <div class="col-12 d-flex gap-2 pt-2">
              <button class="btn btn-primary flex-grow-1" onclick="ogrenciEkle()"><i class="bi bi-check-lg"></i> Kaydet</button>
              <button class="btn btn-light text-muted" onclick="temizleInputlar()"><i class="bi bi-arrow-counterclockwise"></i></button>
            </div>
          </div>
        </div>

        <div class="app-card p-4 mb-4">
          <h3 class="section-title"><i class="bi bi-list-ul"></i> Ã–ÄŸrenci Listesi</h3>
          <div class="list-group list-fit" id="ogrenciListesi"></div>
        </div>

        <div class="app-card p-4 mb-4">
          <h3 class="section-title"><i class="bi bi-journal-plus"></i> Ã–dev Atama</h3>
          <div class="row g-3 form-row-gap">
            <div class="col-md-6">
              <label class="form-label">Ã–ÄŸrenci SeÃ§imi</label>
              <select id="odevOgrenci" class="form-select">
                <option value="">Listeden seÃ§iniz</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tarih</label>
              <input type="date" id="odevTarih" class="form-control"/>
            </div>
            <div class="col-12">
              <label class="form-label">Ã–dev DetayÄ±</label>
              <textarea id="odevIcerik" class="form-control" rows="3" placeholder="Ã–rn: Sayfa 45-47 arasÄ±ndaki problemler Ã§Ã¶zÃ¼lecek."></textarea>
            </div>
            <div class="col-12 d-flex flex-wrap gap-2 pt-2">
              <button class="btn btn-success flex-grow-1" onclick="odevEkle()"><i class="bi bi-plus-lg"></i> Ã–dev Ata</button>
              <button class="btn btn-light" onclick="odevFormTemizle()"><i class="bi bi-arrow-clockwise"></i></button>
              <button class="btn btn-outline-danger" onclick="tumOdevleriSil()"><i class="bi bi-trash"></i> Temizle</button>
            </div>
          </div>
        </div>

        <div class="app-card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h3 class="h6 text-uppercase fw-bold text-muted mb-0">Ã–dev GeÃ§miÅŸi</h3>
            <div style="width: 200px;">
               <select id="odevFiltreOgrenci" class="form-select form-select-sm">
                  <option value="">TÃ¼m Ã–ÄŸrenciler</option>
               </select>
            </div>
          </div>
          <div id="odevListesi" class="list-group list-fit"></div>
        </div>
      </div>

      <div class="tab-pane fade" id="pnl-haftalik" role="tabpanel">
        <div class="app-card p-4 mb-4">
          <h2 class="section-title"><i class="bi bi-calendar-check"></i> HaftalÄ±k DeÄŸerlendirme</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Ã–ÄŸrenci</label>
              <select id="haftaOgrenci" class="form-select">
                <option value="">SeÃ§iniz</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">GeÃ§en Ã–dev</label>
              <select id="haftaOdev" class="form-select">
                <option value="">SeÃ§iniz</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ã–dev Durumu</label>
              <select id="odevDurumu" class="form-select">
                <option value="">Durum SeÃ§iniz</option>
                <option value="yapti">âœ… YaptÄ±</option>
                <option value="yapmadi">âŒ YapmadÄ±</option>
                <option value="eksik">âš ï¸ Eksik</option>
                <option value="getirmedi">ğŸ“­ Getirmedi</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Bu Hafta Ä°ÅŸlenen Konu</label>
              <textarea id="buHaftaKonu" class="form-control" rows="2" placeholder="Konu baÅŸlÄ±klarÄ±..."></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Gelecek Hafta Ã–devi</label>
              <textarea id="gelecekHaftaOdev" class="form-control" rows="2" placeholder="Verilecek Ã¶dev..."></textarea>
            </div>
            
            <div class="col-md-6">
               <div class="row g-2">
                 <div class="col-12">
                    <label class="form-label">Teslim Tarihi</label>
                    <input type="date" id="gelecekTarih" class="form-control" />
                 </div>
                 <div class="col-12">
                    <label class="form-label">Gelecek Hafta Konusu</label>
                    <textarea id="gelecekHaftaKonu" class="form-control" rows="1"></textarea>
                 </div>
               </div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Motivasyon (1-10)</label>
              <input type="number" id="haftaMotivasyon" class="form-control text-center fw-bold" min="1" max="10" />
            </div>
            <div class="col-md-9">
              <label class="form-label">Genel Ders Yorumu</label>
              <textarea id="haftaMotivasyonAciklama" class="form-control" rows="1" placeholder="Ders iÃ§i performans notu..."></textarea>
            </div>

            <div class="col-12 d-flex flex-wrap gap-2 pt-3">
              <button class="btn btn-primary flex-grow-1" type="button" onclick="haftalikVeriyiEkle()"><i class="bi bi-save"></i> DeÄŸerlendirmeyi Kaydet</button>
              <button class="btn btn-light" onclick="haftalikFormYenile()"><i class="bi bi-arrow-clockwise"></i></button>
              <button class="btn btn-outline-danger ms-auto" type="button" onclick="tumHaftalikKayitlariSil()"><i class="bi bi-trash"></i> Sil</button>
            </div>
          </div>
        </div>

        <div class="app-card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h3 class="h6 text-uppercase fw-bold text-muted mb-0">DeÄŸerlendirme GeÃ§miÅŸi</h3>
            <div style="width: 200px;">
              <select id="haftalikFiltreOgrenci" class="form-select form-select-sm">
                <option value="">TÃ¼mÃ¼</option>
              </select>
            </div>
          </div>
          
          <div id="haftalikKayitListesi" class="list-group list-fit"></div>
          <div id="haftalikOzet" class="mt-3 p-2 bg-light rounded text-center small-muted fw-medium"></div>
          <p id="haftaDurumMesaji" class="text-center small-muted"></p>
        </div>
      </div>

      <div class="tab-pane fade" id="pnl-rapor" role="tabpanel">
        <div class="app-card p-4 mb-4">
          <h2 class="section-title"><i class="bi bi-whatsapp"></i> WhatsApp Rapor OluÅŸturucu</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Rapor TÃ¼rÃ¼</label>
              <select id="raporTipi" class="form-select" onchange="raporTipiDegisti()">
                <option value="haftalik">ğŸ“… HaftalÄ±k Rapor</option>
                <option value="aylik">ğŸ“† AylÄ±k Rapor</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Ã–ÄŸrenci SeÃ§</label>
              <select id="raporOgrenciSec" class="form-select"></select>
            </div>

            <div class="col-12">
              <label class="form-label">Otomatik OluÅŸturulan Mesaj</label>
              <textarea id="raporMesaj" rows="10" class="form-control font-monospace fs-6 bg-light" style="border:1px dashed #ccc;"></textarea>
            </div>

            <div class="col-12 d-flex flex-wrap gap-2 pt-2">
              <button class="btn btn-success py-2 flex-grow-1" onclick="whatsappMesajGonder()"><i class="bi bi-whatsapp"></i> WhatsApp'ta AÃ§</button>
              <button class="btn btn-dark py-2" onclick="qrKodModalAc()"><i class="bi bi-qr-code"></i> QR Kod</button>
              <button class="btn btn-outline-secondary" onclick="raporFormYenile()"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          
          <div id="qrCanvasContainer" class="d-none"></div> </div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="ogrenciGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold">âœï¸ Ã–ÄŸrenci DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ad Soyad</label>
            <input type="text" id="guncelleAd" class="form-control"/>
          </div>
          <div class="mb-3">
            <label class="form-label">SÄ±nÄ±f</label>
            <select id="guncelleSinif" class="form-select">
              <option value="">SeÃ§iniz</option>
              <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
              <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Ä°ptal</button>
          <button class="btn btn-primary" onclick="ogrenciGuncelleKaydet()">DeÄŸiÅŸiklikleri Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="odevGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold">âœï¸ Ã–dev DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Tarih</label>
            <input type="date" id="guncelleOdevTarih" class="form-control"/>
          </div>
          <div class="mb-3">
            <label class="form-label">Ä°Ã§erik</label>
            <textarea id="guncelleOdevIcerik" rows="4" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Ä°ptal</button>
          <button class="btn btn-primary" onclick="odevGuncelleKaydet()">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="haftalikGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold">âœï¸ HaftalÄ±k KayÄ±t DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label small text-muted">Ã–ÄŸrenci</label>
          <input type="text" id="guncelleHaftaOgrenci" class="form-control mb-3" disabled readonly>
          
          <label class="form-label small text-muted">Tarih</label>
          <input type="date" id="guncelleHaftaTarih" class="form-control mb-3">

          <label class="form-label small text-muted">Ä°ÅŸlenen Konu</label>
          <input type="text" id="guncelleHaftaKonu" class="form-control mb-3">
          
          <label class="form-label small text-muted">Ã–dev</label>
          <input type="text" id="guncelleHaftaOdev" class="form-control mb-3">
          
          <label class="form-label small text-muted">Durum (yapti, yapmadi, eksik...)</label>
          <input type="text" id="guncelleHaftaDurum" class="form-control mb-3">
          
          <hr>
          <label class="form-label small text-muted">Gelecek Konu</label>
          <input type="text" id="guncelleGelecekKonu" class="form-control mb-3">
          
          <label class="form-label small text-muted">Gelecek Ã–dev</label>
          <input type="text" id="guncelleGelecekOdev" class="form-control mb-3">

          <div class="row">
             <div class="col-4">
               <label class="form-label small text-muted">Motivasyon</label>
               <input type="number" id="guncelleHaftaMotivasyon" class="form-control" min="1" max="10">
             </div>
             <div class="col-8">
               <label class="form-label small text-muted">AÃ§Ä±klama</label>
               <textarea id="guncelleHaftaMotivasyonAciklama" class="form-control" rows="1"></textarea>
             </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Ä°ptal</button>
          <button class="btn btn-primary" onclick="haftalikKaydiGuncelleKaydet()">GÃ¼ncelle</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">ğŸ“± WhatsApp QR</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center p-4">
          <div id="qrModalCanvas" class="d-flex justify-content-center mb-3"></div>
          <p class="text-muted small">MesajÄ± gÃ¶ndermek iÃ§in kameranÄ±zÄ± okutun.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ YardÄ±mcÄ±lar ************/
    let guncellenecekId = null;            // Ã–ÄŸrenci gÃ¼ncelle
    let guncellenecekOdevKey = null;       // Ã–dev gÃ¼ncelle
    let guncellenecekHaftaKey = null;      // HaftalÄ±k kayÄ±t gÃ¼ncelle

    const bsModal = (id) => bootstrap.Modal.getOrCreateInstance(document.getElementById(id));

    const durumIcon = (durum) => {
      switch ((durum || '').toLowerCase()) {
        case 'yapti': return '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">âœ… YaptÄ±</span>';
        case 'yapmadi': return '<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-2 py-1">âŒ YapmadÄ±</span>';
        case 'eksik': return '<span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 px-2 py-1">âš ï¸ Eksik</span>';
        case 'getirmedi': return '<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 px-2 py-1">ğŸ“­ Getirmedi</span>';
        default: return '<span class="badge bg-light text-muted border px-2 py-1">â– Bilgi Yok</span>';
      }
    };

    function formatTurkishDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    let odevCurrentPage = 1;
    let haftalikCurrentPage = 1;

    // --- Ortak yenile yardÄ±mcÄ±larÄ± ---
    function refreshStudents() {
      ogrenciListele();
      doldurOgrenciSecimi();       
      doldurHaftaOgrenciListesi(); 
      raporOgrenciSecDoldur();     
      doldurOdevFiltre();
      doldurHaftalikFiltre();
    }
    function refreshAssignments() {
      odevListele();
    }
    function refreshWeekly() {
      haftalikKayitlariListele();
    }
    function refreshAll() {
      refreshStudents();
      refreshAssignments();
      refreshWeekly();
      const sel = document.getElementById('raporOgrenciSec');
      if (sel && sel.value) { raporMesajiOlustur(); }
    }

    // Ã–ÄŸrenci - dizi olarak sakla / getir
    function getOgrenciler(cb){
      database.ref("ogrenciler").once("value").then(s => {
        const val = s.val();
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : (Object.values(val || {}));
        cb(arr || []);
      }).catch(_ => cb([]));
    }
    function setOgrenciler(arr){
      return database.ref("ogrenciler").set(arr || []);
    }

    /************ Ã–ÄRENCÄ° ************/
    function temizleInputlar(){
      document.getElementById('ogrenciAd').value = '';
      document.getElementById('ogrenciSinif').value = '';
    }

    function ogrenciEkle(){
      const ad = document.getElementById('ogrenciAd').value.trim();
      const sinif = document.getElementById('ogrenciSinif').value;
      if(!ad || !sinif){ alert("LÃ¼tfen Ã¶ÄŸrenci adÄ± ve sÄ±nÄ±f seÃ§in."); return; }

      getOgrenciler(ogrenciler=>{
        const id = Date.now();
        const yeni = { id, ad, sinif };
        const guncel = [...ogrenciler, yeni];
        setOgrenciler(guncel).then(()=>{
          alert("âœ… Ã–ÄŸrenci eklendi.");
          refreshStudents();
          temizleInputlar();
        }).catch(()=> alert("âŒ Ã–ÄŸrenci eklenemedi."));
      });
    }

    function ogrenciSil(id){
      if(!confirm("Bu Ã¶ÄŸrenciyi silmek istediÄŸinize emin misiniz?")) return;
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.filter(o=>o.id !== id);
        setOgrenciler(guncel).then(()=>{
          refreshStudents(); 
        });
      });
    }

    function ogrenciGuncelleAc(id){
      getOgrenciler(ogrenciler=>{
        const o = ogrenciler.find(x=>x.id===id);
        if(!o) return;
        guncellenecekId = id;
        document.getElementById('guncelleAd').value = o.ad || '';
        document.getElementById('guncelleSinif').value = o.sinif || '';
        bsModal('ogrenciGuncelleModal').show();
      });
    }

    function ogrenciGuncelleKaydet(){
      const ad = document.getElementById('guncelleAd').value.trim();
      const sinif = document.getElementById('guncelleSinif').value;
      if(!guncellenecekId){ alert("GÃ¼ncellenecek Ã¶ÄŸrenci yok."); return; }
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.map(o=> o.id===guncellenecekId ? ({...o, ad, sinif}) : o);
        setOgrenciler(guncel).then(()=>{
          bsModal('ogrenciGuncelleModal').hide();
          refreshStudents();
          alert("âœ… Ã–ÄŸrenci gÃ¼ncellendi.");
        });
      });
    }

    function ogrenciListele(){
      const liste = document.getElementById('ogrenciListesi');
      liste.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border text-primary spinner-border-sm"></div> YÃ¼kleniyor...</div>';
      getOgrenciler(ogrenciler=>{
        liste.innerHTML = '';
        if(!ogrenciler.length){
          liste.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-person-x fs-1 d-block mb-2"></i>KayÄ±tlÄ± Ã¶ÄŸrenci yok.</div>';
          return;
        }
        ogrenciler.forEach(o=>{
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.innerHTML = `
            <div class="d-flex align-items-center gap-3">
              <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
                <i class="bi bi-person-fill fs-5"></i>
              </div>
              <div>
                <div class="fw-semibold text-dark">${o.ad}</div>
                <div class="small text-muted">${o.sinif}</div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-light text-primary border" onclick="ogrenciGuncelleAc(${o.id})"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-light text-danger border" onclick="ogrenciSil(${o.id})"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
      });
    }

    /************ Ã–DEVLER ************/
    function doldurOgrenciSecimi(){
      const sel = document.getElementById('odevOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; 
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
    }

    function odevListele(){
      const liste = document.getElementById('odevListesi');
      liste.innerHTML = '';
      let paginationContainer = document.getElementById('odevPagination');
      if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'odevPagination';
        paginationContainer.className = 'mt-3 d-flex justify-content-center';
        liste.parentNode.appendChild(paginationContainer);
      }
      database.ref("odevler").once("value").then(snap => {
        const val = snap.val() || {};
        const allEntries = Object.entries(val);
        const filtreSel = document.getElementById('odevFiltreOgrenci');
        const filtreDeger = filtreSel ? filtreSel.value : '';
        
        let filtered = allEntries.filter(([_, odev]) => {
          return !filtreDeger || odev.ogrenci === filtreDeger;
        });

        if (filtered.length === 0) {
          liste.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-journal-x fs-1 d-block mb-2"></i>' + (allEntries.length === 0 ? 'KayÄ±tlÄ± Ã¶dev yok.' : 'Bu kriterde Ã¶dev bulunamadÄ±.') + '</div>';
          paginationContainer.innerHTML = '';
          return;
        }

        filtered.sort((a, b) => {
          const da = new Date(a[1].tarih);
          const db = new Date(b[1].tarih);
          return db - da; 
        });

        const itemsPerPage = 5;
        const totalPages = Math.ceil(filtered.length / itemsPerPage);
        if (odevCurrentPage > totalPages) odevCurrentPage = totalPages;
        if (odevCurrentPage < 1) odevCurrentPage = 1;

        const start = (odevCurrentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filtered.slice(start, end);

        pageItems.forEach(([key, odev]) => {
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.innerHTML = `
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between mb-1">
                 <span class="fw-bold text-primary">${odev.ogrenci}</span>
                 <span class="badge bg-light text-dark border">${formatTurkishDate(odev.tarih)}</span>
              </div>
              <div class="text-secondary small mb-1">${odev.icerik}</div>
            </div>
            <div class="d-flex gap-2 align-items-center ms-2">
              <button class="btn btn-sm btn-light text-primary" onclick="odevGuncelleAc('${key}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-light text-danger" onclick="tekOdevSil('${key}')"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });

        renderPagination(paginationContainer, totalPages, odevCurrentPage, (newPage) => {
          odevCurrentPage = newPage;
          odevListele();
        });
      });
    }

    function renderPagination(container, totalPages, currentPage, onPageChange) {
      container.innerHTML = '';
      if (totalPages <= 1) return;

      const nav = document.createElement('nav');
      const ul = document.createElement('ul');
      ul.className = 'pagination pagination-sm mb-0';

      // Ã–nceki
      const liPrev = document.createElement('li');
      liPrev.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      liPrev.innerHTML = `<button class="page-link" type="button">&laquo;</button>`;
      liPrev.onclick = () => { if(currentPage > 1) onPageChange(currentPage - 1); };
      ul.appendChild(liPrev);

      // Sayfa numaralarÄ±
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<button class="page-link" type="button">${i}</button>`;
        li.onclick = () => onPageChange(i);
        ul.appendChild(li);
      }

      // Sonraki
      const liNext = document.createElement('li');
      liNext.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      liNext.innerHTML = `<button class="page-link" type="button">&raquo;</button>`;
      liNext.onclick = () => { if(currentPage < totalPages) onPageChange(currentPage + 1); };
      ul.appendChild(liNext);

      nav.appendChild(ul);
      container.appendChild(nav);
    }

    function odevEkle(){
      const ogrenci = document.getElementById('odevOgrenci').value;
      const tarih = document.getElementById('odevTarih').value;
      const icerik = document.getElementById('odevIcerik').value.trim();

      if(!ogrenci || !tarih || !icerik){ alert("TÃ¼m alanlarÄ± doldurun."); return; }

      const yeniOdev = { ogrenci, tarih, icerik };
      database.ref("odevler").push(yeniOdev).then(()=>{
        alert("âœ… Ã–dev eklendi.");
        refreshAssignments();
        odevFormTemizle();
      }).catch(()=> alert("âŒ Hata oluÅŸtu."));
    }

    function odevFormTemizle(){
      document.getElementById('odevOgrenci').value = '';
      document.getElementById('odevTarih').value = '';
      document.getElementById('odevIcerik').value = '';
    }

    function tekOdevSil(key){
      if(!confirm("Bu Ã¶devi silmek istiyor musunuz?")) return;
      database.ref("odevler/"+key).remove().then(()=> refreshAssignments());
    }
    
    function tumOdevleriSil(){
      if(!confirm("âš ï¸ DÄ°KKAT: TÃ¼m Ã¶dev kayÄ±tlarÄ± silinecek!")) return;
      database.ref("odevler").remove().then(()=> refreshAssignments());
    }

    function doldurOdevFiltre(){
      const sel = document.getElementById('odevFiltreOgrenci');
      const currentVal = sel.value;
      sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; 
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        sel.value = currentVal;
      });
    }

    function odevGuncelleAc(key){
      database.ref("odevler/"+key).once("value").then(s=>{
        const val = s.val();
        if(!val) return;
        guncellenecekOdevKey = key;
        document.getElementById('guncelleOdevTarih').value = val.tarih || '';
        document.getElementById('guncelleOdevIcerik').value = val.icerik || '';
        bsModal('odevGuncelleModal').show();
      });
    }

    function odevGuncelleKaydet(){
      if(!guncellenecekOdevKey) return;
      const tarih = document.getElementById('guncelleOdevTarih').value;
      const icerik = document.getElementById('guncelleOdevIcerik').value;
      database.ref("odevler/"+guncellenecekOdevKey).update({ tarih, icerik }).then(()=>{
        bsModal('odevGuncelleModal').hide();
        refreshAssignments();
        alert("âœ… Ã–dev gÃ¼ncellendi.");
      });
    }

    /************ HAFTALIK DEÄERLENDÄ°RME ************/
    function doldurHaftaOgrenciListesi(){
      const sel = document.getElementById('haftaOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§in</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad;
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
      // Ã–ÄŸrenci seÃ§ince son Ã¶devi bul
      sel.onchange = () => {
        const ogr = sel.value;
        doldurOgrenciSonOdev(ogr);
      };
    }

    function doldurOgrenciSonOdev(ogrAd){
      const odevSel = document.getElementById('haftaOdev');
      odevSel.innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
      if(!ogrAd) return;

      database.ref("odevler").once("value").then(s=>{
        const val = s.val() || {};
        const list = Object.values(val).filter(x => x.ogrenci === ogrAd);
        // Tarihe gÃ¶re sÄ±rala (en yeni Ã¼stte)
        list.sort((a,b)=> new Date(b.tarih) - new Date(a.tarih));
        // Son 5 Ã¶devi getir
        list.slice(0,5).forEach(o=>{
          const opt = document.createElement('option');
          // value olarak iÃ§eriÄŸi koyuyoruz (basitlik adÄ±na)
          opt.value = o.icerik; 
          opt.textContent = `${formatTurkishDate(o.tarih)} - ${o.icerik.substring(0,30)}...`;
          odevSel.appendChild(opt);
        });
      });
    }

    function haftalikVeriyiEkle(){
      const ogrenci = document.getElementById('haftaOgrenci').value;
      const odev = document.getElementById('haftaOdev').value;
      const durum = document.getElementById('odevDurumu').value;
      const konu = document.getElementById('buHaftaKonu').value;
      const gelOdev = document.getElementById('gelecekHaftaOdev').value;
      const gelKonu = document.getElementById('gelecekHaftaKonu').value;
      const gelTarih = document.getElementById('gelecekTarih').value;
      const motivasyon = document.getElementById('haftaMotivasyon').value;
      const motivasyonAciklama = document.getElementById('haftaMotivasyonAciklama').value;

      if(!ogrenci){ alert("LÃ¼tfen Ã¶ÄŸrenci seÃ§in."); return; }

      const id = Date.now().toString(); 
      const veri = {
        id, ogrenci, odev, durum, konu, gelOdev, gelKonu, gelTarih,
        tarih: new Date().toISOString().split('T')[0], // KayÄ±t tarihi (bugÃ¼n)
        motivasyon, motivasyonAciklama
      };

      database.ref("haftalikDegerlendirme").push(veri).then(()=>{
        alert("âœ… HaftalÄ±k kayÄ±t eklendi.");
        refreshWeekly();
        haftalikFormYenile();
      });
    }

    function haftalikFormYenile(){
      document.getElementById('haftaOgrenci').value = '';
      document.getElementById('haftaOdev').innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
      document.getElementById('odevDurumu').value = '';
      document.getElementById('buHaftaKonu').value = '';
      document.getElementById('gelecekHaftaOdev').value = '';
      document.getElementById('gelecekHaftaKonu').value = '';
      document.getElementById('gelecekTarih').value = '';
      document.getElementById('haftaMotivasyon').value = '';
      document.getElementById('haftaMotivasyonAciklama').value = '';
    }

    function doldurHaftalikFiltre(){
      const sel = document.getElementById('haftalikFiltreOgrenci');
      const currentVal = sel.value;
      sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; 
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        sel.value = currentVal;
      });
    }

    function haftalikKayitlariListele(){
      const liste = document.getElementById('haftalikKayitListesi');
      const ozetDiv = document.getElementById('haftalikOzet');
      const durumMsg = document.getElementById('haftaDurumMesaji');
      
      liste.innerHTML = '';
      ozetDiv.innerHTML = '';
      durumMsg.textContent = 'YÃ¼kleniyor...';

      let paginationContainer = document.getElementById('haftalikPagination');
      if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'haftalikPagination';
        paginationContainer.className = 'mt-3 d-flex justify-content-center';
        liste.parentNode.appendChild(paginationContainer);
      }

      database.ref("haftalikDegerlendirme").once("value").then(snap => {
        durumMsg.textContent = '';
        const val = snap.val() || {};
        const entries = Object.entries(val);
        const filtreSel = document.getElementById('haftalikFiltreOgrenci');
        const filtreOgrenci = filtreSel ? filtreSel.value : '';

        let filtered = entries.filter(([_, item]) => {
          return !filtreOgrenci || item.ogrenci === filtreOgrenci;
        });

        // Toplam ders sayÄ±sÄ± Ã¶zeti
        if (filtreOgrenci && filtered.length > 0) {
           ozetDiv.innerHTML = `<span>${filtreOgrenci}</span> iÃ§in toplam <strong>${filtered.length}</strong> ders kaydÄ± bulundu.`;
        } else if (!filtreOgrenci && filtered.length > 0) {
           ozetDiv.innerHTML = `Toplam <strong>${filtered.length}</strong> deÄŸerlendirme kaydÄ± mevcut.`;
        } else {
           ozetDiv.innerHTML = '';
        }

        if(filtered.length === 0){
          liste.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-clipboard-x fs-1 d-block mb-2"></i>KayÄ±t bulunamadÄ±.</div>';
          paginationContainer.innerHTML = '';
          return;
        }

        filtered.sort((a,b)=> new Date(b[1].tarih) - new Date(a[1].tarih));

        // Sayfalama
        const itemsPerPage = 5;
        const totalPages = Math.ceil(filtered.length / itemsPerPage);
        if (haftalikCurrentPage > totalPages) haftalikCurrentPage = totalPages;
        if (haftalikCurrentPage < 1) haftalikCurrentPage = 1;

        const start = (haftalikCurrentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filtered.slice(start, end);

        pageItems.forEach(([key, item]) => {
          const div = document.createElement('div');
          div.className = 'list-group-item';
          
          // Kart iÃ§eriÄŸi
          let html = `
            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1 text-primary fw-bold">${item.ogrenci} <small class="text-muted fw-normal ms-2">${formatTurkishDate(item.tarih)}</small></h6>
                <div class="mb-1">${durumIcon(item.durum)}</div>
              </div>
              <div class="d-flex gap-2">
                 <button class="btn btn-sm btn-light text-primary border" onclick="haftalikGuncelleAc('${key}')"><i class="bi bi-pencil"></i></button>
                 <button class="btn btn-sm btn-light text-danger border" onclick="tekHaftalikSil('${key}')"><i class="bi bi-trash"></i></button>
              </div>
            </div>
            <div class="row g-2 small">
              <div class="col-md-6"><strong class="text-dark">Ä°ÅŸlenen:</strong> <span class="text-muted">${item.konu || '-'}</span></div>
              <div class="col-md-6"><strong class="text-dark">Ã–dev:</strong> <span class="text-muted">${item.odev || '-'}</span></div>
              <div class="col-md-6"><strong class="text-dark">Gel. Konu:</strong> <span class="text-muted">${item.gelKonu || '-'}</span></div>
              <div class="col-md-6"><strong class="text-dark">Gel. Ã–dev:</strong> <span class="text-muted">${item.gelOdev || '-'}</span></div>
          `;
          if(item.motivasyon || item.motivasyonAciklama){
             html += `<div class="col-12 mt-2 pt-2 border-top"><strong class="text-dark">Not:</strong> <span class="badge bg-warning text-dark me-1">${item.motivasyon || '-'}</span> <span class="text-muted fst-italic">${item.motivasyonAciklama || ''}</span></div>`;
          }
          html += `</div>`;
          
          div.innerHTML = html;
          liste.appendChild(div);
        });

        renderPagination(paginationContainer, totalPages, haftalikCurrentPage, (newPage) => {
          haftalikCurrentPage = newPage;
          haftalikKayitlariListele();
        });
      });
    }

    function tekHaftalikSil(key){
      if(!confirm("KayÄ±t silinsin mi?")) return;
      database.ref("haftalikDegerlendirme/"+key).remove().then(()=> refreshWeekly());
    }

    function tumHaftalikKayitlariSil(){
      if(!confirm("âš ï¸ TÃœM haftalÄ±k kayÄ±tlar silinecek!")) return;
      database.ref("haftalikDegerlendirme").remove().then(()=> refreshWeekly());
    }

    function haftalikGuncelleAc(key){
      database.ref("haftalikDegerlendirme/"+key).once("value").then(s=>{
        const val = s.val();
        if(!val) return;
        guncellenecekHaftaKey = key;
        // Modal alanlarÄ±nÄ± doldur
        document.getElementById('guncelleHaftaOgrenci').value = val.ogrenci || '';
        document.getElementById('guncelleHaftaKonu').value = val.konu || '';
        document.getElementById('guncelleHaftaOdev').value = val.odev || '';
        document.getElementById('guncelleHaftaDurum').value = val.durum || '';
        document.getElementById('guncelleHaftaTarih').value = val.tarih || ''; // YYYY-MM-DD
        document.getElementById('guncelleGelecekKonu').value = val.gelKonu || '';
        document.getElementById('guncelleGelecekOdev').value = val.gelOdev || '';
        document.getElementById('guncelleHaftaMotivasyon').value = val.motivasyon || '';
        document.getElementById('guncelleHaftaMotivasyonAciklama').value = val.motivasyonAciklama || '';
        
        bsModal('haftalikGuncelleModal').show();
      });
    }

    function haftalikKaydiGuncelleKaydet(){
      if(!guncellenecekHaftaKey) return;
      const updates = {};
      updates.konu = document.getElementById('guncelleHaftaKonu').value;
      updates.odev = document.getElementById('guncelleHaftaOdev').value;
      updates.durum = document.getElementById('guncelleHaftaDurum').value;
      updates.tarih = document.getElementById('guncelleHaftaTarih').value;
      updates.gelKonu = document.getElementById('guncelleGelecekKonu').value;
      updates.gelOdev = document.getElementById('guncelleGelecekOdev').value;
      updates.motivasyon = document.getElementById('guncelleHaftaMotivasyon').value;
      updates.motivasyonAciklama = document.getElementById('guncelleHaftaMotivasyonAciklama').value;

      database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update(updates).then(()=>{
        bsModal('haftalikGuncelleModal').hide();
        refreshWeekly();
        alert("âœ… KayÄ±t gÃ¼ncellendi.");
      });
    }

    /************ RAPOR (WHATSAPP) ************/
    function raporOgrenciSecDoldur(){
      const sel = document.getElementById('raporOgrenciSec');
      sel.innerHTML = '';
      getOgrenciler(ogrenciler=>{
        if(!ogrenciler.length){
           const opt = document.createElement('option');
           opt.text = "Ã–ÄŸrenci Yok";
           sel.add(opt);
           return;
        }
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad;
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        // Ä°lk aÃ§Ä±lÄ±ÅŸta tetikle
        if(ogrenciler.length > 0) {
            sel.selectedIndex = 0;
            raporMesajiOlustur();
        }
      });
      sel.onchange = raporMesajiOlustur;
    }

    function raporTipiDegisti(){
      raporMesajiOlustur();
    }
    
    // Mesaj OluÅŸturucu: HaftalÄ±k veya AylÄ±k
    function raporMesajiOlustur(){
      const tip = document.getElementById('raporTipi').value; // haftalik, aylik
      const ogrenci = document.getElementById('raporOgrenciSec').value;
      const txt = document.getElementById('raporMesaj');

      if(!ogrenci) { txt.value = ""; return; }

      database.ref("haftalikDegerlendirme").once("value").then(snap => {
        const val = snap.val() || {};
        const entries = Object.values(val).filter(x => x.ogrenci === ogrenci);

        // Tarihe gÃ¶re sÄ±rala (eskiden yeniye)
        entries.sort((a,b)=> new Date(a.tarih) - new Date(b.tarih));

        if(entries.length === 0){
          txt.value = `SayÄ±n Velimiz,\n\n${ogrenci} Ã¶ÄŸrencimiz iÃ§in henÃ¼z sisteme girilmiÅŸ bir ders kaydÄ± bulunmamaktadÄ±r.`;
          return;
        }

        // Filtreleme (Bu hafta veya Bu ay)
        let raporVerisi = [];
        const simdi = new Date();
        
        if(tip === 'haftalik'){
          // Son 7 gÃ¼n (kabaca son girilen ders de olabilir, ama biz son kaydÄ± alalÄ±m veya son 1 haftayÄ±)
          // Basitlik adÄ±na: Son girilen kaydÄ± "Bu haftanÄ±n raporu" gibi sunalÄ±m.
          // Veya son 7 gÃ¼ne ait tÃ¼m kayÄ±tlar.
          const birHaftaOnce = new Date();
          birHaftaOnce.setDate(simdi.getDate() - 7);
          
          raporVerisi = entries.filter(e => new Date(e.tarih) >= birHaftaOnce);
          // EÄŸer son hafta kayÄ±t yoksa, en son kaydÄ± gÃ¶sterelim
          if(raporVerisi.length === 0 && entries.length > 0){
             raporVerisi = [entries[entries.length - 1]];
          }

        } else {
          // AylÄ±k: Mevcut ayÄ±n kayÄ±tlarÄ±
          const buAy = simdi.getMonth();
          const buYil = simdi.getFullYear();
          raporVerisi = entries.filter(e => {
            const d = new Date(e.tarih);
            return d.getMonth() === buAy && d.getFullYear() === buYil;
          });
        }

        // Metin HazÄ±rlama
        if(raporVerisi.length === 0){
           txt.value = `SayÄ±n Velimiz,\n\n${ogrenci} iÃ§in seÃ§ilen dÃ¶nemde kayÄ±t bulunamadÄ±.`;
           return;
        }

        let mesaj = "";
        
        if(tip === 'haftalik'){
           // Tekil veya az sayÄ±da kayÄ±t iÃ§in detaylÄ± format
           const sonKayit = raporVerisi[raporVerisi.length - 1]; // En sonuncusu ana odak
           
           // Emoji seÃ§imi
           let durumEmoji = "ğŸ‘";
           if(sonKayit.durum === 'yapmadi') durumEmoji = "ğŸ‘";
           if(sonKayit.durum === 'eksik') durumEmoji = "âš ï¸";

           mesaj += `SayÄ±n Velimiz, iyi gÃ¼nler.\n`;
           mesaj += `Ã–ÄŸrencimiz *${ogrenci}* ile bu hafta yapÄ±lan dersimizin deÄŸerlendirmesi ÅŸÃ¶yledir:\n\n`;
           
           mesaj += `ğŸ“… *Tarih:* ${formatTurkishDate(sonKayit.tarih)}\n`;
           mesaj += `ğŸ“š *Ä°ÅŸlenen Konu:* _${sonKayit.konu || 'Belirtilmedi'}_\n`;
           mesaj += `ğŸ“ *Verilen Ã–dev:* ${sonKayit.odev || 'Yok'}\n`;
           mesaj += `ğŸ“Š *Ã–dev Durumu:* ${durumIconText(sonKayit.durum)} ${durumEmoji}\n`;
           
           if(sonKayit.gelKonu) mesaj += `ğŸ”œ *Gelecek Konu:* ${sonKayit.gelKonu}\n`;
           if(sonKayit.gelOdev) mesaj += `ğŸ“Œ *Haftaya Ã–dev:* ${sonKayit.gelOdev}\n`;
           if(sonKayit.gelTarih) mesaj += `â° *Teslim:* ${formatTurkishDate(sonKayit.gelTarih)}\n`;

           // Motivasyon alanÄ±
           if(sonKayit.motivasyon){
              mesaj += `\nğŸŒŸ *Ders PerformansÄ±:* ${sonKayit.motivasyon}/10\n`;
           }
           if(sonKayit.motivasyonAciklama){
              mesaj += `ğŸ’¬ *Notumuz:* ${sonKayit.motivasyonAciklama}\n`;
           }
           
           mesaj += `\nÄ°lginiz iÃ§in teÅŸekkÃ¼r ederiz.`;

        } else {
           // AylÄ±k Ã¶zet (Liste formatÄ±)
           mesaj += `SayÄ±n Velimiz,\n`;
           mesaj += `Ã–ÄŸrencimiz *${ogrenci}* iÃ§in bu ayÄ±n ders Ã¶zeti aÅŸaÄŸÄ±dadÄ±r:\n\n`;
           
           raporVerisi.forEach(k => {
              mesaj += `ğŸ”¹ *${formatTurkishDate(k.tarih)}* - ${k.konu || 'Konu Yok'}\n`;
              mesaj += `   Durum: ${durumIconText(k.durum)}\n`;
              if(k.motivasyon) mesaj += `   Puan: ${k.motivasyon}/10\n`;
              mesaj += `------------------\n`;
           });
           
           mesaj += `\nToplam ${raporVerisi.length} ders yapÄ±lmÄ±ÅŸtÄ±r.\nBaÅŸarÄ±lar dileriz.`;
        }

        txt.value = mesaj;
        // QR kod otomatik Ã¼retilsin
        qrKodUret(mesaj);
      });
    }

    function durumIconText(durum){
       switch((durum||'').toLowerCase()){
         case 'yapti': return 'YaptÄ±';
         case 'yapmadi': return 'Yapmadi';
         case 'eksik': return 'Eksik';
         case 'getirmedi': return 'Getirmedi';
         default: return '-';
       }
    }

    function whatsappMesajGonder(){
      const msg = document.getElementById('raporMesaj').value;
      if(!msg) return;
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    }

    // QR Kod
    let qrCodeObj = null;
    function qrKodUret(metin){
      const container = document.getElementById('qrModalCanvas'); // Modal iÃ§indeki alan
      container.innerHTML = "";
      if(!metin) return;
      qrCodeObj = new QRCode(container, {
        text: metin,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
    }

    function qrKodModalAc(){
       const msg = document.getElementById('raporMesaj').value;
       if(!msg){ alert("Mesaj boÅŸ, rapor oluÅŸturun."); return; }
       qrKodUret(msg); // Emin olmak iÃ§in tekrar Ã¼ret
       bsModal('qrModal').show();
    }
    
    function raporFormYenile(){
       document.getElementById('raporTipi').value = 'haftalik';
       raporOgrenciSecDoldur();
    }

    // BaÅŸlangÄ±Ã§ olaylarÄ±
    window.addEventListener('load', ()=>{
      refreshAll(); 
      // Otomatik yenilemeler
      // database.ref("ogrenciler").on("value", ()=> refreshStudents());
      
      // Filtre olaylarÄ±nÄ± baÄŸla
      const odevFiltre = document.getElementById('odevFiltreOgrenci');
      if(odevFiltre){
         odevFiltre.addEventListener('change', ()=>{
            odevCurrentPage = 1;
            odevListele();
         });
      }
      const haftalikFiltre = document.getElementById('haftalikFiltreOgrenci');
      if(haftalikFiltre){
         haftalikFiltre.addEventListener('change', ()=>{
            haftalikCurrentPage = 1;
            haftalikKayitlariListele();
         });
      }
    });
  </script>
</body>
</html>
