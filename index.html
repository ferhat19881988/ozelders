<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ã–zel Ders Takip Sistemi</title>

  <!-- Bootstrap 5.3 (CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Icons (opsiyonel) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- QR ve Firebase -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #4f46e5; /* Ä°ndigo */
      --primary-hover: #4338ca;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-radius: 1rem;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      background: var(--bg-color);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    /* Navbar */
    .navbar {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229, 231, 235, 0.5);
    }
    .navbar-brand {
      font-weight: 700;
      color: var(--primary-color) !important;
      letter-spacing: -0.025em;
    }
    .navbar-brand img {
      height: 36px;
      width: auto;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }

    /* Sticky Tabs */
    .sticky-tabs {
      position: sticky;
      top: 0;
      z-index: 1020;
      background: rgba(243, 244, 246, 0.95);
      backdrop-filter: blur(8px);
      padding-top: 1rem;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .nav-pills .nav-link {
      color: var(--text-muted);
      font-weight: 500;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
    }
    .nav-pills .nav-link:hover {
      background-color: #e5e7eb;
      color: var(--text-main);
    }
    .nav-pills .nav-link.active {
      background-color: var(--primary-color);
      color: #fff;
      box-shadow: var(--shadow-sm);
    }
    .nav-pills .nav-link i { margin-right: 0.5rem; }

    /* Kartlar ve Formlar */
    .app-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255,255,255,0.5);
      transition: transform 0.2s;
    }
    
    h2.h4 { font-weight: 600; color: #111827; letter-spacing: -0.01em; }
    h3.h5, h3.h6 { font-weight: 600; color: #374151; }

    .form-control, .form-select {
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }
    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    /* Listeler */
    .list-group-item {
      border: none;
      background: #f9fafb;
      margin-bottom: 0.5rem;
      border-radius: 0.75rem !important;
      padding: 1rem;
      transition: background 0.2s;
    }
    .list-group-item:hover { background: #f3f4f6; }
    .list-fit .list-group-item {
      display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;
    }

    .form-row-gap { row-gap: 1rem; }
    .qr-center {
      background: #f9fafb;
      border-radius: 1rem;
      padding: 2rem;
      border: 2px dashed #e5e7eb;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 240px;
    }
    textarea { resize: vertical; }
  </style>

  <script>
    // Firebase yapÄ±landÄ±rma
    const firebaseConfig = {
      apiKey: "AIzaSyD4Ctf-F5BSU_4fHK2WgTQUj_okrzyI7OI",
      authDomain: "birebir-1df98.firebaseapp.com",
      databaseURL: "https://birebir-1df98-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "birebir-1df98",
      storageBucket: "birebir-1df98.firebasestorage.app",
      messagingSenderId: "145327250159",
      appId: "1:145327250159:web:f4d8be51e312f5552f591a",
      measurementId: "G-8CB54NS9QW"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <img src="https://i.ibb.co/F4cDX7MX/logom.jpg" alt="Logo" />
      <span>Ã–zel Ders Takip</span>
    </a>
  </div>
</nav>

<div class="sticky-tabs">
  <div class="container">
    <ul class="nav nav-pills justify-content-center justify-content-md-start" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-ogrenci" data-bs-toggle="pill" data-bs-target="#pnl-ogrenci" type="button" role="tab">
          <i class="bi bi-person-plus-fill"></i> Ã–ÄŸrenci Ä°ÅŸlemleri
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-haftalik" data-bs-toggle="pill" data-bs-target="#pnl-haftalik" type="button" role="tab">
          <i class="bi bi-calendar-check-fill"></i> HaftalÄ±k Takip
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-rapor" data-bs-toggle="pill" data-bs-target="#pnl-rapor" type="button" role="tab">
          <i class="bi bi-whatsapp"></i> Rapor OluÅŸtur
        </button>
      </li>
    </ul>
  </div>
</div>

<div class="container my-4">
  <div class="tab-content">

    <div class="tab-pane fade show active" id="pnl-ogrenci" role="tabpanel">
      <div class="app-card p-4 p-md-5 mb-4">
        <div class="d-flex align-items-center mb-4 gap-2">
          <div class="bg-primary bg-opacity-10 p-2 rounded-circle text-primary"><i class="bi bi-person-fill fs-4"></i></div>
          <h2 class="h4 mb-0">Ã–ÄŸrenci KaydÄ±</h2>
        </div>

        <div class="row g-3 form-row-gap">
          <div class="col-md-6">
            <label class="form-label text-muted small fw-bold">Ã–ÄRENCÄ° ADI SOYADI</label>
            <input type="text" id="ogrenciAd" class="form-control" placeholder="Ad Soyad giriniz..." />
          </div>
          <div class="col-md-6">
            <label class="form-label text-muted small fw-bold">SINIF SEVÄ°YESÄ°</label>
            <select id="ogrenciSinif" class="form-select">
              <option value="">SeÃ§iniz...</option>
              <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
              <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
              <option>9. SÄ±nÄ±f</option><option>10. SÄ±nÄ±f</option>
              <option>11. SÄ±nÄ±f</option><option>12. SÄ±nÄ±f</option>
              <option>Mezun</option>
            </select>
          </div>
          <div class="col-12 d-flex gap-2 mt-4">
            <button class="btn btn-primary px-4" onclick="ogrenciEkle()">
              <i class="bi bi-plus-lg me-1"></i> Kaydet
            </button>
            <button class="btn btn-light text-muted border" onclick="temizleInputlar()">
              <i class="bi bi-arrow-clockwise me-1"></i> Temizle
            </button>
          </div>
        </div>

        <div class="my-5 border-top pt-4">
          <h3 class="h6 text-muted text-uppercase mb-3 fw-bold">ğŸ“‹ Ã–ÄŸrenci Listesi</h3>
          <div class="list-group list-fit" id="ogrenciListesi"></div>
        </div>

        <div class="bg-light p-4 rounded-3 border">
          <h3 class="h5 mb-3 text-primary"><i class="bi bi-journal-bookmark-fill me-2"></i>HÄ±zlÄ± Ã–dev GiriÅŸi</h3>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label small">Ã–ÄŸrenci</label>
              <select id="odevOgrenci" class="form-select bg-white">
                <option value="">SeÃ§iniz</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small">Tarih</label>
              <input type="date" id="odevTarih" class="form-control bg-white"/>
            </div>
            <div class="col-12">
              <label class="form-label small">Ã–dev Ä°Ã§eriÄŸi</label>
              <textarea id="odevIcerik" class="form-control bg-white" rows="2" placeholder="Ã–rn: Matematik test 4 Ã§Ã¶zÃ¼lecek..."></textarea>
            </div>
            <div class="col-12 d-flex flex-wrap gap-2">
              <button class="btn btn-success text-white" onclick="odevEkle()"><i class="bi bi-check-lg"></i> Ã–dev Ekle</button>
              <button class="btn btn-outline-danger btn-sm ms-auto" onclick="tumOdevleriSil()"><i class="bi bi-trash"></i> TÃ¼mÃ¼nÃ¼ Sil</button>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div class="d-flex justify-content-between align-items-end mb-2">
             <h3 class="h6 text-uppercase text-muted fw-bold mb-0">Son KayÄ±tlÄ± Ã–devler</h3>
             <div class="w-25">
               <select id="odevFiltreOgrenci" class="form-select form-select-sm">
                  <option value="">TÃ¼mÃ¼nÃ¼ GÃ¶ster</option>
               </select>
             </div>
          </div>
          <div id="odevListesi" class="list-group list-fit shadow-sm"></div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pnl-haftalik" role="tabpanel">
      <div class="app-card p-4 p-md-5">
        <div class="d-flex align-items-center mb-4 gap-2">
          <div class="bg-warning bg-opacity-10 p-2 rounded-circle text-warning"><i class="bi bi-calendar3 fs-4"></i></div>
          <h2 class="h4 mb-0">HaftalÄ±k DeÄŸerlendirme</h2>
        </div>

        <div class="row g-3 form-row-gap">
          <div class="col-md-4">
            <label class="form-label text-muted small fw-bold">Ã–ÄRENCÄ°</label>
            <select id="haftaOgrenci" class="form-select shadow-none">
              <option value="">SeÃ§iniz</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label text-muted small fw-bold">Ä°LGÄ°LÄ° Ã–DEV</label>
            <select id="haftaOdev" class="form-select shadow-none">
              <option value="">SeÃ§iniz</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label text-muted small fw-bold">DURUM</label>
            <select id="odevDurumu" class="form-select shadow-none">
              <option value="">SeÃ§iniz</option>
              <option value="yapti">âœ… TamamladÄ±</option>
              <option value="yapmadi">âŒ YapmadÄ±</option>
              <option value="eksik">âš ï¸ Eksik</option>
              <option value="getirmedi">ğŸ“­ Getirmedi</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label text-muted small">Bu Hafta Ä°ÅŸlenen Konu</label>
            <textarea id="buHaftaKonu" class="form-control" rows="2"></textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label text-muted small">Gelecek HaftanÄ±n Ã–devi</label>
            <textarea id="gelecekHaftaOdev" class="form-control" rows="2"></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted small">Teslim Tarihi</label>
            <input type="date" id="gelecekTarih" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted small">Gelecek Hafta Konusu</label>
            <textarea id="gelecekHaftaKonu" class="form-control" rows="2"></textarea>
          </div>

          <div class="p-3 bg-light rounded-3 border mt-3">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label fw-bold small text-primary">Motivasyon (1-10)</label>
                <input type="number" id="haftaMotivasyon" class="form-control text-center fw-bold text-primary" min="1" max="10" />
              </div>
              <div class="col-md-9">
                <label class="form-label fw-bold small text-primary">Genel Ders DeÄŸerlendirmesi</label>
                <textarea id="haftaMotivasyonAciklama" class="form-control" rows="1"></textarea>
              </div>
            </div>
          </div>

          <div class="col-12 d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-primary flex-grow-1 flex-md-grow-0" type="button" onclick="haftalikVeriyiEkle()">
              <i class="bi bi-save2 me-1"></i> KaydÄ± Tamamla
            </button>
            <button class="btn btn-outline-secondary" onclick="haftalikFormYenile()">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-outline-danger ms-auto" type="button" onclick="tumHaftalikKayitlariSil()">
              <i class="bi bi-trash"></i> Sil
            </button>
          </div>
        </div>

        <hr class="my-5 opacity-10" />

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="h5 mb-0 fw-bold">ğŸ“‹ GeÃ§miÅŸ DeÄŸerlendirmeler</h3>
          <select id="haftalikFiltreOgrenci" class="form-select form-select-sm w-auto">
            <option value="">TÃ¼m Ã–ÄŸrenciler</option>
          </select>
        </div>
        
        <div id="haftalikKayitListesi" class="list-group list-fit shadow-sm"></div>
        <div id="haftalikOzet" class="mt-2 text-end small fw-bold text-primary"></div>
        <p id="haftaDurumMesaji" class="mt-2 small text-muted text-center"></p>
      </div>
    </div>

    <div class="tab-pane fade" id="pnl-rapor" role="tabpanel">
      <div class="app-card p-4 p-md-5 text-center">
        <div class="d-inline-block bg-success bg-opacity-10 p-3 rounded-circle text-success mb-3">
          <i class="bi bi-whatsapp fs-1"></i>
        </div>
        <h2 class="h3 mb-4">WhatsApp Rapor OluÅŸturucu</h2>

        <div class="row g-3 justify-content-center text-start">
          <div class="col-md-5">
            <label class="form-label fw-bold small">RAPOR TÃœRÃœ</label>
            <select id="raporTipi" class="form-select" onchange="raporTipiDegisti()">
              <option value="haftalik">ğŸ“… HaftalÄ±k Rapor</option>
              <option value="aylik">ğŸ“† AylÄ±k Rapor</option>
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label fw-bold small">Ã–ÄRENCÄ° SEÃ‡Ä°MÄ°</label>
            <select id="raporOgrenciSec" class="form-select"></select>
          </div>

          <div class="col-md-10">
            <label class="form-label fw-bold small">MESAJ Ã–NÄ°ZLEME</label>
            <textarea id="raporMesaj" rows="8" class="form-control bg-light font-monospace small p-3"></textarea>
          </div>

          <div class="col-md-10 d-flex gap-2 justify-content-center mt-2">
            <button class="btn btn-success px-4 py-2 shadow-sm" onclick="whatsappMesajGonder()">
              <i class="bi bi-whatsapp me-2"></i> WhatsApp ile GÃ¶nder
            </button>
            <button class="btn btn-outline-dark px-4 py-2" onclick="qrKodModalAc()">
              <i class="bi bi-qr-code me-2"></i> QR Kod GÃ¶ster
            </button>
            <button class="btn btn-outline-secondary" onclick="raporFormYenile()">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
        
        <div id="qrCanvasContainer" class="qr-center mt-4 d-none"></div>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="ogrenciGuncelleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">âœï¸ Ã–ÄŸrenci DÃ¼zenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="form-floating mb-3">
          <input type="text" id="guncelleAd" class="form-control" placeholder="Ad">
          <label>Ã–ÄŸrenci AdÄ±</label>
        </div>
        <div class="form-floating">
          <select id="guncelleSinif" class="form-select">
            <option value="">SeÃ§iniz</option>
            <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
            <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
            <option>9. SÄ±nÄ±f</option><option>10. SÄ±nÄ±f</option>
            <option>11. SÄ±nÄ±f</option><option>12. SÄ±nÄ±f</option>
            <option>Mezun</option>
          </select>
          <label>SÄ±nÄ±f</label>
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button class="btn btn-light" data-bs-dismiss="modal">Ä°ptal</button>
        <button class="btn btn-primary px-4" onclick="ogrenciGuncelleKaydet()">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="odevGuncelleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">âœï¸ Ã–dev DÃ¼zenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-0">
        <div class="mb-3">
          <label class="small text-muted fw-bold">TARÄ°H</label>
          <input type="date" id="guncelleOdevTarih" class="form-control"/>
        </div>
        <div>
          <label class="small text-muted fw-bold">Ä°Ã‡ERÄ°K</label>
          <textarea id="guncelleOdevIcerik" rows="4" class="form-control"></textarea>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-light" data-bs-dismiss="modal">Ä°ptal</button>
        <button class="btn btn-primary" onclick="odevGuncelleKaydet()">GÃ¼ncelle</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="haftalikGuncelleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 bg-light">
        <h5 class="modal-title fw-bold text-primary">âœï¸ KayÄ±t DetaylarÄ±nÄ± DÃ¼zenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-grid gap-3">
          <input type="text" id="guncelleHaftaOgrenci" class="form-control fw-bold bg-white" readonly>
          
          <div class="row g-2">
            <div class="col-6">
               <label class="small text-muted">Durum</label>
               <input type="text" id="guncelleHaftaDurum" class="form-control">
            </div>
            <div class="col-6">
               <label class="small text-muted">Tarih</label>
               <input type="date" id="guncelleHaftaTarih" class="form-control">
            </div>
          </div>
          
          <div>
            <label class="small text-muted">Bu Hafta Konusu</label>
            <input type="text" id="guncelleHaftaKonu" class="form-control">
          </div>
          <div>
            <label class="small text-muted">Ä°lgili Ã–dev</label>
            <input type="text" id="guncelleHaftaOdev" class="form-control">
          </div>
          <hr class="my-1">
          <div>
            <label class="small text-muted">Gelecek Hafta Konusu</label>
            <input type="text" id="guncelleGelecekKonu" class="form-control">
          </div>
           <div>
            <label class="small text-muted">Gelecek Hafta Ã–devi</label>
            <input type="text" id="guncelleGelecekOdev" class="form-control">
          </div>
          
          <div class="row g-2">
             <div class="col-4">
               <label class="small text-muted">Motivasyon</label>
               <input type="number" id="guncelleHaftaMotivasyon" class="form-control text-center" min="1" max="10">
             </div>
             <div class="col-8">
               <label class="small text-muted">AÃ§Ä±klama</label>
               <textarea id="guncelleHaftaMotivasyonAciklama" class="form-control" rows="1"></textarea>
             </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-light" data-bs-dismiss="modal">Ä°ptal</button>
        <button class="btn btn-primary px-4" onclick="haftalikKaydiGuncelleKaydet()">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">ğŸ“± WhatsApp QR</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center pb-4">
        <div id="qrModalCanvas" class="d-inline-block p-3 border rounded-3 bg-white mt-2"></div>
        <p class="small text-muted mt-3 mb-0">Telefon kamerasÄ±nÄ± okutarak mesajÄ± aÃ§abilirsiniz.</p>
      </div>
    </div>
  </div>
</div>

  <!-- Bootstrap 5.3 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ YardÄ±mcÄ±lar ************/
    let guncellenecekId = null;            // Ã–ÄŸrenci gÃ¼ncelle
    let guncellenecekOdevKey = null;       // Ã–dev gÃ¼ncelle
    let guncellenecekHaftaKey = null;      // HaftalÄ±k kayÄ±t gÃ¼ncelle

    const bsModal = (id) => bootstrap.Modal.getOrCreateInstance(document.getElementById(id));

    const durumIcon = (durum) => {
      switch ((durum || '').toLowerCase()) {
        case 'yapti': return 'âœ… YaptÄ±';
        case 'yapmadi': return 'âŒ YapmadÄ±';
        case 'eksik': return 'âš ï¸ Eksik';
        case 'getirmedi': return 'ğŸ“­ Getirmedi';
        default: return 'â– Bilgi Yok';
      }
    };

    // Tarih formatlama yardÄ±mcÄ± fonksiyonu
    // Bu fonksiyon bir tarih stringini (YYYY-MM-DD veya ISO format) alÄ±r ve
    // gÃ¼n.ay.yÄ±l (01.11.2025) formatÄ±nda geri dÃ¶ndÃ¼rÃ¼r. GeÃ§ersiz tarihler
    // olduÄŸu gibi dÃ¶ndÃ¼rÃ¼lÃ¼r. Bu fonksiyon liste ve rapor gÃ¶rÃ¼nÃ¼mÃ¼nde
    // tarihleri kullanÄ±cÄ±ya daha okunur ÅŸekilde gÃ¶stermek iÃ§in kullanÄ±lÄ±r.
    function formatTurkishDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      // EÄŸer geÃ§erli bir tarih deÄŸilse veya parse edilemiyorsa stringi aynen dÃ¶ndÃ¼r.
      if (isNaN(date.getTime())) return dateStr;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    // Sayfalama iÃ§in global deÄŸiÅŸkenler. Her liste iÃ§in mevcut sayfayÄ± tutar.
    // Bir filtre deÄŸiÅŸtiÄŸinde veya veri yeniden yÃ¼klendiÄŸinde bu deÄŸiÅŸkenler
    // gerektiÄŸinde gÃ¼ncellenir.
    let odevCurrentPage = 1;
    let haftalikCurrentPage = 1;

    // --- Ortak yenile yardÄ±mcÄ±larÄ± ---
    function refreshStudents() {
      ogrenciListele();
      doldurOgrenciSecimi();       // Ã–dev ekleme Ã¶ÄŸrenci select
      doldurHaftaOgrenciListesi(); // HaftalÄ±k deÄŸerlendirme Ã¶ÄŸrenci select
      raporOgrenciSecDoldur();     // Rapor Ã¶ÄŸrenci select
      // Ã–ÄŸrenci deÄŸiÅŸikliklerinde filtreleri gÃ¼ncelle
      doldurOdevFiltre();
      doldurHaftalikFiltre();
    }
    function refreshAssignments() {
      odevListele();
    }
    function refreshWeekly() {
      haftalikKayitlariListele();
    }
    function refreshAll() {
      refreshStudents();
      refreshAssignments();
      refreshWeekly();
      // Rapor seÃ§imi yapÄ±lmÄ±ÅŸsa mesajÄ± tazele
      const sel = document.getElementById('raporOgrenciSec');
      if (sel && sel.value) { raporMesajiOlustur(); }
    }

    // Ã–ÄŸrenci - dizi olarak sakla / getir
    function getOgrenciler(cb){
      database.ref("ogrenciler").once("value").then(s => {
        const val = s.val();
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : (Object.values(val || {}));
        cb(arr || []);
      }).catch(_ => cb([]));
    }
    function setOgrenciler(arr){
      return database.ref("ogrenciler").set(arr || []);
    }

    /************ Ã–ÄRENCÄ° ************/
    function temizleInputlar(){
      document.getElementById('ogrenciAd').value = '';
      document.getElementById('ogrenciSinif').value = '';
    }

    function ogrenciEkle(){
      const ad = document.getElementById('ogrenciAd').value.trim();
      const sinif = document.getElementById('ogrenciSinif').value;
      if(!ad || !sinif){ alert("LÃ¼tfen Ã¶ÄŸrenci adÄ± ve sÄ±nÄ±f seÃ§in."); return; }

      getOgrenciler(ogrenciler=>{
        const id = Date.now();
        const yeni = { id, ad, sinif };
        const guncel = [...ogrenciler, yeni];
        setOgrenciler(guncel).then(()=>{
          alert("âœ… Ã–ÄŸrenci eklendi.");
          refreshStudents(); // Ã¶nemli
          temizleInputlar();
        }).catch(()=> alert("âŒ Ã–ÄŸrenci eklenemedi."));
      });
    }

    function ogrenciSil(id){
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.filter(o=>o.id !== id);
        setOgrenciler(guncel).then(()=>{
          refreshStudents(); // Ã¶nemli
        });
      });
    }

    function ogrenciGuncelleAc(id){
      getOgrenciler(ogrenciler=>{
        const o = ogrenciler.find(x=>x.id===id);
        if(!o) return;
        guncellenecekId = id;
        document.getElementById('guncelleAd').value = o.ad || '';
        document.getElementById('guncelleSinif').value = o.sinif || '';
        bsModal('ogrenciGuncelleModal').show();
      });
    }

    function ogrenciGuncelleKaydet(){
      const ad = document.getElementById('guncelleAd').value.trim();
      const sinif = document.getElementById('guncelleSinif').value;
      if(!guncellenecekId){ alert("GÃ¼ncellenecek Ã¶ÄŸrenci yok."); return; }
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.map(o=> o.id===guncellenecekId ? ({...o, ad, sinif}) : o);
        setOgrenciler(guncel).then(()=>{
          bsModal('ogrenciGuncelleModal').hide();
          refreshStudents(); // Ã¶nemli
          alert("âœ… Ã–ÄŸrenci gÃ¼ncellendi.");
        });
      });
    }

    function ogrenciListele(){
      const liste = document.getElementById('ogrenciListesi');
      liste.innerHTML = '<div class="text-center text-muted py-3">YÃ¼kleniyor...</div>';
      getOgrenciler(ogrenciler=>{
        liste.innerHTML = '';
        if(!ogrenciler.length){
          liste.innerHTML = '<div class="text-center text-muted py-3">KayÄ±tlÄ± Ã¶ÄŸrenci yok.</div>';
          return;
        }
        ogrenciler.forEach(o=>{
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.innerHTML = `
            <div>
              <div class="fw-medium">${o.ad}</div>
              <div class="small-muted">${o.sinif}</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary" onclick="ogrenciGuncelleAc(${o.id})"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="ogrenciSil(${o.id})"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
      });
    }

    /************ Ã–DEVLER ************/
    function doldurOgrenciSecimi(){
      const sel = document.getElementById('odevOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
    }

    function odevListele(){
      const liste = document.getElementById('odevListesi');
      liste.innerHTML = '';
      // Sayfalama kapsayÄ±cÄ±sÄ±nÄ± veya mevcut nav'Ä± bul. EÄŸer yoksa oluÅŸtur.
      let paginationContainer = document.getElementById('odevPagination');
      if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'odevPagination';
        paginationContainer.className = 'mt-3';
        liste.parentNode.appendChild(paginationContainer);
      }
      // Veriyi Firebase'den alÄ±p sayfalama ve sÄ±ralama uygula.
      database.ref("odevler").once("value").then(snap => {
        const val = snap.val() || {};
        const allEntries = Object.entries(val);
        const filtreSel = document.getElementById('odevFiltreOgrenci');
        const filtreDeger = filtreSel ? filtreSel.value : '';
        // Filtrele
        let filtered = allEntries.filter(([_, odev]) => {
          return !filtreDeger || odev.ogrenci === filtreDeger;
        });
        // EÄŸer hiÃ§ veri yoksa uygun mesajÄ± gÃ¶ster ve sayfalama temizle.
        if (filtered.length === 0) {
          liste.innerHTML = '<div class="text-center text-muted py-3">' +
            (allEntries.length === 0 ? 'KayÄ±tlÄ± Ã¶dev yok.' : 'SeÃ§ilen Ã¶ÄŸrenci iÃ§in Ã¶dev bulunamadÄ±.') +
            '</div>';
          paginationContainer.innerHTML = '';
          return;
        }
        // Tarihe gÃ¶re azalan sÄ±rala
        filtered.sort((a, b) => {
          const da = new Date(a[1].tarih);
          const db = new Date(b[1].tarih);
          return db - da;
        });
        // Sayfalama hesapla
        const pageSize = 10;
        const totalPages = Math.ceil(filtered.length / pageSize);
        // EÄŸer mevcut sayfa totalPages'den bÃ¼yÃ¼kse son sayfaya ayarla
        if (odevCurrentPage > totalPages) odevCurrentPage = totalPages;
        if (odevCurrentPage < 1) odevCurrentPage = 1;
        const startIdx = (odevCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageEntries = filtered.slice(startIdx, endIdx);
        // Liste Ã¶ÄŸelerini oluÅŸtur
        pageEntries.forEach(([key, odev]) => {
          const item = document.createElement('div');
          item.className = 'list-group-item d-flex align-items-start';
          item.innerHTML = `
            <div class="me-2 flex-grow-1">
              <div class="fw-medium">${odev.ogrenci || 'Ã–ÄŸrenci Yok'} â€” ${formatTurkishDate(odev.tarih) || 'Tarih Yok'}</div>
              <div class="small-muted">${odev.konu || odev.icerik || 'Ä°Ã§erik Yok'}</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary" onclick="odevGuncelleModalAc('${key}')"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="odevSil('${key}')"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
        // Sayfalama kontrollerini oluÅŸtur
        paginationContainer.innerHTML = '';
        if (totalPages > 1) {
          const nav = document.createElement('nav');
          const ul = document.createElement('ul');
          ul.className = 'pagination justify-content-center';
          // Ã–nceki butonu
          const prevLi = document.createElement('li');
          prevLi.className = 'page-item' + (odevCurrentPage === 1 ? ' disabled' : '');
          const prevLink = document.createElement('a');
          prevLink.className = 'page-link';
          prevLink.href = '#';
          prevLink.innerText = 'Â«';
          prevLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (odevCurrentPage > 1) {
              odevCurrentPage--;
              odevListele();
            }
          });
          prevLi.appendChild(prevLink);
          ul.appendChild(prevLi);
          // Sayfa numaralarÄ±
          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === odevCurrentPage ? ' active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.addEventListener('click', (e) => {
              e.preventDefault();
              if (i !== odevCurrentPage) {
                odevCurrentPage = i;
                odevListele();
              }
            });
            li.appendChild(a);
            ul.appendChild(li);
          }
          // Sonraki butonu
          const nextLi = document.createElement('li');
          nextLi.className = 'page-item' + (odevCurrentPage === totalPages ? ' disabled' : '');
          const nextLink = document.createElement('a');
          nextLink.className = 'page-link';
          nextLink.href = '#';
          nextLink.innerText = 'Â»';
          nextLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (odevCurrentPage < totalPages) {
              odevCurrentPage++;
              odevListele();
            }
          });
          nextLi.appendChild(nextLink);
          ul.appendChild(nextLi);
          nav.appendChild(ul);
          paginationContainer.appendChild(nav);
        }
      });
    }

    function odevFormTemizle(){
      document.getElementById('odevOgrenci').value = '';
      document.getElementById('odevTarih').value = '';
      document.getElementById('odevIcerik').value = '';
    }

    function pushOdev(odev){
      const ref = database.ref("odevler").push();
      return ref.set(odev);
    }

    function odevEkle(){
      const ogrenci = document.getElementById('odevOgrenci').value;
      const konu = (document.getElementById('odevIcerik').value || '').trim();
      const tarih = document.getElementById('odevTarih').value;
      if(!ogrenci || !konu || !tarih){ alert("Ã–ÄŸrenci, konu ve tarih boÅŸ bÄ±rakÄ±lamaz."); return; }
      pushOdev({ogrenci, konu, tarih}).then(()=>{
        alert("âœ… Ã–dev eklendi.");
        refreshAssignments(); // Ã¶nemli
        odevFormTemizle();
      }).catch(()=> alert("âŒ Ã–dev eklenemedi."));
    }

    function odevGuncelleModalAc(key){
      database.ref("odevler/"+key).once("value").then(s=>{
        const o = s.val(); if(!o) return;
        guncellenecekOdevKey = key;
        document.getElementById('guncelleOdevTarih').value = o.tarih || '';
        document.getElementById('guncelleOdevIcerik').value = o.konu || o.icerik || '';
        bsModal('odevGuncelleModal').show();
      });
    }

    function odevGuncelleKaydet(){
      if(!guncellenecekOdevKey){ alert("GÃ¼ncellenecek Ã¶dev yok."); return; }
      const tarih = document.getElementById('guncelleOdevTarih').value;
      const konu  = document.getElementById('guncelleOdevIcerik').value.trim();
      if(!tarih || !konu){ alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun."); return; }
      database.ref("odevler/"+guncellenecekOdevKey).update({tarih, konu}).then(()=>{
        bsModal('odevGuncelleModal').hide();
        refreshAssignments(); // Ã¶nemli
        alert("âœ… Ã–dev gÃ¼ncellendi.");
      }).catch(()=> alert("âŒ Ã–dev gÃ¼ncellenemedi."));
    }

    function odevSil(key){
      if(!confirm("Bu Ã¶devi silmek istediÄŸinize emin misiniz?")) return;
      database.ref("odevler/"+key).remove().then(()=>{
        refreshAssignments(); // Ã¶nemli
      });
    }

    function tumOdevleriSil(){
      if(!confirm("TÃ¼m Ã¶devleri silmek istediÄŸinize emin misiniz?")) return;
      database.ref("odevler").remove().then(()=>{
        refreshAssignments(); // Ã¶nemli
      });
    }

    /************ HAFTALIK ************/
    function doldurHaftaOgrenciListesi(){
      const sel = document.getElementById('haftaOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§in</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
    }

    // --- Filtre selectlerini doldurur ---
    function doldurOdevFiltre(){
      const sel = document.getElementById('odevFiltreOgrenci');
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      getOgrenciler(arr=>{
        (arr||[]).forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad;
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        if(prev) sel.value = prev;
      });
    }

    function doldurHaftalikFiltre(){
      const sel = document.getElementById('haftalikFiltreOgrenci');
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      getOgrenciler(arr=>{
        (arr||[]).forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad;
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        if(prev) sel.value = prev;
      });
    }

    document.getElementById('haftaOgrenci').addEventListener('change', function(){
      const secili = this.value;
      const sel = document.getElementById('haftaOdev');
      sel.innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
      database.ref("odevler").once("value").then(s=>{
        const val = s.val() || {};
        Object.values(val)
  .filter(o => o.ogrenci === secili)
  .sort((a, b) => new Date(b.tarih) - new Date(a.tarih))
  .forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.konu || o.icerik || '';
          // Tarihi okunur formata Ã§evir
          const tarihStr = formatTurkishDate(o.tarih);
          opt.textContent = `${tarihStr} - ${o.konu || o.icerik}`;
          sel.appendChild(opt);
        });
      });
    });

    function haftalikVeriyiEkle(){
      const ogrenci = document.getElementById('haftaOgrenci').value;
      const odev    = document.getElementById('haftaOdev').value;
      const durum   = document.getElementById('odevDurumu').value;
      const konu    = document.getElementById('buHaftaKonu').value.trim();
      const gelecekOdev = document.getElementById('gelecekHaftaOdev').value.trim();
      const tarih   = document.getElementById('gelecekTarih').value;
      const gelecekKonu = document.getElementById('gelecekHaftaKonu').value.trim();

      // Motivasyon puanÄ± ve aÃ§Ä±klamasÄ±
      const motivasyonInput = document.getElementById('haftaMotivasyon');
      let motivasyon = 0;
      if (motivasyonInput && motivasyonInput.value) {
        motivasyon = parseInt(motivasyonInput.value);
        if (isNaN(motivasyon) || motivasyon < 0) motivasyon = 0;
      }
      const motivasyonAciklama = (document.getElementById('haftaMotivasyonAciklama')?.value || '').trim();

      if(!ogrenci || !tarih){ alert("ğŸš« Ã–ÄŸrenci ve tarih boÅŸ bÄ±rakÄ±lamaz."); return; }

      const zaman = new Date().toISOString();
      const haftalikKayit = { ogrenci, odev, durum, konu, gelecekOdev, tarih, gelecekKonu, zaman, motivasyon, motivasyonAciklama };
      const odevKaydi = { ogrenci, konu: gelecekOdev, tarih };

      const haftalikRef = database.ref("haftalikDegerlendirme").push();
      const odevRef     = database.ref("odevler").push();

      Promise.all([haftalikRef.set(haftalikKayit), odevRef.set(odevKaydi)]).then(()=>{
        document.getElementById('haftaDurumMesaji').innerText = 'âœ… KayÄ±t ve Ã¶dev baÅŸarÄ±yla eklendi.';
        // form alanlarÄ±nÄ± temizle
        const motInp = document.getElementById('haftaMotivasyon');
        if (motInp) motInp.value = '';
        const motAcikInp = document.getElementById('haftaMotivasyonAciklama');
        if (motAcikInp) motAcikInp.value = '';
        refreshWeekly();      // Ã¶nemli
        refreshAssignments(); // Ã¶nemli
      }).catch(()=>{
        alert("âš ï¸ Veri eklenirken hata oluÅŸtu.");
      });
    }

    function haftalikKayitlariListele(){
      const liste = document.getElementById('haftalikKayitListesi');
      liste.innerHTML = '';
      // Sayfalama kapsayÄ±cÄ±sÄ±nÄ± bul veya oluÅŸtur
      let paginationContainer = document.getElementById('haftalikPagination');
      if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'haftalikPagination';
        paginationContainer.className = 'mt-3';
        liste.parentNode.appendChild(paginationContainer);
      }
      database.ref("haftalikDegerlendirme").once("value").then(s => {
        const val = s.val() || {};
        const filtreSel = document.getElementById('haftalikFiltreOgrenci');
        const filtreDeger = filtreSel ? filtreSel.value : '';
        // KayÄ±t yoksa mesaj gÃ¶ster ve temizle
        const entries = Object.entries(val);
        if (entries.length === 0) {
          liste.innerHTML = '<div class="text-center text-muted py-3">KayÄ±t bulunamadÄ±.</div>';
          paginationContainer.innerHTML = '';
          const ozetEl = document.getElementById('haftalikOzet');
          if (ozetEl) ozetEl.innerText = '';
          return;
        }
        // Filtre uygula
        let filtered = entries.filter(([_, veri]) => {
          return !filtreDeger || veri.ogrenci === filtreDeger;
        });
        // EÄŸer filtre sonrasÄ±nda veri kalmadÄ±ysa mesaj gÃ¶ster ve temizle
        if (filtered.length === 0) {
          liste.innerHTML = '<div class="text-center text-muted py-3">SeÃ§ilen Ã¶ÄŸrenci iÃ§in kayÄ±t bulunamadÄ±.</div>';
          paginationContainer.innerHTML = '';
          const ozetEl = document.getElementById('haftalikOzet');
          if (ozetEl) ozetEl.innerText = '';
          return;
        }
        // Tarihe gÃ¶re azalan sÄ±rala (veri.tarih veya veri.zaman)
        filtered.sort((a, b) => {
          const da = new Date(a[1].tarih || a[1].zaman);
          const db = new Date(b[1].tarih || b[1].zaman);
          return db - da;
        });
        // Sayfalama hesapla
        const pageSize = 10;
        const totalPages = Math.ceil(filtered.length / pageSize);
        if (haftalikCurrentPage > totalPages) haftalikCurrentPage = totalPages;
        if (haftalikCurrentPage < 1) haftalikCurrentPage = 1;
        const startIdx = (haftalikCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageEntries = filtered.slice(startIdx, endIdx);
        // Liste Ã¶ÄŸelerini oluÅŸtur
        pageEntries.forEach(([key, veri]) => {
          const metin = `${veri.ogrenci || '???'} â€” ${formatTurkishDate(veri.tarih || veri.zaman) || '???'} â€” ${veri.konu || '???'}`;
          const nextLine = veri.gelecekOdev ? `<div class="fw-bold mt-1">${veri.gelecekOdev}</div>` : '';
          const item = document.createElement('div');
          item.className = 'list-group-item d-flex align-items-start';
          item.innerHTML = `
            <div class="me-2 flex-grow-1">
              <div class="fw-medium">${metin}</div>
              <div class="small-muted">${(veri.odev ? 'Ã–dev: ' + veri.odev + ' â†’ ' : '') + durumIcon(veri.durum)}</div>
              ${nextLine}
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary" onclick='haftalikKaydiGuncelle("${key}")'><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick='haftalikKaydiSil("${key}")'><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
        // Ã–zet alanÄ±nÄ± gÃ¼ncelle
        const ozetEl = document.getElementById('haftalikOzet');
        if (ozetEl) {
          if (filtreDeger) {
            ozetEl.innerText = `Toplam ${filtered.length} ders kaydÄ± bulundu.`;
          } else {
            ozetEl.innerText = '';
          }
        }
        // Sayfalama kontrolleri
        paginationContainer.innerHTML = '';
        if (totalPages > 1) {
          const nav = document.createElement('nav');
          const ul = document.createElement('ul');
          ul.className = 'pagination justify-content-center';
          // Ã–nceki
          const prevLi = document.createElement('li');
          prevLi.className = 'page-item' + (haftalikCurrentPage === 1 ? ' disabled' : '');
          const prevLink = document.createElement('a');
          prevLink.className = 'page-link';
          prevLink.href = '#';
          prevLink.innerText = 'Â«';
          prevLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (haftalikCurrentPage > 1) {
              haftalikCurrentPage--;
              haftalikKayitlariListele();
            }
          });
          prevLi.appendChild(prevLink);
          ul.appendChild(prevLi);
          // Numaralar
          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === haftalikCurrentPage ? ' active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.addEventListener('click', (e) => {
              e.preventDefault();
              if (i !== haftalikCurrentPage) {
                haftalikCurrentPage = i;
                haftalikKayitlariListele();
              }
            });
            li.appendChild(a);
            ul.appendChild(li);
          }
          // Sonraki
          const nextLi = document.createElement('li');
          nextLi.className = 'page-item' + (haftalikCurrentPage === totalPages ? ' disabled' : '');
          const nextLink = document.createElement('a');
          nextLink.className = 'page-link';
          nextLink.href = '#';
          nextLink.innerText = 'Â»';
          nextLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (haftalikCurrentPage < totalPages) {
              haftalikCurrentPage++;
              haftalikKayitlariListele();
            }
          });
          nextLi.appendChild(nextLink);
          ul.appendChild(nextLi);
          nav.appendChild(ul);
          paginationContainer.appendChild(nav);
        }
      });
    }

    function haftalikKaydiSil(key){
      if(!confirm("Bu haftalÄ±k kaydÄ± silmek istiyor musunuz?")) return;
      database.ref("haftalikDegerlendirme/"+key).remove().then(()=>{
        refreshWeekly(); // Ã¶nemli
      });
    }

    function haftalikKaydiGuncelle(key){
      guncellenecekHaftaKey = key;
      database.ref("haftalikDegerlendirme/"+key).once("value").then(s=>{
        const v = s.val() || {};
        document.getElementById('guncelleHaftaOgrenci').value = v.ogrenci || '';
        document.getElementById('guncelleHaftaOdev').value    = v.odev || '';
        document.getElementById('guncelleHaftaDurum').value   = v.durum || '';
        document.getElementById('guncelleHaftaKonu').value    = v.konu || '';
        document.getElementById('guncelleHaftaTarih').value   = v.tarih || '';
        document.getElementById('guncelleGelecekOdev').value  = v.gelecekOdev || '';
        document.getElementById('guncelleGelecekKonu').value  = v.gelecekKonu || '';
        // Motivasyon puanÄ± ve aÃ§Ä±klama deÄŸerlerini doldur
        const motEl = document.getElementById('guncelleHaftaMotivasyon');
        if (motEl) motEl.value = v.motivasyon || '';
        const motAcikEl = document.getElementById('guncelleHaftaMotivasyonAciklama');
        if (motAcikEl) motAcikEl.value = v.motivasyonAciklama || '';
        bsModal('haftalikGuncelleModal').show();
      });
    }

    function haftalikKaydiGuncelleKaydet(){
      if(!guncellenecekHaftaKey){ alert("GÃ¼ncellenecek kayÄ±t yok."); return; }
      // GÃ¼ncellenen veri objesi
      // Motivasyon verileri de dahil ediliyor
      const motVal = parseInt(document.getElementById('guncelleHaftaMotivasyon')?.value) || 0;
      const motAcik = document.getElementById('guncelleHaftaMotivasyonAciklama')?.value || '';
      const veri = {
        ogrenci: document.getElementById('guncelleHaftaOgrenci').value,
        odev: document.getElementById('guncelleHaftaOdev').value,
        durum: document.getElementById('guncelleHaftaDurum').value,
        konu: document.getElementById('guncelleHaftaKonu').value,
        tarih: document.getElementById('guncelleHaftaTarih').value,
        gelecekOdev: document.getElementById('guncelleGelecekOdev').value,
        gelecekKonu: document.getElementById('guncelleGelecekKonu').value,
        motivasyon: motVal,
        motivasyonAciklama: motAcik.trim(),
        zaman: new Date().toISOString()
      };
      database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update(veri).then(()=>{
        // ModalÄ± gÃ¼venli bir ÅŸekilde kapat
        const modalEl = document.getElementById('haftalikGuncelleModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();
        refreshWeekly(); // Ã¶nemli
        alert("âœ… KayÄ±t gÃ¼ncellendi.");
      }).catch(()=> alert("âŒ GÃ¼ncelleme baÅŸarÄ±sÄ±z."));
    }

    function tumHaftalikKayitlariSil(){
      if(!confirm("TÃ¼m haftalÄ±k kayÄ±tlarÄ± silmek istediÄŸinize emin misiniz?")) return;
      database.ref("haftalikDegerlendirme").remove().then(()=>{
        refreshWeekly(); // Ã¶nemli
        alert("âœ… TÃ¼m haftalÄ±k kayÄ±tlar silindi.");
      }).catch(()=> alert("âŒ KayÄ±tlar silinemedi."));
    }

    /************ RAPOR ************/
    function raporFormYenile(){
      document.getElementById('raporTipi').value = 'haftalik';
      document.getElementById('raporOgrenciSec').value = '';
      document.getElementById('raporMesaj').value = '';
    }

    function raporTipiDegisti(){ raporMesajiOlustur(); }

    function raporOgrenciSecDoldur(){
      const select = document.getElementById("raporOgrenciSec");
      if(!select) return;
      database.ref("ogrenciler").once("value").then(s=>{
        const val = s.val() || [];
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : Object.values(val);
        select.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
        (arr||[]).forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.id || o.ad;
          opt.textContent = o.ad;
          select.appendChild(opt);
        });
      });
    }

    function whatsappMesajGonder(){
      const mesaj = (document.getElementById('raporMesaj').value || '').trim();
      if(!mesaj) return alert('GÃ¶nderilecek mesaj boÅŸ.');
      const url = `https://wa.me/?text=${encodeURIComponent(mesaj)}`;
      window.open(url, '_blank');
    }

    function raporMesajiOlustur(){
      const tip = document.getElementById('raporTipi').value;
      const secilenId = document.getElementById('raporOgrenciSec').value;
      if(!secilenId) return;

      const ayAdlari = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
      const formatTarih = (date) => `${date.getDate()} ${ayAdlari[date.getMonth()]} ${date.getFullYear()}`;
      const toShortDateStr = (d) => new Date(d).toISOString().split('T')[0];

      const bugun = new Date();
      const bugunStr = toShortDateStr(bugun);
      const birAyOnce = new Date(bugun); birAyOnce.setMonth(birAyOnce.getMonth() - 1);
      const birAyOnceStr = toShortDateStr(birAyOnce);

      Promise.all([
        database.ref("ogrenciler").once("value"),
        database.ref("haftalikDegerlendirme").once("value")
      ]).then(([ogrenciSnap, haftalikSnap])=>{
        const ogrVal = ogrenciSnap.val() || [];
        const ogrArr = Array.isArray(ogrVal) ? (ogrVal.filter(Boolean)||[]) : Object.values(ogrVal||{});
        const haftVal = haftalikSnap.val() || {};
        const kayitlar = Object.values(haftVal);

        const ogrenci = ogrArr.find(o => (o.id == secilenId) || (o.ad == secilenId));
        if(!ogrenci) return;

        const ogrenciAdi = ogrenci.ad;

        if(tip === 'haftalik'){
          const ogrKay = kayitlar.filter(k=>k.ogrenci === ogrenciAdi);
          const sonKayit = ogrKay[ogrKay.length - 1];
          // Motivasyon bilgilerini hazÄ±rla
          const mot = parseInt(sonKayit?.motivasyon) || 0;
          const motAcik = (sonKayit?.motivasyonAciklama || '').trim();
          const yildizStr = mot > 0 ? 'â­'.repeat(mot) : '';
          const motMetni = mot ? `${mot}/10 ${yildizStr}` : 'Bilgi Yok';
          const motAcikMetni = motAcik || 'Bilgi Yok';

          const mesaj = `ğŸ“˜ Ã–zel Ders Takip Sistemi
ğŸ“… *Tarih:* ${formatTarih(bugun)}
ğŸ‘¤ *Ã–ÄŸrenci:* ${ogrenciAdi}
ğŸ“ *Ã–ÄŸretmen:* Ferhat KaragÃ¶z

ğŸ“Œ *Bu Hafta YapÄ±lanlar*
ğŸ“š *Ä°ÅŸlenen Konu:* ${sonKayit?.konu || 'Bilgi Yok'}
ğŸ“ *GeÃ§en Haftaki Ã–dev:* ${sonKayit?.odev || 'Ã–dev Yok'} â†’ ${durumIcon(sonKayit?.durum)}
â­ *Motivasyon:* ${motMetni}
ğŸ—’ï¸ *Genel Ders Durumu:* ${motAcikMetni}

ğŸ“– *Gelecek Hafta YapÄ±lacaklar*
ğŸ“ *Ã–dev:* ${sonKayit?.gelecekOdev || 'Ã–dev Yok'}
â° *Teslim Tarihi:* ${sonKayit?.tarih ? formatTarih(new Date(sonKayit.tarih)) : 'Tarih Yok'}
ğŸ“š *Ä°ÅŸlenecek Konular:* ${sonKayit?.gelecekKonu || 'Konu Yok'}

SaygÄ±larÄ±mÄ±zla, bilginize.`;
          document.getElementById('raporMesaj').value = mesaj;
        } else {
          const tarihAraligindakiKayitlar = kayitlar
            .filter(k=>{
              const ogr = k.ogrenci === ogrenciAdi;
              const tStr = toShortDateStr(k.zaman || k.tarih);
              return ogr && tStr >= birAyOnceStr && tStr <= bugunStr;
            })
            .sort((a,b)=> new Date(b.zaman || b.tarih) - new Date(a.zaman || a.tarih));

          const konular = tarihAraligindakiKayitlar.map(k=>{
            const t = new Date(k.zaman || k.tarih);
            return `- ${formatTarih(t)} â†’ ${k.konu || 'Konu girilmemiÅŸ'}`;
          });
          const odevSatirlari = tarihAraligindakiKayitlar.map(k=>{
            const t = new Date(k.zaman || k.tarih);
            return `- ${formatTarih(t)} â†’ ${k.odev || 'Ã–dev Yok'} â†’ ${durumIcon(k.durum)}`;
          });
          const toplamOdev = tarihAraligindakiKayitlar.filter(k=>k.odev).length;
          const yapilanOdev = tarihAraligindakiKayitlar.filter(k=>(k.durum||'').toLowerCase()==='yapti').length;
          const oran = toplamOdev ? Math.round((yapilanOdev / toplamOdev) * 100) : 0;

          const mesaj = `ğŸ“˜ Ã–zel Ders Takip Sistemi
ğŸ“… *Tarih:* ${formatTarih(bugun)}
ğŸ‘¤ *Ã–ÄŸrenci:* ${ogrenciAdi}
ğŸ“ *Ã–ÄŸretmen:* Ferhat KaragÃ¶z

ğŸ“… *Son 1 Ayda YapÄ±lanlar* (${formatTarih(birAyOnce)} - ${formatTarih(bugun)})

ğŸ“š *Ä°ÅŸlenen Konular:*
${konular.length ? konular.join("\n") : '- Veri yok'}

ğŸ“ *Verilen Ã–devler ve Kontrolleri:*
${odevSatirlari.length ? odevSatirlari.join("\n") : '- Veri yok'}

ğŸ“Š *Ã–dev PerformansÄ±*
- *Toplam Ã–dev:* ${toplamOdev}
- *Tamamlanan:* ${yapilanOdev}
- *BaÅŸarÄ± OranÄ±:* %${oran}

*Bu rapor, son bir ay iÃ§inde iÅŸlenen tÃ¼m konularÄ± ve Ã¶dev takibini iÃ§ermektedir.*

SaygÄ±larÄ±mÄ±zla, bilginize.`;
          document.getElementById('raporMesaj').value = mesaj;
        }
      });
    }

    function qrKodModalAc(){
      const mesaj = (document.getElementById('raporMesaj').value || '').trim();
      if(!mesaj){ alert("Mesaj boÅŸ."); return; }
      const url = `https://wa.me/?text=${encodeURIComponent(mesaj)}`;
      const container = document.getElementById('qrModalCanvas');
      container.innerHTML = '';
      new QRCode(container, { text:url, width:250, height:250, correctLevel: QRCode.CorrectLevel.M });
      bsModal('qrModal').show();
    }

    /************ INIT ************/
    window.addEventListener('load', ()=>{
      refreshAll(); // baÅŸlangÄ±Ã§
      // ---- GerÃ§ek zamanlÄ± otomatik yenileme istersen alttakileri aktif et:
      // database.ref("ogrenciler").on("value", ()=> refreshStudents());
      // database.ref("odevler").on("value",   ()=> refreshAssignments());
      // database.ref("haftalikDegerlendirme").on("value", ()=> refreshWeekly());
      // -----------------------------------------
      // Rapor alanÄ± tetikleyicileri
      document.getElementById('raporTipi').addEventListener('change', raporMesajiOlustur);
      document.getElementById('raporOgrenciSec').addEventListener('change', raporMesajiOlustur);
      // HaftalÄ±kta Ã¶ÄŸrenci deÄŸiÅŸince Ã¶dev seÃ§eneklerini dolduruyoruz (yukarÄ±da eklendi)
      // Filtre select deÄŸiÅŸince listeleri yeniden oluÅŸtur
      const odevFiltreSelect = document.getElementById('odevFiltreOgrenci');
      if (odevFiltreSelect) {
        odevFiltreSelect.addEventListener('change', () => {
          // Filtre deÄŸiÅŸtirildiÄŸinde sayfalama sÄ±fÄ±rlanÄ±r ve liste yeniden Ã§izilir
          odevCurrentPage = 1;
          odevListele();
        });
      }
      const haftalikFiltreSelect = document.getElementById('haftalikFiltreOgrenci');
      if (haftalikFiltreSelect) {
        haftalikFiltreSelect.addEventListener('change', () => {
          // Filtre deÄŸiÅŸince sayfa 1'den baÅŸlat
          haftalikCurrentPage = 1;
          haftalikKayitlariListele();
        });
      }
    });
  </script>
</body>
</html>
