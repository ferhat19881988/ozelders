<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ã–zel Ders Takip Sistemi</title>

  <!-- Bootstrap 5.3 (CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Icons (opsiyonel) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Fonts (Modern UI) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">


  <!-- QR ve Firebase -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>

    :root{
      --bg:#f6f8ff;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.10);
      --shadow:0 16px 44px rgba(15,23,42,.08);
      --shadow-sm:0 10px 26px rgba(15,23,42,.06);
      --radius:18px;
      --radius-sm:14px;
      --primary:#4f46e5;
      --primary-2:#6366f1;
      --focus:rgba(79,70,229,.15);
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      font-size: 16.5px;
      line-height: 1.55;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Daha ferah bir geniÅŸlik */
    @media (min-width: 1200px){
      .container{ max-width: 1120px; }
    }

    /* Ãœst bar */
    .navbar{
      background: rgba(255,255,255,.86)!important;
      border-bottom: 1px solid var(--border)!important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .navbar-brand{
      font-size: 1.125rem;
      letter-spacing: .2px;
    }
    .navbar-brand img{
      height: 36px;
      width: auto;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 8px 18px rgba(15,23,42,.10);
    }

    /* Sekmeler */
    .sticky-tabs{
      position: sticky;
      top: 0;
      z-index: 1020;
      background: rgba(246,248,255,.92);
      border-bottom: 1px solid var(--border);
      padding-top: .5rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #mainTabs{ gap: .5rem; flex-wrap: wrap; }
    .nav-pills .nav-link{
      border-radius: 999px;
      padding: .68rem 1.05rem;
      font-weight: 600;
      color: #334155;
      background: rgba(255,255,255,.70);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease, color .18s ease;
    }
    .nav-pills .nav-link:hover{
      background: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 14px 34px rgba(15,23,42,.08);
    }
    .nav-pills .nav-link.active{
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border-color: transparent;
      box-shadow: 0 18px 44px rgba(79,70,229,.22);
    }

    /* Kartlar */
    .app-card{
      background: rgba(255,255,255,.92);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* Form Ã¶ÄŸeleri */
    .form-label{
      font-weight: 600;
      color: #334155;
      margin-bottom: .35rem;
    }
    .form-control, .form-select, textarea{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(15,23,42,.12);
      padding: .72rem .92rem;
      background: rgba(255,255,255,.96);
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    textarea{ resize: vertical; }
    .form-control:focus, .form-select:focus, textarea:focus{
      border-color: rgba(79,70,229,.55);
      box-shadow: 0 0 0 .25rem var(--focus);
    }

    /* Butonlar */
    .btn{
      border-radius: 999px;
      padding: .62rem 1.05rem;
      font-weight: 600;
      letter-spacing: .1px;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(15,23,42,.10); }
    .btn:active{ transform: translateY(0); box-shadow: none; }
    .btn-sm{
      padding: .38rem .70rem;
      border-radius: 999px;
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: none;
    }
    .btn-primary:hover{ filter: brightness(.98); }

    /* Listeler */
    .list-fit .list-group-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: .6rem;
    }
    .list-group-item{
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow-sm);
      padding: 1rem 1.1rem;
      margin-bottom: .6rem;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .list-group-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 38px rgba(15,23,42,.08);
    }

    /* KÃ¼Ã§Ã¼k metinler */
    .small-muted{ font-size: .95rem; color: var(--muted); }

    /* AyraÃ§ */
    hr{
      border-top: 1px solid var(--border);
      opacity: 1;
    }

    /* QR alanÄ± */
    .qr-center{ display:flex; align-items:center; justify-content:center; min-height:240px; }

    /* Modal */
    .modal-content{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .modal-header, .modal-footer{
      border-color: var(--border);
    }

    /* Sayfalama */
    .pagination .page-link{
      border-radius: 999px;
      margin: 0 .16rem;
      border: 1px solid var(--border);
      color: #334155;
      background: rgba(255,255,255,.88);
    }
    .pagination .page-link:hover{
      background: #fff;
    }
    .pagination .page-item.active .page-link{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border-color: transparent;
    }

    /* Daha modern baÅŸlÄ±k Ã¶lÃ§ekleri */
    h2.h4{ font-size: 1.45rem; }
    h3.h5{ font-size: 1.15rem; }

  
    /* Logo bÃ¼yÃ¼tme modalÄ± */
    .brand-logo{ cursor:pointer; }
    #logoModal .modal-dialog{ max-width: 980px; }
    .logo-modal-img{
      max-width: 92vw;
      max-height: 80vh;
      width: auto;
      height: auto;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* HaftalÄ±k DeÄŸerlendirme Wizard */
    .wizard-shell{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      padding: 1.1rem 1.1rem 1rem;
    }
    .wizard-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .9rem;
    }
    .wizard-steps{
      display:flex;
      align-items:center;
      gap:.45rem;
      flex-wrap: wrap;
    }
    .wizard-chip{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.42rem .72rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.80);
      color:#334155;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      user-select:none;
    }
    .wizard-chip .num{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(79,70,229,.10);
      color: var(--primary);
      font-weight: 700;
      font-size: .95rem;
    }
    .wizard-chip.active{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color:#fff;
      border-color: transparent;
      box-shadow: 0 18px 44px rgba(79,70,229,.18);
    }
    .wizard-chip.active .num{
      background: rgba(255,255,255,.22);
      color:#fff;
    }
    .wizard-progress{
      flex: 1 1 260px;
      min-width: 220px;
    }
    .wizard-progress .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(15,23,42,.08);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .wizard-progress .progress-bar{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
    }
    .wizard-step{ display:none; }
    .wizard-step.active{ display:block; }

    .readonly-note{
      border: 1px dashed rgba(15,23,42,.18);
      background: rgba(255,255,255,.75);
    }
    .prewrap{ white-space: pre-wrap; word-break: break-word; }

    /* KayÄ±tlÄ± HaftalÄ±k DeÄŸerlendirmeler: kart gÃ¶rÃ¼nÃ¼mÃ¼ */
    .weekly-grid{ margin-top: .25rem; }
    .weekly-card{
      background: rgba(255,255,255,.94);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      height: 100%;
      overflow:hidden;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .weekly-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 44px rgba(15,23,42,.10);
    }
    .weekly-card .card-header{
      background: rgba(246,248,255,.65);
      border-bottom: 1px solid var(--border);
    }
    .weekly-meta{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: .75rem;
    }
    .weekly-title{
      font-weight: 700;
      letter-spacing: .1px;
      margin: 0;
    }
    .weekly-sub{
      color: var(--muted);
      font-size: .95rem;
      margin-top: .15rem;
    }
    .badge-soft{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.80);
      color:#334155;
      font-weight: 700;
      padding: .35rem .6rem;
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }
    .badge-soft.primary{
      background: rgba(79,70,229,.10);
      color: #3730a3;
      border-color: rgba(79,70,229,.18);
    }
    .badge-soft.warn{
      background: rgba(245,158,11,.12);
      color: #92400e;
      border-color: rgba(245,158,11,.20);
    }
    .badge-soft.danger{
      background: rgba(239,68,68,.10);
      color: #991b1b;
      border-color: rgba(239,68,68,.18);
    }
    .badge-soft.ok{
      background: rgba(34,197,94,.12);
      color: #166534;
      border-color: rgba(34,197,94,.20);
    }
    .weekly-kv{ display:flex; gap:.55rem; }
    .weekly-kv .k{ color: var(--muted); min-width: 132px; }
    @media (max-width: 575.98px){
      .weekly-kv{ flex-direction: column; gap:.15rem; }
      .weekly-kv .k{ min-width: 0; }
    }

  </style>

  <script>
    // Firebase yapÄ±landÄ±rma
    const firebaseConfig = {
      apiKey: "AIzaSyD4Ctf-F5BSU_4fHK2WgTQUj_okrzyI7OI",
      authDomain: "birebir-1df98.firebaseapp.com",
      databaseURL: "https://birebir-1df98-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "birebir-1df98",
      storageBucket: "birebir-1df98.firebasestorage.app",
      messagingSenderId: "145327250159",
      appId: "1:145327250159:web:f4d8be51e312f5552f591a",
      measurementId: "G-8CB54NS9QW"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" href="#">
      <img id="brandLogo" src="https://i.ibb.co/F4cDX7MX/logom.jpg" alt="Logo" height="32" class="rounded brand-logo" role="button" tabindex="0" />
      ğŸ“˜ Ã–zel Ders Takip Sistemi
    </a>
  </div>
</nav>


  <!-- Sekmeler -->
  <div class="sticky-tabs border-bottom">
    <div class="container">
      <ul class="nav nav-pills my-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-ogrenci" data-bs-toggle="pill" data-bs-target="#pnl-ogrenci" type="button" role="tab">
            <i class="bi bi-person"></i> Ã–ÄŸrenci KaydÄ±
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-haftalik" data-bs-toggle="pill" data-bs-target="#pnl-haftalik" type="button" role="tab">
            <i class="bi bi-calendar-week"></i> HaftalÄ±k DeÄŸerlendirme
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-rapor" data-bs-toggle="pill" data-bs-target="#pnl-rapor" type="button" role="tab">
            <i class="bi bi-whatsapp"></i> WhatsApp Rapor
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Ä°Ã§erik -->
  <div class="container my-4">
    <div class="tab-content">

      <!-- Ã–ÄRENCÄ° KAYIT -->
      <div class="tab-pane fade show active" id="pnl-ogrenci" role="tabpanel" aria-labelledby="tab-ogrenci">
        <div class="app-card p-4 p-md-5">
          <h2 class="h4 mb-4">ğŸ‘¤ Ã–ÄŸrenci KaydÄ±</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-6">
              <label class="form-label">Ã–ÄŸrenci AdÄ±</label>
              <input type="text" id="ogrenciAd" class="form-control" placeholder="Ã–rn: AyÅŸe YÄ±lmaz" />
            </div>
            <div class="col-md-6">
              <label class="form-label">SÄ±nÄ±f</label>
              <select id="ogrenciSinif" class="form-select">
                <option value="">SÄ±nÄ±f SeÃ§iniz</option>
                <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
                <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
              </select>
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary" onclick="ogrenciEkle()"><i class="bi bi-plus-circle"></i> Ã–ÄŸrenci Ekle</button>
              <button class="btn btn-outline-secondary" onclick="temizleInputlar()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
            </div>
          </div>

          <hr class="my-4" />

          <h3 class="h5 mb-3">ğŸ“‹ Ã–ÄŸrenci Listesi</h3>
          <div class="list-group list-fit" id="ogrenciListesi"></div>

          <hr class="my-4" />

          <h3 class="h5 mb-3">ğŸ“˜ Ã–dev Ekle</h3>
          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Ã–ÄŸrenci</label>
              <select id="odevOgrenci" class="form-select">
                <option value="">Ã–ÄŸrenci SeÃ§iniz</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Tarih</label>
              <input type="date" id="odevTarih" class="form-control"/>
            </div>
            <div class="col-12">
              <label class="form-label">Ã–dev Ä°Ã§eriÄŸi</label>
              <textarea id="odevIcerik" class="form-control" rows="3" placeholder="Ã–rn: Sayfa 45-47 problemler..."></textarea>
            </div>
            <div class="col-12 d-flex flex-wrap gap-2">
              <button class="btn btn-success" onclick="odevEkle()"><i class="bi bi-plus-circle"></i> Ã–dev Ekle</button>
              <button class="btn btn-outline-secondary" onclick="odevFormTemizle()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
              <button class="btn btn-outline-danger" onclick="tumOdevleriSil()"><i class="bi bi-trash"></i> TÃ¼m Ã–devleri Sil</button>
            </div>
          </div>

          <div class="mt-4">
            <h3 class="h6 text-uppercase text-muted">KayÄ±tlÄ± Ã–devler</h3>
            <!-- Ã–ÄŸrenci filtreleme alanÄ± -->
            <div class="row g-2 mb-3">
              <div class="col-md-4">
                <label class="form-label">Ã–ÄŸrenci Filtrele</label>
                <select id="odevFiltreOgrenci" class="form-select">
                  <option value="">TÃ¼mÃ¼</option>
                </select>
              </div>
            </div>
            <div id="odevListesi" class="list-group list-fit"></div>
          </div>
        </div>
      </div>

      
<!-- HAFTALIK DEÄERLENDÄ°RME -->
      <div class="tab-pane fade" id="pnl-haftalik" role="tabpanel" aria-labelledby="tab-haftalik">
        <div class="app-card p-4 p-md-5">
          <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
            <div>
              <h2 class="h4 mb-1">ğŸ“… HaftalÄ±k DeÄŸerlendirme</h2>
              <div class="small-muted">Daha hÄ±zlÄ± ve hatasÄ±z giriÅŸ iÃ§in adÄ±m adÄ±m (wizard) form</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-secondary" type="button" onclick="haftalikFormYenile()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
              <button class="btn btn-outline-danger" type="button" onclick="tumHaftalikKayitlariSil()"><i class="bi bi-trash"></i> TÃ¼m KayÄ±tlarÄ± Sil</button>
            </div>
          </div>

          <div class="wizard-shell">
            <div class="wizard-top">
              <div class="wizard-steps" id="weeklyWizardSteps">
                <div class="wizard-chip" data-step="1"><span class="num">1</span> SeÃ§im</div>
                <div class="wizard-chip" data-step="2"><span class="num">2</span> Bu Hafta</div>
                <div class="wizard-chip" data-step="3"><span class="num">3</span> Gelecek Hafta</div>
              </div>
              <div class="wizard-progress">
                <div class="progress" aria-label="Wizard ilerleme">
                  <div class="progress-bar" id="weeklyWizardBar" role="progressbar" style="width: 33%"></div>
                </div>
              </div>
            </div>

            <!-- STEP 1 -->
            <div class="wizard-step active" data-step="1">
              <div class="row g-3 form-row-gap">
                <div class="col-md-4">
                  <label class="form-label">Ã–ÄŸrenci</label>
                  <select id="haftaOgrenci" class="form-select">
                    <option value="">Ã–ÄŸrenci SeÃ§in</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <label class="form-label">GeÃ§en haftaki Ã¶dev</label>
                  <select id="haftaOdev" class="form-select">
                    <option value="">Ã–dev SeÃ§in</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Ã–dev Durumu</label>
                  <select id="odevDurumu" class="form-select">
                    <option value="">Ã–dev Durumu</option>
                    <option value="yapti">âœ… YaptÄ±</option>
                    <option value="yapmadi">âŒ YapmadÄ±</option>
                    <option value="eksik">âš ï¸ Eksik</option>
                    <option value="getirmedi">ğŸ“­ Getirmedi</option>
                  </select>
                </div>

                <div class="col-12">
                  <label class="form-label">SeÃ§ili Ã¶dev iÃ§eriÄŸi (tam metin)</label>
                  <textarea id="seciliOdevDetay" class="form-control readonly-note prewrap" rows="3" readonly placeholder="Ã–dev seÃ§tiÄŸinizde burada tam metin gÃ¶rÃ¼necek."></textarea>
                </div>

                <div class="col-12 d-flex justify-content-end gap-2 flex-wrap">
                  <button class="btn btn-primary" type="button" onclick="weeklyWizardNext()">
                    Devam <i class="bi bi-arrow-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="wizard-step" data-step="2">
              <div class="row g-3 form-row-gap">
                <div class="col-12">
                  <label class="form-label">Bu hafta iÅŸlenen konu</label>
                  <textarea id="buHaftaKonu" class="form-control prewrap" rows="3" placeholder="Bu hafta iÅŸlenen kazanÄ±mlar / konu baÅŸlÄ±klarÄ±..."></textarea>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Motivasyon (1â€‘10)</label>
                  <input type="number" id="haftaMotivasyon" class="form-control" min="1" max="10" />
                </div>
                <div class="col-md-9">
                  <label class="form-label">Genel Ders Durumu</label>
                  <textarea id="haftaMotivasyonAciklama" class="form-control prewrap" rows="2" placeholder="KÄ±sa deÄŸerlendirme / odak / eksik kazanÄ±mlar..."></textarea>
                </div>

                <div class="col-12 d-flex justify-content-between gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary" type="button" onclick="weeklyWizardPrev()">
                    <i class="bi bi-arrow-left"></i> Geri
                  </button>
                  <button class="btn btn-primary" type="button" onclick="weeklyWizardNext()">
                    Devam <i class="bi bi-arrow-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="wizard-step" data-step="3">
              <div class="row g-3 form-row-gap">
                <div class="col-md-7">
                  <label class="form-label">Gelecek haftanÄ±n Ã¶devi</label>
                  <textarea id="gelecekHaftaOdev" class="form-control prewrap" rows="3" placeholder="Tam metin Ã¶dev (sayfa / soru / kaynak vb.)"></textarea>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Teslim Tarihi</label>
                  <input type="date" id="gelecekTarih" class="form-control" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Gelecek hafta konusu</label>
                  <textarea id="gelecekHaftaKonu" class="form-control prewrap" rows="3" placeholder="KÄ±sa konu baÅŸlÄ±ÄŸÄ± / kazanÄ±mlar"></textarea>
                </div>

                <div class="col-12 d-flex justify-content-between gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary" type="button" onclick="weeklyWizardPrev()">
                    <i class="bi bi-arrow-left"></i> Geri
                  </button>
                  <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-secondary" type="button" onclick="haftalikFormYenile()">
                      <i class="bi bi-arrow-clockwise"></i> Formu SÄ±fÄ±rla
                    </button>
                    <button class="btn btn-primary" type="button" onclick="haftalikVeriyiEkle()">
                      <i class="bi bi-plus-circle"></i> KaydÄ± OluÅŸtur
                    </button>
                  </div>
                </div>

                <p id="haftaDurumMesaji" class="mt-3 small-muted mb-0"></p>
              </div>
            </div>
          </div>

          <hr class="my-4" />

          <div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-2">
            <div>
              <h3 class="h5 mb-1">ğŸ“‹ KayÄ±tlÄ± HaftalÄ±k DeÄŸerlendirmeler</h3>
              <div id="haftalikOzet" class="small-muted"></div>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-auto">
                <label class="form-label mb-1">Ã–ÄŸrenci Filtrele</label>
                <select id="haftalikFiltreOgrenci" class="form-select">
                  <option value="">TÃ¼mÃ¼</option>
                </select>
              </div>
            </div>
          </div>

          <div id="haftalikKayitListesi" class="row g-3 weekly-grid"></div>
        </div>
      </div>

<!-- WHATSAPP RAPOR -->
      <div class="tab-pane fade" id="pnl-rapor" role="tabpanel" aria-labelledby="tab-rapor">
        <div class="app-card p-4 p-md-5">
          <h2 class="h4 mb-4">ğŸ“¤ WhatsApp RaporlarÄ±</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Rapor TÃ¼rÃ¼</label>
              <select id="raporTipi" class="form-select" onchange="raporTipiDegisti()">
                <option value="haftalik">ğŸ“… HaftalÄ±k Rapor</option>
                <option value="aylik">ğŸ“† AylÄ±k Rapor</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Ã–ÄŸrenci SeÃ§</label>
              <select id="raporOgrenciSec" class="form-select"></select>
            </div>

            <div class="col-12">
              <label class="form-label">OluÅŸturulan Mesaj</label>
              <textarea id="raporMesaj" rows="10" class="form-control"></textarea>
            </div>

            <div class="col-12 d-flex flex-wrap gap-2">
              <button class="btn btn-success" onclick="whatsappMesajGonder()"><i class="bi bi-send"></i> GÃ¶nder</button>
              <button class="btn btn-outline-secondary" onclick="raporFormYenile()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
              <button class="btn btn-outline-dark" onclick="qrKodModalAc()"><i class="bi bi-qr-code"></i> QR Kod ile GÃ¶ster</button>
            </div>
          </div>
          <div id="qrCanvasContainer" class="qr-center mt-3"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODALS -->

  <!-- Ã–ÄŸrenci GÃ¼ncelle Modal -->
  <div class="modal fade" id="ogrenciGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ Ã–ÄŸrenci GÃ¼ncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ad</label>
            <input type="text" id="guncelleAd" class="form-control"/>
          </div>
          <div class="mb-3">
            <label class="form-label">SÄ±nÄ±f</label>
            <select id="guncelleSinif" class="form-select">
              <option value="">SÄ±nÄ±f SeÃ§iniz</option>
              <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
              <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button class="btn btn-primary" onclick="ogrenciGuncelleKaydet()"><i class="bi bi-save"></i> Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ã–dev GÃ¼ncelle Modal -->
  <div class="modal fade" id="odevGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ Ã–dev GÃ¼ncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Tarih</label>
            <input type="date" id="guncelleOdevTarih" class="form-control"/>
          </div>
          <div class="mb-3">
            <label class="form-label">Ä°Ã§erik</label>
            <textarea id="guncelleOdevIcerik" rows="4" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button class="btn btn-primary" onclick="odevGuncelleKaydet()"><i class="bi bi-save"></i> Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HaftalÄ±k KayÄ±t GÃ¼ncelle Modal -->
  <div class="modal fade" id="haftalikGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ HaftalÄ±k KayÄ±t GÃ¼ncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="guncelleHaftaOgrenci" class="form-control mb-2" placeholder="Ã–ÄŸrenci AdÄ±">
          <input type="text" id="guncelleHaftaKonu" class="form-control mb-2" placeholder="Bu hafta konusu">
          <input type="text" id="guncelleHaftaOdev" class="form-control mb-2" placeholder="Ã–dev">
          <input type="text" id="guncelleHaftaDurum" class="form-control mb-2" placeholder="Ã–dev durumu (yapti, yapmadi...)">
          <input type="date" id="guncelleHaftaTarih" class="form-control mb-2">
          <input type="text" id="guncelleGelecekKonu" class="form-control mb-2" placeholder="Gelecek hafta konusu">
          <input type="text" id="guncelleGelecekOdev" class="form-control mb-2" placeholder="Gelecek hafta Ã¶devi">

          <!-- Motivasyon ve aÃ§Ä±klama gÃ¼ncelleme alanlarÄ± -->
          <input type="number" id="guncelleHaftaMotivasyon" class="form-control mb-2" min="1" max="10" placeholder="Motivasyon (1-10)">
          <textarea id="guncelleHaftaMotivasyonAciklama" class="form-control mb-2" placeholder="Genel ders durumu" rows="2"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button class="btn btn-primary" onclick="haftalikKaydiGuncelleKaydet()"><i class="bi bi-save"></i> Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Kod Modal -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ“± WhatsApp MesajÄ± iÃ§in QR Kod</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div id="qrModalCanvas" class="qr-center"></div>
          <p class="small-muted text-center mt-3">QRâ€™Ä± telefon kameranÄ±zla okutarak WhatsApp mesajÄ±nÄ± aÃ§abilirsiniz.</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Logo BÃ¼yÃ¼tme Modal -->
  <div class="modal fade" id="logoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-3">
          <img id="logoModalImg" class="logo-modal-img" src="https://i.ibb.co/F4cDX7MX/logom.jpg" alt="Logo (BÃ¼yÃ¼k)" />
          <div class="small-muted mt-2">Kapatmak iÃ§in herhangi bir yere tÄ±klayÄ±n.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5.3 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ YardÄ±mcÄ±lar ************/
    let guncellenecekId = null;            // Ã–ÄŸrenci gÃ¼ncelle
    let guncellenecekOdevKey = null;       // Ã–dev gÃ¼ncelle
    let guncellenecekHaftaKey = null;      // HaftalÄ±k kayÄ±t gÃ¼ncelle

    const bsModal = (id) => bootstrap.Modal.getOrCreateInstance(document.getElementById(id));

    const durumIcon = (durum) => {
      switch ((durum || '').toLowerCase()) {
        case 'yapti': return 'âœ… YaptÄ±';
        case 'yapmadi': return 'âŒ YapmadÄ±';
        case 'eksik': return 'âš ï¸ Eksik';
        case 'getirmedi': return 'ğŸ“­ Getirmedi';
        default: return 'â– Bilgi Yok';
      }
    };

    // Tarih formatlama yardÄ±mcÄ± fonksiyonu
    // Bu fonksiyon bir tarih stringini (YYYY-MM-DD veya ISO format) alÄ±r ve
    // gÃ¼n.ay.yÄ±l (01.11.2025) formatÄ±nda geri dÃ¶ndÃ¼rÃ¼r. GeÃ§ersiz tarihler
    // olduÄŸu gibi dÃ¶ndÃ¼rÃ¼lÃ¼r. Bu fonksiyon liste ve rapor gÃ¶rÃ¼nÃ¼mÃ¼nde
    // tarihleri kullanÄ±cÄ±ya daha okunur ÅŸekilde gÃ¶stermek iÃ§in kullanÄ±lÄ±r.
    function formatTurkishDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      // EÄŸer geÃ§erli bir tarih deÄŸilse veya parse edilemiyorsa stringi aynen dÃ¶ndÃ¼r.
      if (isNaN(date.getTime())) return dateStr;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    // Sayfalama iÃ§in global deÄŸiÅŸkenler. Her liste iÃ§in mevcut sayfayÄ± tutar.
    // Bir filtre deÄŸiÅŸtiÄŸinde veya veri yeniden yÃ¼klendiÄŸinde bu deÄŸiÅŸkenler
    // gerektiÄŸinde gÃ¼ncellenir.
    let odevCurrentPage = 1;
    let haftalikCurrentPage = 1;

    // --- Ortak yenile yardÄ±mcÄ±larÄ± ---
    function refreshStudents() {
      ogrenciListele();
      doldurOgrenciSecimi();       // Ã–dev ekleme Ã¶ÄŸrenci select
      doldurHaftaOgrenciListesi(); // HaftalÄ±k deÄŸerlendirme Ã¶ÄŸrenci select
      raporOgrenciSecDoldur();     // Rapor Ã¶ÄŸrenci select
      // Ã–ÄŸrenci deÄŸiÅŸikliklerinde filtreleri gÃ¼ncelle
      doldurOdevFiltre();
      doldurHaftalikFiltre();
    }
    function refreshAssignments() {
      odevListele();
    }
    function refreshWeekly() {
      haftalikKayitlariListele();
    }
    function refreshAll() {
      refreshStudents();
      refreshAssignments();
      refreshWeekly();
      // Rapor seÃ§imi yapÄ±lmÄ±ÅŸsa mesajÄ± tazele
      const sel = document.getElementById('raporOgrenciSec');
      if (sel && sel.value) { raporMesajiOlustur(); }
    }

    // Ã–ÄŸrenci - dizi olarak sakla / getir
    function getOgrenciler(cb){
      database.ref("ogrenciler").once("value").then(s => {
        const val = s.val();
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : (Object.values(val || {}));
        cb(arr || []);
      }).catch(_ => cb([]));
    }
    function setOgrenciler(arr){
      return database.ref("ogrenciler").set(arr || []);
    }

    /************ Ã–ÄRENCÄ° ************/
    function temizleInputlar(){
      document.getElementById('ogrenciAd').value = '';
      document.getElementById('ogrenciSinif').value = '';
    }

    function ogrenciEkle(){
      const ad = document.getElementById('ogrenciAd').value.trim();
      const sinif = document.getElementById('ogrenciSinif').value;
      if(!ad || !sinif){ alert("LÃ¼tfen Ã¶ÄŸrenci adÄ± ve sÄ±nÄ±f seÃ§in."); return; }

      getOgrenciler(ogrenciler=>{
        const id = Date.now();
        const yeni = { id, ad, sinif };
        const guncel = [...ogrenciler, yeni];
        setOgrenciler(guncel).then(()=>{
          alert("âœ… Ã–ÄŸrenci eklendi.");
          refreshStudents(); // Ã¶nemli
          temizleInputlar();
        }).catch(()=> alert("âŒ Ã–ÄŸrenci eklenemedi."));
      });
    }

    function ogrenciSil(id){
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.filter(o=>o.id !== id);
        setOgrenciler(guncel).then(()=>{
          refreshStudents(); // Ã¶nemli
        });
      });
    }

    function ogrenciGuncelleAc(id){
      getOgrenciler(ogrenciler=>{
        const o = ogrenciler.find(x=>x.id===id);
        if(!o) return;
        guncellenecekId = id;
        document.getElementById('guncelleAd').value = o.ad || '';
        document.getElementById('guncelleSinif').value = o.sinif || '';
        bsModal('ogrenciGuncelleModal').show();
      });
    }

    function ogrenciGuncelleKaydet(){
      const ad = document.getElementById('guncelleAd').value.trim();
      const sinif = document.getElementById('guncelleSinif').value;
      if(!guncellenecekId){ alert("GÃ¼ncellenecek Ã¶ÄŸrenci yok."); return; }
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.map(o=> o.id===guncellenecekId ? ({...o, ad, sinif}) : o);
        setOgrenciler(guncel).then(()=>{
          bsModal('ogrenciGuncelleModal').hide();
          refreshStudents(); // Ã¶nemli
          alert("âœ… Ã–ÄŸrenci gÃ¼ncellendi.");
        });
      });
    }

    function ogrenciListele(){
      const liste = document.getElementById('ogrenciListesi');
      liste.innerHTML = '<div class="text-center text-muted py-3">YÃ¼kleniyor...</div>';
      getOgrenciler(ogrenciler=>{
        liste.innerHTML = '';
        if(!ogrenciler.length){
          liste.innerHTML = '<div class="text-center text-muted py-3">KayÄ±tlÄ± Ã¶ÄŸrenci yok.</div>';
          return;
        }
        ogrenciler.forEach(o=>{
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.innerHTML = `
            <div>
              <div class="fw-medium">${o.ad}</div>
              <div class="small-muted">${o.sinif}</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary" onclick="ogrenciGuncelleAc(${o.id})"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="ogrenciSil(${o.id})"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
      });
    }

    /************ Ã–DEVLER ************/
    function doldurOgrenciSecimi(){
      const sel = document.getElementById('odevOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
    }

    function odevListele(){
      const liste = document.getElementById('odevListesi');
      liste.innerHTML = '';
      // Sayfalama kapsayÄ±cÄ±sÄ±nÄ± veya mevcut nav'Ä± bul. EÄŸer yoksa oluÅŸtur.
      let paginationContainer = document.getElementById('odevPagination');
      if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'odevPagination';
        paginationContainer.className = 'mt-3';
        liste.parentNode.appendChild(paginationContainer);
      }
      // Veriyi Firebase'den alÄ±p sayfalama ve sÄ±ralama uygula.
      database.ref("odevler").once("value").then(snap => {
        const val = snap.val() || {};
        const allEntries = Object.entries(val);
        const filtreSel = document.getElementById('odevFiltreOgrenci');
        const filtreDeger = filtreSel ? filtreSel.value : '';
        // Filtrele
        let filtered = allEntries.filter(([_, odev]) => {
          return !filtreDeger || odev.ogrenci === filtreDeger;
        });
        // EÄŸer hiÃ§ veri yoksa uygun mesajÄ± gÃ¶ster ve sayfalama temizle.
        if (filtered.length === 0) {
          liste.innerHTML = '<div class="text-center text-muted py-3">' +
            (allEntries.length === 0 ? 'KayÄ±tlÄ± Ã¶dev yok.' : 'SeÃ§ilen Ã¶ÄŸrenci iÃ§in Ã¶dev bulunamadÄ±.') +
            '</div>';
          paginationContainer.innerHTML = '';
          return;
        }
        // Tarihe gÃ¶re azalan sÄ±rala
        filtered.sort((a, b) => {
          const da = new Date(a[1].tarih);
          const db = new Date(b[1].tarih);
          return db - da;
        });
        // Sayfalama hesapla
        const pageSize = 10;
        const totalPages = Math.ceil(filtered.length / pageSize);
        // EÄŸer mevcut sayfa totalPages'den bÃ¼yÃ¼kse son sayfaya ayarla
        if (odevCurrentPage > totalPages) odevCurrentPage = totalPages;
        if (odevCurrentPage < 1) odevCurrentPage = 1;
        const startIdx = (odevCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageEntries = filtered.slice(startIdx, endIdx);
        // Liste Ã¶ÄŸelerini oluÅŸtur
        pageEntries.forEach(([key, odev]) => {
          const item = document.createElement('div');
          item.className = 'list-group-item d-flex align-items-start';
          item.innerHTML = `
            <div class="me-2 flex-grow-1">
              <div class="fw-medium">${odev.ogrenci || 'Ã–ÄŸrenci Yok'} â€” ${formatTurkishDate(odev.tarih) || 'Tarih Yok'}</div>
              <div class="small-muted">${odev.konu || odev.icerik || 'Ä°Ã§erik Yok'}</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary" onclick="odevGuncelleModalAc('${key}')"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="odevSil('${key}')"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
        // Sayfalama kontrollerini oluÅŸtur
        paginationContainer.innerHTML = '';
        if (totalPages > 1) {
          const nav = document.createElement('nav');
          const ul = document.createElement('ul');
          ul.className = 'pagination justify-content-center';
          // Ã–nceki butonu
          const prevLi = document.createElement('li');
          prevLi.className = 'page-item' + (odevCurrentPage === 1 ? ' disabled' : '');
          const prevLink = document.createElement('a');
          prevLink.className = 'page-link';
          prevLink.href = '#';
          prevLink.innerText = 'Â«';
          prevLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (odevCurrentPage > 1) {
              odevCurrentPage--;
              odevListele();
            }
          });
          prevLi.appendChild(prevLink);
          ul.appendChild(prevLi);
          // Sayfa numaralarÄ±
          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === odevCurrentPage ? ' active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.addEventListener('click', (e) => {
              e.preventDefault();
              if (i !== odevCurrentPage) {
                odevCurrentPage = i;
                odevListele();
              }
            });
            li.appendChild(a);
            ul.appendChild(li);
          }
          // Sonraki butonu
          const nextLi = document.createElement('li');
          nextLi.className = 'page-item' + (odevCurrentPage === totalPages ? ' disabled' : '');
          const nextLink = document.createElement('a');
          nextLink.className = 'page-link';
          nextLink.href = '#';
          nextLink.innerText = 'Â»';
          nextLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (odevCurrentPage < totalPages) {
              odevCurrentPage++;
              odevListele();
            }
          });
          nextLi.appendChild(nextLink);
          ul.appendChild(nextLi);
          nav.appendChild(ul);
          paginationContainer.appendChild(nav);
        }
      });
    }

    function odevFormTemizle(){
      document.getElementById('odevOgrenci').value = '';
      document.getElementById('odevTarih').value = '';
      document.getElementById('odevIcerik').value = '';
    }

    function pushOdev(odev){
      const ref = database.ref("odevler").push();
      return ref.set(odev);
    }

    function odevEkle(){
      const ogrenci = document.getElementById('odevOgrenci').value;
      const konu = (document.getElementById('odevIcerik').value || '').trim();
      const tarih = document.getElementById('odevTarih').value;
      if(!ogrenci || !konu || !tarih){ alert("Ã–ÄŸrenci, konu ve tarih boÅŸ bÄ±rakÄ±lamaz."); return; }
      pushOdev({ogrenci, konu, tarih}).then(()=>{
        alert("âœ… Ã–dev eklendi.");
        refreshAssignments(); // Ã¶nemli
        odevFormTemizle();
      }).catch(()=> alert("âŒ Ã–dev eklenemedi."));
    }

    function odevGuncelleModalAc(key){
      database.ref("odevler/"+key).once("value").then(s=>{
        const o = s.val(); if(!o) return;
        guncellenecekOdevKey = key;
        document.getElementById('guncelleOdevTarih').value = o.tarih || '';
        document.getElementById('guncelleOdevIcerik').value = o.konu || o.icerik || '';
        bsModal('odevGuncelleModal').show();
      });
    }

    function odevGuncelleKaydet(){
      if(!guncellenecekOdevKey){ alert("GÃ¼ncellenecek Ã¶dev yok."); return; }
      const tarih = document.getElementById('guncelleOdevTarih').value;
      const konu  = document.getElementById('guncelleOdevIcerik').value.trim();
      if(!tarih || !konu){ alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun."); return; }
      database.ref("odevler/"+guncellenecekOdevKey).update({tarih, konu}).then(()=>{
        bsModal('odevGuncelleModal').hide();
        refreshAssignments(); // Ã¶nemli
        alert("âœ… Ã–dev gÃ¼ncellendi.");
      }).catch(()=> alert("âŒ Ã–dev gÃ¼ncellenemedi."));
    }

    function odevSil(key){
      if(!confirm("Bu Ã¶devi silmek istediÄŸinize emin misiniz?")) return;
      database.ref("odevler/"+key).remove().then(()=>{
        refreshAssignments(); // Ã¶nemli
      });
    }

    function tumOdevleriSil(){
      if(!confirm("TÃ¼m Ã¶devleri silmek istediÄŸinize emin misiniz?")) return;
      database.ref("odevler").remove().then(()=>{
        refreshAssignments(); // Ã¶nemli
      });
    }

    /************ HAFTALIK ************/

    // Wizard (HaftalÄ±k) - adÄ±m yÃ¶netimi
    let weeklyWizardStep = 1;

    function weeklyWizardSyncUI(){
      const steps = Array.from(document.querySelectorAll('.wizard-step'));
      const chips = Array.from(document.querySelectorAll('#weeklyWizardSteps .wizard-chip'));
      steps.forEach(el => el.classList.toggle('active', parseInt(el.dataset.step) === weeklyWizardStep));
      chips.forEach(chip => chip.classList.toggle('active', parseInt(chip.dataset.step) === weeklyWizardStep));

      const bar = document.getElementById('weeklyWizardBar');
      if (bar){
        const pct = Math.round((weeklyWizardStep / 3) * 100);
        bar.style.width = pct + '%';
        bar.setAttribute('aria-valuenow', String(pct));
      }
    }

    function weeklyWizardGo(step){
      const s = Math.max(1, Math.min(3, parseInt(step || 1)));
      weeklyWizardStep = s;
      weeklyWizardSyncUI();
      // KullanÄ±cÄ± deneyimi: adÄ±m deÄŸiÅŸiminde Ã¼stteki karta kaydÄ±r
      const shell = document.querySelector('.wizard-shell');
      if (shell) shell.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function weeklyWizardNext(){
      // Hafif doÄŸrulama: 1. adÄ±mda Ã¶ÄŸrenci seÃ§ilmediyse ilerletme
      if (weeklyWizardStep === 1){
        const ogr = document.getElementById('haftaOgrenci')?.value;
        if (!ogr){ alert('LÃ¼tfen Ã¶nce Ã¶ÄŸrenci seÃ§in.'); return; }
      }
      weeklyWizardGo(weeklyWizardStep + 1);
    }

    function weeklyWizardPrev(){
      weeklyWizardGo(weeklyWizardStep - 1);
    }

    function haftalikFormYenile(){
      // Form alanlarÄ±nÄ± temizle
      const ids = ['haftaOgrenci','haftaOdev','odevDurumu','buHaftaKonu','gelecekHaftaOdev','gelecekTarih','gelecekHaftaKonu','haftaMotivasyon','haftaMotivasyonAciklama'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if (el.tagName === 'SELECT') el.value = '';
        else el.value = '';
      });

      const detay = document.getElementById('seciliOdevDetay');
      if (detay){
        detay.value = '';
        detay.style.height = '';
      }

      const msgEl = document.getElementById('haftaDurumMesaji');
      if (msgEl) msgEl.innerText = '';

      // Wizard'Ä± ilk adÄ±ma al
      weeklyWizardGo(1);

      // Ã–dev seÃ§eneklerini sÄ±fÄ±rla
      const sel = document.getElementById('haftaOdev');
      if (sel) sel.innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
    }

    function updateSelectedHomeworkDetail(){
      const sel = document.getElementById('haftaOdev');
      const out = document.getElementById('seciliOdevDetay');
      if(!sel || !out) return;
      out.value = sel.value || '';
      // Otomatik yÃ¼kseklik (tam metin rahat gÃ¶rÃ¼nsÃ¼n)
      out.style.height = 'auto';
      out.style.height = Math.min(out.scrollHeight, 360) + 'px';
    }


    function doldurHaftaOgrenciListesi(){
      const sel = document.getElementById('haftaOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§in</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
    }

    // --- Filtre selectlerini doldurur ---
    function doldurOdevFiltre(){
      const sel = document.getElementById('odevFiltreOgrenci');
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      getOgrenciler(arr=>{
        (arr||[]).forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad;
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        if(prev) sel.value = prev;
      });
    }

    function doldurHaftalikFiltre(){
      const sel = document.getElementById('haftalikFiltreOgrenci');
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      getOgrenciler(arr=>{
        (arr||[]).forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad;
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
        if(prev) sel.value = prev;
      });
    }

    document.getElementById('haftaOgrenci').addEventListener('change', function(){
      const secili = this.value;
      const sel = document.getElementById('haftaOdev');
      sel.innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
      const detay = document.getElementById('seciliOdevDetay');
      if (detay){ detay.value = ''; detay.style.height = ''; }

      if(!secili) return;

      database.ref("odevler").once("value").then(s=>{
        const val = s.val() || {};
        Object.entries(val)
          .map(([key, o]) => ({ key, ...(o||{}) }))
          .filter(o => o.ogrenci === secili)
          .sort((a, b) => new Date(b.tarih) - new Date(a.tarih))
          .forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.konu || o.icerik || '';
            opt.dataset.key = o.key || '';
            const tarihStr = formatTurkishDate(o.tarih);
            // Select satÄ±rÄ±nda okunabilir, kÄ±sa gÃ¶sterim; tam metin altta gÃ¶sterilir
            const shortText = (opt.value || '').length > 70 ? (opt.value.slice(0, 70) + 'â€¦') : (opt.value || 'Ä°Ã§erik Yok');
            opt.textContent = `${tarihStr} - ${shortText}`;
            sel.appendChild(opt);
          });

        // Ã–dev select deÄŸiÅŸince tam metni gÃ¶ster
        sel.removeEventListener('change', updateSelectedHomeworkDetail);
        sel.addEventListener('change', updateSelectedHomeworkDetail);
      });
    });

      });
    });

    
    function haftalikVeriyiEkle(){
      const ogrenci = document.getElementById('haftaOgrenci').value;

      const odevSelEl = document.getElementById('haftaOdev');
      const odev = odevSelEl ? (odevSelEl.value || '') : '';
      const odevKaynakKey = (odevSelEl && odevSelEl.selectedOptions && odevSelEl.selectedOptions[0])
        ? (odevSelEl.selectedOptions[0].dataset.key || '')
        : '';

      const durum   = document.getElementById('odevDurumu').value;
      const konu    = document.getElementById('buHaftaKonu').value.trim();
      const gelecekOdev = document.getElementById('gelecekHaftaOdev').value.trim();
      const tarih   = document.getElementById('gelecekTarih').value;
      const gelecekKonu = document.getElementById('gelecekHaftaKonu').value.trim();

      // Motivasyon puanÄ± ve aÃ§Ä±klamasÄ±
      const motivasyonInput = document.getElementById('haftaMotivasyon');
      let motivasyon = 0;
      if (motivasyonInput && motivasyonInput.value) {
        motivasyon = parseInt(motivasyonInput.value);
        if (isNaN(motivasyon) || motivasyon < 0) motivasyon = 0;
      }
      const motivasyonAciklama = (document.getElementById('haftaMotivasyonAciklama')?.value || '').trim();

      if(!ogrenci || !tarih){
        alert("ğŸš« Ã–ÄŸrenci ve teslim tarihi boÅŸ bÄ±rakÄ±lamaz.");
        weeklyWizardGo(1);
        return;
      }

      const zaman = new Date().toISOString();

      // Gelecek haftanÄ±n Ã¶devi -> Ã–devler listesine de kaydedilir ve key iliÅŸkilendirilir
      const haftalikRef = database.ref("haftalikDegerlendirme").push();
      const odevRef     = database.ref("odevler").push();

      const haftalikKayit = {
        ogrenci,
        odev,
        odevKaynakKey,   // geÃ§miÅŸ Ã¶dev seÃ§imi (varsa)
        durum,
        konu,
        gelecekOdev,
        tarih,
        gelecekKonu,
        zaman,
        motivasyon,
        motivasyonAciklama,
        odevKey: odevRef.key // gelecek Ã¶dev kaydÄ± ile iliÅŸki
      };

      const odevKaydi = { ogrenci, konu: gelecekOdev, tarih };

      Promise.all([odevRef.set(odevKaydi), haftalikRef.set(haftalikKayit)]).then(()=>{
        const msgEl = document.getElementById('haftaDurumMesaji');
        if (msgEl) msgEl.innerText = 'âœ… KayÄ±t ve Ã¶dev baÅŸarÄ±yla eklendi.';
        refreshWeekly();
        refreshAssignments();
        // Wizard'Ä± ve formu sÄ±fÄ±rla
        haftalikFormYenile();
      }).catch(()=>{
        alert("âš ï¸ Veri eklenirken hata oluÅŸtu.");
      });
    }

    
    function haftalikKayitlariListele(){
      const liste = document.getElementById('haftalikKayitListesi');
      liste.innerHTML = '';

      // Sayfalama kapsayÄ±cÄ±sÄ±nÄ± bul veya oluÅŸtur
      let paginationContainer = document.getElementById('haftalikPagination');
      if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'haftalikPagination';
        paginationContainer.className = 'mt-3';
        liste.parentNode.appendChild(paginationContainer);
      }

      const statusBadgeClass = (durum) => {
        const d = (durum || '').toLowerCase();
        if (d === 'yapti') return 'ok';
        if (d === 'yapmadi') return 'danger';
        if (d === 'eksik' || d === 'getirmedi') return 'warn';
        return 'primary';
      };

      database.ref("haftalikDegerlendirme").once("value").then(s => {
        const val = s.val() || {};
        const filtreSel = document.getElementById('haftalikFiltreOgrenci');
        const filtreDeger = filtreSel ? filtreSel.value : '';

        const entries = Object.entries(val);
        if (entries.length === 0) {
          liste.innerHTML = '<div class="col-12"><div class="text-center text-muted py-3">KayÄ±t bulunamadÄ±.</div></div>';
          paginationContainer.innerHTML = '';
          const ozetEl = document.getElementById('haftalikOzet');
          if (ozetEl) ozetEl.innerText = '';
          return;
        }

        let filtered = entries.filter(([_, veri]) => !filtreDeger || veri.ogrenci === filtreDeger);

        if (filtered.length === 0) {
          liste.innerHTML = '<div class="col-12"><div class="text-center text-muted py-3">SeÃ§ilen Ã¶ÄŸrenci iÃ§in kayÄ±t bulunamadÄ±.</div></div>';
          paginationContainer.innerHTML = '';
          const ozetEl = document.getElementById('haftalikOzet');
          if (ozetEl) ozetEl.innerText = '';
          return;
        }

        // Tarihe gÃ¶re azalan sÄ±rala (teslim tarihi varsa onu, yoksa zaman)
        filtered.sort((a, b) => {
          const da = new Date(a[1].tarih || a[1].zaman);
          const db = new Date(b[1].tarih || b[1].zaman);
          return db - da;
        });

        // Sayfalama
        const pageSize = 9; // kart gÃ¶rÃ¼nÃ¼mÃ¼nde daha dengeli
        const totalPages = Math.ceil(filtered.length / pageSize);
        if (haftalikCurrentPage > totalPages) haftalikCurrentPage = totalPages;
        if (haftalikCurrentPage < 1) haftalikCurrentPage = 1;
        const startIdx = (haftalikCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageEntries = filtered.slice(startIdx, endIdx);

        // KartlarÄ± oluÅŸtur
        pageEntries.forEach(([key, veri]) => {
          const col = document.createElement('div');
          col.className = 'col-12 col-md-6 col-lg-4';

          const tarihGoster = formatTurkishDate(veri.tarih || veri.zaman) || '';
          const durumText = durumIcon(veri.durum);
          const badgeCls = statusBadgeClass(veri.durum);

          const mot = parseInt(veri.motivasyon) || 0;
          const motText = mot ? `${mot}/10` : 'Bilgi Yok';
          const motAcik = (veri.motivasyonAciklama || '').trim();

          col.innerHTML = `
            <div class="card weekly-card">
              <div class="card-header p-3">
                <div class="weekly-meta">
                  <div class="me-2">
                    <div class="weekly-title">${veri.ogrenci || '???'}</div>
                    <div class="weekly-sub">${tarihGoster}</div>
                  </div>
                  <div class="d-flex flex-column align-items-end gap-2">
                    <span class="badge-soft ${badgeCls}">${durumText}</span>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-primary" onclick='haftalikKaydiGuncelle("${key}")' title="DÃ¼zenle"><i class="bi bi-pencil-square"></i></button>
                      <button class="btn btn-sm btn-outline-danger" onclick='haftalikKaydiSil("${key}")' title="Sil"><i class="bi bi-trash"></i></button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card-body p-3">
                <div class="weekly-kv mb-2">
                  <div class="k">Bu hafta konusu</div>
                  <div class="v prewrap">${(veri.konu || 'â€”')}</div>
                </div>

                <div class="weekly-kv mb-2">
                  <div class="k">GeÃ§en Ã¶dev</div>
                  <div class="v prewrap">${(veri.odev || 'â€”')}</div>
                </div>

                <hr class="my-3"/>

                <div class="weekly-kv mb-2">
                  <div class="k">Gelecek Ã¶dev</div>
                  <div class="v prewrap">${(veri.gelecekOdev || 'â€”')}</div>
                </div>

                <div class="weekly-kv mb-2">
                  <div class="k">Teslim</div>
                  <div class="v">${veri.tarih ? formatTurkishDate(veri.tarih) : 'â€”'}</div>
                </div>

                <div class="weekly-kv">
                  <div class="k">Gelecek konu</div>
                  <div class="v prewrap">${(veri.gelecekKonu || 'â€”')}</div>
                </div>

                <hr class="my-3"/>

                <div class="weekly-kv mb-2">
                  <div class="k">Motivasyon</div>
                  <div class="v">${motText}</div>
                </div>
                <div class="weekly-kv">
                  <div class="k">Genel durum</div>
                  <div class="v prewrap">${motAcik || 'â€”'}</div>
                </div>
              </div>
            </div>
          `;
          liste.appendChild(col);
        });

        // Ã–zet
        const ozetEl = document.getElementById('haftalikOzet');
        if (ozetEl) {
          ozetEl.innerText = filtreDeger ? `Toplam ${filtered.length} ders kaydÄ± bulundu.` : '';
        }

        // Sayfalama kontrolleri
        paginationContainer.innerHTML = '';
        if (totalPages > 1) {
          const nav = document.createElement('nav');
          const ul = document.createElement('ul');
          ul.className = 'pagination justify-content-center';

          const prevLi = document.createElement('li');
          prevLi.className = 'page-item' + (haftalikCurrentPage === 1 ? ' disabled' : '');
          const prevLink = document.createElement('a');
          prevLink.className = 'page-link';
          prevLink.href = '#';
          prevLink.innerText = 'Â«';
          prevLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (haftalikCurrentPage > 1) { haftalikCurrentPage--; haftalikKayitlariListele(); }
          });
          prevLi.appendChild(prevLink);
          ul.appendChild(prevLi);

          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === haftalikCurrentPage ? ' active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.addEventListener('click', (e) => {
              e.preventDefault();
              if (i !== haftalikCurrentPage) { haftalikCurrentPage = i; haftalikKayitlariListele(); }
            });
            li.appendChild(a);
            ul.appendChild(li);
          }

          const nextLi = document.createElement('li');
          nextLi.className = 'page-item' + (haftalikCurrentPage === totalPages ? ' disabled' : '');
          const nextLink = document.createElement('a');
          nextLink.className = 'page-link';
          nextLink.href = '#';
          nextLink.innerText = 'Â»';
          nextLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (haftalikCurrentPage < totalPages) { haftalikCurrentPage++; haftalikKayitlariListele(); }
          });
          nextLi.appendChild(nextLink);
          ul.appendChild(nextLi);

          nav.appendChild(ul);
          paginationContainer.appendChild(nav);
        }
      });
    }

function haftalikKaydiSil(key){
      if(!confirm("Bu haftalÄ±k kaydÄ± silmek istiyor musunuz?")) return;
      database.ref("haftalikDegerlendirme/"+key).remove().then(()=>{
        refreshWeekly(); // Ã¶nemli
      });
    }

    function haftalikKaydiGuncelle(key){
      guncellenecekHaftaKey = key;
      database.ref("haftalikDegerlendirme/"+key).once("value").then(s=>{
        const v = s.val() || {};
        document.getElementById('guncelleHaftaOgrenci').value = v.ogrenci || '';
        document.getElementById('guncelleHaftaOdev').value    = v.odev || '';
        document.getElementById('guncelleHaftaDurum').value   = v.durum || '';
        document.getElementById('guncelleHaftaKonu').value    = v.konu || '';
        document.getElementById('guncelleHaftaTarih').value   = v.tarih || '';
        document.getElementById('guncelleGelecekOdev').value  = v.gelecekOdev || '';
        document.getElementById('guncelleGelecekKonu').value  = v.gelecekKonu || '';
        // Motivasyon puanÄ± ve aÃ§Ä±klama deÄŸerlerini doldur
        const motEl = document.getElementById('guncelleHaftaMotivasyon');
        if (motEl) motEl.value = v.motivasyon || '';
        const motAcikEl = document.getElementById('guncelleHaftaMotivasyonAciklama');
        if (motAcikEl) motAcikEl.value = v.motivasyonAciklama || '';
        bsModal('haftalikGuncelleModal').show();
      });
    }

    
    function haftalikKaydiGuncelleKaydet(){
      if(!guncellenecekHaftaKey){ alert("GÃ¼ncellenecek kayÄ±t yok."); return; }

      // Motivasyon verileri
      const motVal = parseInt(document.getElementById('guncelleHaftaMotivasyon')?.value) || 0;
      const motAcik = document.getElementById('guncelleHaftaMotivasyonAciklama')?.value || '';

      const modalEl = document.getElementById('haftalikGuncelleModal');
      const afterDone = (msgOk=true) => {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();
        refreshWeekly();
        refreshAssignments();
        if (msgOk) alert("âœ… KayÄ±t gÃ¼ncellendi.");
      };

      // Ã–nce eski kaydÄ± al: odevKey iliÅŸkilendirmesi ve eÅŸleÅŸtirme iÃ§in
      database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).once("value").then(snap=>{
        const old = snap.val() || {};
        const prevOdevKey = old.odevKey || '';
        const prevGelecekOdev = old.gelecekOdev || '';
        const prevTarih = old.tarih || '';

        const veri = {
          ogrenci: document.getElementById('guncelleHaftaOgrenci').value,
          odev: document.getElementById('guncelleHaftaOdev').value,
          durum: document.getElementById('guncelleHaftaDurum').value,
          konu: document.getElementById('guncelleHaftaKonu').value,
          tarih: document.getElementById('guncelleHaftaTarih').value,
          gelecekOdev: document.getElementById('guncelleGelecekOdev').value,
          gelecekKonu: document.getElementById('guncelleGelecekKonu').value,
          motivasyon: motVal,
          motivasyonAciklama: motAcik.trim(),
          zaman: new Date().toISOString()
        };

        // Ä°liÅŸkilendirmeleri koru
        if (old.odevKaynakKey) veri.odevKaynakKey = old.odevKaynakKey;
        if (prevOdevKey) veri.odevKey = prevOdevKey;

        database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update(veri).then(()=>{
          // HaftalÄ±k kayÄ±tta "gelecek Ã¶dev" deÄŸiÅŸtiyse -> KayÄ±tlÄ± Ã–devler'de de gÃ¼ncelle
          const newOdevKaydi = { ogrenci: veri.ogrenci, konu: veri.gelecekOdev, tarih: veri.tarih };

          // 1) DoÄŸrudan odevKey varsa gÃ¼ncelle
          if (prevOdevKey){
            database.ref("odevler/"+prevOdevKey).update(newOdevKaydi).then(()=> afterDone(true)).catch(()=> afterDone(true));
            return;
          }

          // 2) Eski kayÄ±tlarda odevKey yoksa: eÅŸleÅŸtirme dene (ogrenci + tarih + eski gelecekOdev)
          database.ref("odevler").once("value").then(s2=>{
            const all = s2.val() || {};
            const found = Object.entries(all).find(([_, o])=>{
              const text = (o?.konu || o?.icerik || '');
              const sameStudent = (o?.ogrenci || '') === (veri.ogrenci || '');
              const sameText = text === (prevGelecekOdev || '');
              const sameDate = (o?.tarih || '') === (prevTarih || '') || (o?.tarih || '') === (veri.tarih || '');
              return sameStudent && sameText && sameDate;
            });

            if (found){
              const [k] = found;
              database.ref("odevler/"+k).update(newOdevKaydi).then(()=>{
                // Link'i geri yaz
                database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update({ odevKey: k });
                afterDone(true);
              }).catch(()=> afterDone(true));
              return;
            }

            // 3) EÅŸleÅŸme bulunamadÄ±ysa yeni Ã¶dev oluÅŸtur ve iliÅŸkilendir
            const newRef = database.ref("odevler").push();
            newRef.set(newOdevKaydi).then(()=>{
              database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update({ odevKey: newRef.key });
              afterDone(true);
            }).catch(()=> afterDone(true));
          }).catch(()=> afterDone(true));
        }).catch(()=> alert("âŒ GÃ¼ncelleme baÅŸarÄ±sÄ±z."));
      }).catch(()=> alert("âŒ GÃ¼ncelleme iÃ§in kayÄ±t okunamadÄ±."));
    }

function tumHaftalikKayitlariSil(){
      if(!confirm("TÃ¼m haftalÄ±k kayÄ±tlarÄ± silmek istediÄŸinize emin misiniz?")) return;
      database.ref("haftalikDegerlendirme").remove().then(()=>{
        refreshWeekly(); // Ã¶nemli
        alert("âœ… TÃ¼m haftalÄ±k kayÄ±tlar silindi.");
      }).catch(()=> alert("âŒ KayÄ±tlar silinemedi."));
    }

    /************ RAPOR ************/
    function raporFormYenile(){
      document.getElementById('raporTipi').value = 'haftalik';
      document.getElementById('raporOgrenciSec').value = '';
      document.getElementById('raporMesaj').value = '';
    }

    function raporTipiDegisti(){ raporMesajiOlustur(); }

    function raporOgrenciSecDoldur(){
      const select = document.getElementById("raporOgrenciSec");
      if(!select) return;
      database.ref("ogrenciler").once("value").then(s=>{
        const val = s.val() || [];
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : Object.values(val);
        select.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
        (arr||[]).forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.id || o.ad;
          opt.textContent = o.ad;
          select.appendChild(opt);
        });
      });
    }

    function whatsappMesajGonder(){
      const mesaj = (document.getElementById('raporMesaj').value || '').trim();
      if(!mesaj) return alert('GÃ¶nderilecek mesaj boÅŸ.');
      const url = `https://wa.me/?text=${encodeURIComponent(mesaj)}`;
      window.open(url, '_blank');
    }

    function raporMesajiOlustur(){
      const tip = document.getElementById('raporTipi').value;
      const secilenId = document.getElementById('raporOgrenciSec').value;
      if(!secilenId) return;

      const ayAdlari = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
      const formatTarih = (date) => `${date.getDate()} ${ayAdlari[date.getMonth()]} ${date.getFullYear()}`;
      const toShortDateStr = (d) => new Date(d).toISOString().split('T')[0];

      const bugun = new Date();
      const bugunStr = toShortDateStr(bugun);
      const birAyOnce = new Date(bugun); birAyOnce.setMonth(birAyOnce.getMonth() - 1);
      const birAyOnceStr = toShortDateStr(birAyOnce);

      Promise.all([
        database.ref("ogrenciler").once("value"),
        database.ref("haftalikDegerlendirme").once("value")
      ]).then(([ogrenciSnap, haftalikSnap])=>{
        const ogrVal = ogrenciSnap.val() || [];
        const ogrArr = Array.isArray(ogrVal) ? (ogrVal.filter(Boolean)||[]) : Object.values(ogrVal||{});
        const haftVal = haftalikSnap.val() || {};
        const kayitlar = Object.values(haftVal);

        const ogrenci = ogrArr.find(o => (o.id == secilenId) || (o.ad == secilenId));
        if(!ogrenci) return;

        const ogrenciAdi = ogrenci.ad;

        if(tip === 'haftalik'){
          const ogrKay = kayitlar.filter(k=>k.ogrenci === ogrenciAdi);
          const sonKayit = ogrKay[ogrKay.length - 1];
          // Motivasyon bilgilerini hazÄ±rla
          const mot = parseInt(sonKayit?.motivasyon) || 0;
          const motAcik = (sonKayit?.motivasyonAciklama || '').trim();
          const yildizStr = mot > 0 ? 'â­'.repeat(mot) : '';
          const motMetni = mot ? `${mot}/10 ${yildizStr}` : 'Bilgi Yok';
          const motAcikMetni = motAcik || 'Bilgi Yok';

          const mesaj = `ğŸ“˜ Ã–zel Ders Takip Sistemi
ğŸ“… *Tarih:* ${formatTarih(bugun)}
ğŸ‘¤ *Ã–ÄŸrenci:* ${ogrenciAdi}
ğŸ“ *Ã–ÄŸretmen:* Ferhat KaragÃ¶z

ğŸ“Œ *Bu Hafta YapÄ±lanlar*
ğŸ“š *Ä°ÅŸlenen Konu:* ${sonKayit?.konu || 'Bilgi Yok'}
ğŸ“ *GeÃ§en Haftaki Ã–dev:* ${sonKayit?.odev || 'Ã–dev Yok'} â†’ ${durumIcon(sonKayit?.durum)}
â­ *Motivasyon:* ${motMetni}
ğŸ—’ï¸ *Genel Ders Durumu:* ${motAcikMetni}

ğŸ“– *Gelecek Hafta YapÄ±lacaklar*
ğŸ“ *Ã–dev:* ${sonKayit?.gelecekOdev || 'Ã–dev Yok'}
â° *Teslim Tarihi:* ${sonKayit?.tarih ? formatTarih(new Date(sonKayit.tarih)) : 'Tarih Yok'}
ğŸ“š *Ä°ÅŸlenecek Konular:* ${sonKayit?.gelecekKonu || 'Konu Yok'}

SaygÄ±larÄ±mÄ±zla, bilginize.`;
          document.getElementById('raporMesaj').value = mesaj;
        } else {
          const tarihAraligindakiKayitlar = kayitlar
            .filter(k=>{
              const ogr = k.ogrenci === ogrenciAdi;
              const tStr = toShortDateStr(k.zaman || k.tarih);
              return ogr && tStr >= birAyOnceStr && tStr <= bugunStr;
            })
            .sort((a,b)=> new Date(b.zaman || b.tarih) - new Date(a.zaman || a.tarih));

          const konular = tarihAraligindakiKayitlar.map(k=>{
            const t = new Date(k.zaman || k.tarih);
            return `- ${formatTarih(t)} â†’ ${k.konu || 'Konu girilmemiÅŸ'}`;
          });
          const odevSatirlari = tarihAraligindakiKayitlar.map(k=>{
            const t = new Date(k.zaman || k.tarih);
            return `- ${formatTarih(t)} â†’ ${k.odev || 'Ã–dev Yok'} â†’ ${durumIcon(k.durum)}`;
          });
          const toplamOdev = tarihAraligindakiKayitlar.filter(k=>k.odev).length;
          const yapilanOdev = tarihAraligindakiKayitlar.filter(k=>(k.durum||'').toLowerCase()==='yapti').length;
          const oran = toplamOdev ? Math.round((yapilanOdev / toplamOdev) * 100) : 0;

          const mesaj = `ğŸ“˜ Ã–zel Ders Takip Sistemi
ğŸ“… *Tarih:* ${formatTarih(bugun)}
ğŸ‘¤ *Ã–ÄŸrenci:* ${ogrenciAdi}
ğŸ“ *Ã–ÄŸretmen:* Ferhat KaragÃ¶z

ğŸ“… *Son 1 Ayda YapÄ±lanlar* (${formatTarih(birAyOnce)} - ${formatTarih(bugun)})

ğŸ“š *Ä°ÅŸlenen Konular:*
${konular.length ? konular.join("\n") : '- Veri yok'}

ğŸ“ *Verilen Ã–devler ve Kontrolleri:*
${odevSatirlari.length ? odevSatirlari.join("\n") : '- Veri yok'}

ğŸ“Š *Ã–dev PerformansÄ±*
- *Toplam Ã–dev:* ${toplamOdev}
- *Tamamlanan:* ${yapilanOdev}
- *BaÅŸarÄ± OranÄ±:* %${oran}

*Bu rapor, son bir ay iÃ§inde iÅŸlenen tÃ¼m konularÄ± ve Ã¶dev takibini iÃ§ermektedir.*

SaygÄ±larÄ±mÄ±zla, bilginize.`;
          document.getElementById('raporMesaj').value = mesaj;
        }
      });
    }

    function qrKodModalAc(){
      const mesaj = (document.getElementById('raporMesaj').value || '').trim();
      if(!mesaj){ alert("Mesaj boÅŸ."); return; }
      const url = `https://wa.me/?text=${encodeURIComponent(mesaj)}`;
      const container = document.getElementById('qrModalCanvas');
      container.innerHTML = '';
      new QRCode(container, { text:url, width:250, height:250, correctLevel: QRCode.CorrectLevel.M });
      bsModal('qrModal').show();
    }

    /************ INIT ************/
    window.addEventListener('load', ()=>{
      refreshAll(); // baÅŸlangÄ±Ã§

      // Logo tÄ±klanÄ±nca bÃ¼yÃ¼k gÃ¶ster (herhangi bir tÄ±klamada kapanÄ±r)
      const logo = document.getElementById('brandLogo');
      if (logo){
        const openLogo = () => {
          const modalImg = document.getElementById('logoModalImg');
          if (modalImg) modalImg.src = logo.getAttribute('src') || modalImg.src;
          bsModal('logoModal').show();
        };
        logo.addEventListener('click', openLogo);
        logo.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') openLogo(); });
      }
      const logoModalEl = document.getElementById('logoModal');
      if (logoModalEl){
        logoModalEl.addEventListener('click', ()=> bsModal('logoModal').hide());
      }

      // Wizard adÄ±mlarÄ±nÄ± tÄ±klanabilir yap
      document.querySelectorAll('#weeklyWizardSteps .wizard-chip').forEach(chip=>{
        chip.addEventListener('click', ()=> weeklyWizardGo(parseInt(chip.dataset.step)));
      });
      weeklyWizardGo(1);


      // ---- GerÃ§ek zamanlÄ± otomatik yenileme istersen alttakileri aktif et:
      // database.ref("ogrenciler").on("value", ()=> refreshStudents());
      // database.ref("odevler").on("value",   ()=> refreshAssignments());
      // database.ref("haftalikDegerlendirme").on("value", ()=> refreshWeekly());
      // -----------------------------------------
      // Rapor alanÄ± tetikleyicileri
      document.getElementById('raporTipi').addEventListener('change', raporMesajiOlustur);
      document.getElementById('raporOgrenciSec').addEventListener('change', raporMesajiOlustur);
      // HaftalÄ±kta Ã¶ÄŸrenci deÄŸiÅŸince Ã¶dev seÃ§eneklerini dolduruyoruz (yukarÄ±da eklendi)
      // Filtre select deÄŸiÅŸince listeleri yeniden oluÅŸtur
      const odevFiltreSelect = document.getElementById('odevFiltreOgrenci');
      if (odevFiltreSelect) {
        odevFiltreSelect.addEventListener('change', () => {
          // Filtre deÄŸiÅŸtirildiÄŸinde sayfalama sÄ±fÄ±rlanÄ±r ve liste yeniden Ã§izilir
          odevCurrentPage = 1;
          odevListele();
        });
      }
      const haftalikFiltreSelect = document.getElementById('haftalikFiltreOgrenci');
      if (haftalikFiltreSelect) {
        haftalikFiltreSelect.addEventListener('change', () => {
          // Filtre deÄŸiÅŸince sayfa 1'den baÅŸlat
          haftalikCurrentPage = 1;
          haftalikKayitlariListele();
        });
      }
    });
  </script>
</body>
</html>
