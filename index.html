<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ã–zel Ders Takip Sistemi</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary-color: #4361ee;
      --primary-hover: #3a0ca3;
      --bg-body: #f8f9fa;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-radius: 16px;
      --transition-speed: 0.3s;
    }

    body { 
      background-color: var(--bg-body); 
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    /* Navbar */
    .navbar {
      background: rgba(255, 255, 255, 0.85) !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.03) !important;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 0.8rem 0;
    }
    .navbar-brand {
      font-weight: 700;
      color: var(--primary-color) !important;
      letter-spacing: -0.5px;
      font-size: 1.2rem;
    }
    .navbar-brand img {
      height: 36px;
      width: auto;
      object-fit: contain;
      border-radius: 8px;
    }

    /* Sticky Tabs */
    .sticky-tabs { 
      position: sticky; 
      top: 0; 
      z-index: 1020; 
      background: rgba(248, 249, 250, 0.95); 
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 0.5rem 0;
      margin-bottom: 1.5rem;
    }
    .nav-pills .nav-link {
      color: var(--text-muted);
      font-weight: 500;
      border-radius: 50rem; /* Pill shape */
      padding: 0.6rem 1.2rem;
      transition: all var(--transition-speed) ease;
      margin-right: 0.5rem;
    }
    .nav-pills .nav-link:hover {
      background-color: rgba(67, 97, 238, 0.08);
      color: var(--primary-color);
    }
    .nav-pills .nav-link.active {
      background-color: var(--primary-color);
      color: #fff;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
    .nav-pills .nav-link i { margin-right: 6px; }

    /* Cards */
    .app-card { 
      background: var(--card-bg); 
      border-radius: var(--border-radius); 
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.8);
      transition: transform 0.2s ease;
    }
    /* Kart baÅŸlÄ±klarÄ± */
    h2.h4, h3.h5 {
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.3px;
    }

    /* Form Elements */
    .form-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }
    .form-control, .form-select {
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
      background-color: #fcfcfc;
      transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      background-color: #fff;
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    }
    .form-row-gap { row-gap: 1.25rem; }
    textarea { resize: vertical; min-height: 80px; }

    /* Buttons */
    .btn {
      border-radius: 10px;
      padding: 0.65rem 1.25rem;
      font-weight: 600;
      transition: all 0.2s;
      letter-spacing: 0.3px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.25);
    }
    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(67, 97, 238, 0.35);
    }
    .btn-success {
      background-color: #10b981;
      border: none;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
    }
    .btn-success:hover {
      background-color: #059669;
      transform: translateY(-2px);
    }
    .btn-outline-secondary {
      border: 2px solid #e2e8f0;
      color: var(--text-muted);
    }
    .btn-outline-secondary:hover {
      background-color: #e2e8f0;
      color: #0f172a;
    }
    .btn-outline-danger {
      border: 2px solid #fee2e2;
      color: #ef4444;
    }
    .btn-outline-danger:hover {
      background-color: #fee2e2;
      color: #dc2626;
    }

    /* Lists */
    .list-group-item { 
      border: none;
      background: #f8fafc;
      margin-bottom: 0.6rem;
      border-radius: 12px !important;
      padding: 1rem;
      transition: all 0.2s ease;
    }
    .list-group-item:hover {
      background-color: #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      transform: scale(1.005);
    }
    .list-fit .list-group-item { 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap: .75rem; 
    }

    /* Utilities & Other */
    .qr-center { 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      min-height:260px; 
      background: #f1f5f9;
      border: 2px dashed #cbd5e1;
      border-radius: 16px;
    }
    .small-muted { 
      font-size: 0.85rem; 
      color: var(--text-muted); 
    }
    hr {
      border-color: #e2e8f0;
      opacity: 0.6;
      margin: 2rem 0;
    }
  </style>

  <script>
    // Firebase yapÄ±landÄ±rma
    const firebaseConfig = {
      apiKey: "AIzaSyD4Ctf-F5BSU_4fHK2WgTQUj_okrzyI7OI",
      authDomain: "birebir-1df98.firebaseapp.com",
      databaseURL: "https://birebir-1df98-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "birebir-1df98",
      storageBucket: "birebir-1df98.firebasestorage.app",
      messagingSenderId: "145327250159",
      appId: "1:145327250159:web:f4d8be51e312f5552f591a",
      measurementId: "G-8CB54NS9QW"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <img src="https://i.ibb.co/F4cDX7MX/logom.jpg" alt="Logo" />
      ğŸ“˜ Ã–zel Ders Takip Sistemi
    </a>
  </div>
</nav>

  <div class="sticky-tabs">
    <div class="container">
      <ul class="nav nav-pills" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-ogrenci" data-bs-toggle="pill" data-bs-target="#pnl-ogrenci" type="button" role="tab">
            <i class="bi bi-person"></i> Ã–ÄŸrenci KaydÄ±
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-haftalik" data-bs-toggle="pill" data-bs-target="#pnl-haftalik" type="button" role="tab">
            <i class="bi bi-calendar-week"></i> HaftalÄ±k DeÄŸerlendirme
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-rapor" data-bs-toggle="pill" data-bs-target="#pnl-rapor" type="button" role="tab">
            <i class="bi bi-whatsapp"></i> WhatsApp Rapor
          </button>
        </li>
      </ul>
    </div>
  </div>

  <div class="container my-4">
    <div class="tab-content">

      <div class="tab-pane fade show active" id="pnl-ogrenci" role="tabpanel" aria-labelledby="tab-ogrenci">
        <div class="app-card p-4 p-md-5">
          <h2 class="h4 mb-4">ğŸ‘¤ Ã–ÄŸrenci KaydÄ±</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-6">
              <label class="form-label">Ã–ÄŸrenci AdÄ±</label>
              <input type="text" id="ogrenciAd" class="form-control" placeholder="Ã–rn: AyÅŸe YÄ±lmaz" />
            </div>
            <div class="col-md-6">
              <label class="form-label">SÄ±nÄ±f</label>
              <select id="ogrenciSinif" class="form-select">
                <option value="">SÄ±nÄ±f SeÃ§iniz</option>
                <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
                <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
              </select>
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary" onclick="ogrenciEkle()"><i class="bi bi-plus-circle"></i> Ã–ÄŸrenci Ekle</button>
              <button class="btn btn-outline-secondary" onclick="temizleInputlar()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
            </div>
          </div>

          <hr class="my-4" />

          <h3 class="h5 mb-3">ğŸ“‹ Ã–ÄŸrenci Listesi</h3>
          <div class="list-group list-fit" id="ogrenciListesi"></div>

          <hr class="my-4" />

          <h3 class="h5 mb-3">ğŸ“˜ Ã–dev Ekle</h3>
          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Ã–ÄŸrenci</label>
              <select id="odevOgrenci" class="form-select">
                <option value="">Ã–ÄŸrenci SeÃ§iniz</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Tarih</label>
              <input type="date" id="odevTarih" class="form-control"/>
            </div>
            <div class="col-12">
              <label class="form-label">Ã–dev Ä°Ã§eriÄŸi</label>
              <textarea id="odevIcerik" class="form-control" rows="3" placeholder="Ã–rn: Sayfa 45-47 problemler..."></textarea>
            </div>
            <div class="col-12 d-flex flex-wrap gap-2">
              <button class="btn btn-success" onclick="odevEkle()"><i class="bi bi-plus-circle"></i> Ã–dev Ekle</button>
              <button class="btn btn-outline-secondary" onclick="odevFormTemizle()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
              <button class="btn btn-outline-danger" onclick="tumOdevleriSil()"><i class="bi bi-trash"></i> TÃ¼m Ã–devleri Sil</button>
            </div>
          </div>

          <div class="mt-4">
            <h3 class="h6 text-uppercase text-muted">KayÄ±tlÄ± Ã–devler</h3>
            <div class="row g-2 mb-3">
              <div class="col-md-4">
                <label class="form-label">Ã–ÄŸrenci Filtrele</label>
                <select id="odevFiltreOgrenci" class="form-select">
                  <option value="">TÃ¼mÃ¼</option>
                </select>
              </div>
            </div>
            <div id="odevListesi" class="list-group list-fit"></div>
             <div id="odevPagination"></div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pnl-haftalik" role="tabpanel" aria-labelledby="tab-haftalik">
        <div class="app-card p-4 p-md-5">
          <h2 class="h4 mb-4">ğŸ“… HaftalÄ±k DeÄŸerlendirme</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Ã–ÄŸrenci</label>
              <select id="haftaOgrenci" class="form-select">
                <option value="">Ã–ÄŸrenci SeÃ§in</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ã–dev</label>
              <select id="haftaOdev" class="form-select">
                <option value="">Ã–dev SeÃ§in</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ã–dev Durumu</label>
              <select id="odevDurumu" class="form-select">
                <option value="">Ã–dev Durumu</option>
                <option value="yapti">âœ… YaptÄ±</option>
                <option value="yapmadi">âŒ YapmadÄ±</option>
                <option value="eksik">âš ï¸ Eksik</option>
                <option value="getirmedi">ğŸ“­ Getirmedi</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Bu hafta iÅŸlenen konu</label>
              <textarea id="buHaftaKonu" class="form-control" rows="2"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Gelecek haftanÄ±n Ã¶devi</label>
              <textarea id="gelecekHaftaOdev" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">Teslim Tarihi</label>
              <input type="date" id="gelecekTarih" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Gelecek hafta konusu</label>
              <textarea id="gelecekHaftaKonu" class="form-control" rows="1"></textarea>
            </div>

          <div class="col-md-3">
            <label class="form-label">Motivasyon (1â€‘10)</label>
            <input type="number" id="haftaMotivasyon" class="form-control" min="1" max="10" />
          </div>
          <div class="col-12">
            <label class="form-label">Genel Ders Durumu</label>
            <textarea id="haftaMotivasyonAciklama" class="form-control" rows="2"></textarea>
          </div>

            <div class="col-12 d-flex flex-wrap gap-2">
              <button class="btn btn-primary" type="button" onclick="haftalikVeriyiEkle()"><i class="bi bi-plus-circle"></i> Ã–devi Sisteme Ekle</button>
              <button class="btn btn-outline-secondary" onclick="haftalikFormYenile()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
              <button class="btn btn-outline-danger ms-auto" type="button" onclick="tumHaftalikKayitlariSil()"><i class="bi bi-trash"></i> TÃ¼m KayÄ±tlarÄ± Sil</button>
            </div>
          </div>

          <hr class="my-4" />

          <h3 class="h5 mb-3">ğŸ“‹ KayÄ±tlÄ± HaftalÄ±k DeÄŸerlendirmeler</h3>
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <label class="form-label">Ã–ÄŸrenci Filtrele</label>
              <select id="haftalikFiltreOgrenci" class="form-select">
                <option value="">TÃ¼mÃ¼</option>
              </select>
            </div>
          </div>
          <div id="haftalikKayitListesi" class="list-group list-fit"></div>
           <div id="haftalikPagination"></div>
          <div id="haftalikOzet" class="mt-2 small-muted"></div>
          <p id="haftaDurumMesaji" class="mt-3 small-muted"></p>
        </div>
      </div>

      <div class="tab-pane fade" id="pnl-rapor" role="tabpanel" aria-labelledby="tab-rapor">
        <div class="app-card p-4 p-md-5">
          <h2 class="h4 mb-4">ğŸ“¤ WhatsApp RaporlarÄ±</h2>

          <div class="row g-3 form-row-gap">
            <div class="col-md-4">
              <label class="form-label">Rapor TÃ¼rÃ¼</label>
              <select id="raporTipi" class="form-select" onchange="raporTipiDegisti()">
                <option value="haftalik">ğŸ“… HaftalÄ±k Rapor</option>
                <option value="aylik">ğŸ“† AylÄ±k Rapor</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Ã–ÄŸrenci SeÃ§</label>
              <select id="raporOgrenciSec" class="form-select"></select>
            </div>

            <div class="col-12">
              <label class="form-label">OluÅŸturulan Mesaj</label>
              <textarea id="raporMesaj" rows="10" class="form-control"></textarea>
            </div>

            <div class="col-12 d-flex flex-wrap gap-2">
              <button class="btn btn-success" onclick="whatsappMesajGonder()"><i class="bi bi-send"></i> GÃ¶nder</button>
              <button class="btn btn-outline-secondary" onclick="raporFormYenile()"><i class="bi bi-arrow-clockwise"></i> Yenile</button>
              <button class="btn btn-outline-dark" onclick="qrKodModalAc()"><i class="bi bi-qr-code"></i> QR Kod ile GÃ¶ster</button>
            </div>
          </div>
          <div id="qrCanvasContainer" class="qr-center mt-3"></div>
        </div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="ogrenciGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ Ã–ÄŸrenci GÃ¼ncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ad</label>
            <input type="text" id="guncelleAd" class="form-control"/>
          </div>
          <div class="mb-3">
            <label class="form-label">SÄ±nÄ±f</label>
            <select id="guncelleSinif" class="form-select">
              <option value="">SÄ±nÄ±f SeÃ§iniz</option>
              <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option>
              <option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button class="btn btn-primary" onclick="ogrenciGuncelleKaydet()"><i class="bi bi-save"></i> Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="odevGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ Ã–dev GÃ¼ncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Tarih</label>
            <input type="date" id="guncelleOdevTarih" class="form-control"/>
          </div>
          <div class="mb-3">
            <label class="form-label">Ä°Ã§erik</label>
            <textarea id="guncelleOdevIcerik" rows="4" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button class="btn btn-primary" onclick="odevGuncelleKaydet()"><i class="bi bi-save"></i> Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="haftalikGuncelleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ HaftalÄ±k KayÄ±t GÃ¼ncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="guncelleHaftaOgrenci" class="form-control mb-2" placeholder="Ã–ÄŸrenci AdÄ±">
          <input type="text" id="guncelleHaftaKonu" class="form-control mb-2" placeholder="Bu hafta konusu">
          <input type="text" id="guncelleHaftaOdev" class="form-control mb-2" placeholder="Ã–dev">
          <input type="text" id="guncelleHaftaDurum" class="form-control mb-2" placeholder="Ã–dev durumu (yapti, yapmadi...)">
          <input type="date" id="guncelleHaftaTarih" class="form-control mb-2">
          <input type="text" id="guncelleGelecekKonu" class="form-control mb-2" placeholder="Gelecek hafta konusu">
          <input type="text" id="guncelleGelecekOdev" class="form-control mb-2" placeholder="Gelecek hafta Ã¶devi">
          
          <input type="number" id="guncelleHaftaMotivasyon" class="form-control mb-2" min="1" max="10" placeholder="Motivasyon (1-10)">
          <textarea id="guncelleHaftaMotivasyonAciklama" class="form-control mb-2" placeholder="Genel ders durumu" rows="2"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button class="btn btn-primary" onclick="haftalikKaydiGuncelleKaydet()"><i class="bi bi-save"></i> Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ“± WhatsApp MesajÄ± iÃ§in QR Kod</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div id="qrModalCanvas" class="qr-center"></div>
          <p class="small-muted text-center mt-3">QRâ€™Ä± telefon kameranÄ±zla okutarak WhatsApp mesajÄ±nÄ± aÃ§abilirsiniz.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ YardÄ±mcÄ±lar ************/
    let guncellenecekId = null;            // Ã–ÄŸrenci gÃ¼ncelle
    let guncellenecekOdevKey = null;       // Ã–dev gÃ¼ncelle
    let guncellenecekHaftaKey = null;      // HaftalÄ±k kayÄ±t gÃ¼ncelle

    const bsModal = (id) => bootstrap.Modal.getOrCreateInstance(document.getElementById(id));

    const durumIcon = (durum) => {
      switch ((durum || '').toLowerCase()) {
        case 'yapti': return 'âœ… YaptÄ±';
        case 'yapmadi': return 'âŒ YapmadÄ±';
        case 'eksik': return 'âš ï¸ Eksik';
        case 'getirmedi': return 'ğŸ“­ Getirmedi';
        default: return 'â– Bilgi Yok';
      }
    };

    function formatTurkishDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    let odevCurrentPage = 1;
    let haftalikCurrentPage = 1;

    // --- Ortak yenile yardÄ±mcÄ±larÄ± ---
    function refreshStudents() {
      ogrenciListele();
      doldurOgrenciSecimi();       
      doldurHaftaOgrenciListesi(); 
      raporOgrenciSecDoldur();     
      doldurOdevFiltre();
      doldurHaftalikFiltre();
    }
    function refreshAssignments() {
      odevListele();
    }
    function refreshWeekly() {
      haftalikKayitlariListele();
    }
    function refreshAll() {
      refreshStudents();
      refreshAssignments();
      refreshWeekly();
      const sel = document.getElementById('raporOgrenciSec');
      if (sel && sel.value) { raporMesajiOlustur(); }
    }

    // Ã–ÄŸrenci - dizi olarak sakla / getir
    function getOgrenciler(cb){
      database.ref("ogrenciler").once("value").then(s => {
        const val = s.val();
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : (Object.values(val || {}));
        cb(arr || []);
      }).catch(_ => cb([]));
    }
    function setOgrenciler(arr){
      return database.ref("ogrenciler").set(arr || []);
    }

    /************ Ã–ÄRENCÄ° ************/
    function temizleInputlar(){
      document.getElementById('ogrenciAd').value = '';
      document.getElementById('ogrenciSinif').value = '';
    }

    function ogrenciEkle(){
      const ad = document.getElementById('ogrenciAd').value.trim();
      const sinif = document.getElementById('ogrenciSinif').value;
      if(!ad || !sinif){ alert("LÃ¼tfen Ã¶ÄŸrenci adÄ± ve sÄ±nÄ±f seÃ§in."); return; }

      getOgrenciler(ogrenciler=>{
        const id = Date.now();
        const yeni = { id, ad, sinif };
        const guncel = [...ogrenciler, yeni];
        setOgrenciler(guncel).then(()=>{
          alert("âœ… Ã–ÄŸrenci eklendi.");
          refreshStudents(); 
          temizleInputlar();
        }).catch(()=> alert("âŒ Ã–ÄŸrenci eklenemedi."));
      });
    }

    function ogrenciSil(id){
      if(!confirm("Bu Ã¶ÄŸrenciyi silmek istediÄŸinize emin misiniz?")) return;
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.filter(o=>o.id !== id);
        setOgrenciler(guncel).then(()=>{
          refreshStudents();
        });
      });
    }

    function ogrenciGuncelleAc(id){
      getOgrenciler(ogrenciler=>{
        const o = ogrenciler.find(x=>x.id===id);
        if(!o) return;
        guncellenecekId = id;
        document.getElementById('guncelleAd').value = o.ad || '';
        document.getElementById('guncelleSinif').value = o.sinif || '';
        bsModal('ogrenciGuncelleModal').show();
      });
    }

    function ogrenciGuncelleKaydet(){
      const ad = document.getElementById('guncelleAd').value.trim();
      const sinif = document.getElementById('guncelleSinif').value;
      if(!guncellenecekId){ alert("GÃ¼ncellenecek Ã¶ÄŸrenci yok."); return; }
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.map(o=> o.id===guncellenecekId ? ({...o, ad, sinif}) : o);
        setOgrenciler(guncel).then(()=>{
          bsModal('ogrenciGuncelleModal').hide();
          refreshStudents();
          alert("âœ… Ã–ÄŸrenci gÃ¼ncellendi.");
        });
      });
    }

    function ogrenciListele(){
      const liste = document.getElementById('ogrenciListesi');
      liste.innerHTML = '<div class="text-center text-muted py-3">YÃ¼kleniyor...</div>';
      getOgrenciler(ogrenciler=>{
        liste.innerHTML = '';
        if(!ogrenciler.length){
          liste.innerHTML = '<div class="text-center text-muted py-3">KayÄ±tlÄ± Ã¶ÄŸrenci yok.</div>';
          return;
        }
        ogrenciler.forEach(o=>{
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.innerHTML = `
            <div>
              <div class="fw-bold">${o.ad}</div>
              <div class="small-muted">${o.sinif}</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary" onclick="ogrenciGuncelleAc(${o.id})"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="ogrenciSil(${o.id})"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });
      });
    }

    /************ Ã–DEVLER ************/
    function doldurOgrenciSecimi(){
      const sel = document.getElementById('odevOgrenci');
      sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
      getOgrenciler(ogrenciler=>{
        ogrenciler.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.ad; 
          opt.textContent = o.ad;
          sel.appendChild(opt);
        });
      });
    }
    
    // --- Ã–dev filtre select doldurma ---
    function doldurOdevFiltre() {
        const sel = document.getElementById('odevFiltreOgrenci');
        // Mevcut seÃ§imi korumak isteyebiliriz ama basitÃ§e yeniden dolduralÄ±m
        const val = sel.value; 
        sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
        getOgrenciler(ogrenciler => {
            ogrenciler.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.ad;
                opt.textContent = o.ad;
                sel.appendChild(opt);
            });
            sel.value = val; 
        });
    }

    function odevEkle(){
        const ogrenci = document.getElementById('odevOgrenci').value;
        const tarih = document.getElementById('odevTarih').value;
        const icerik = document.getElementById('odevIcerik').value.trim();
        if(!ogrenci || !tarih || !icerik){ alert("TÃ¼m alanlarÄ± doldurun."); return; }

        const yeniOdev = { ogrenci, tarih, icerik, timestamp: Date.now() };
        database.ref("odevler").push(yeniOdev).then(()=>{
            alert("âœ… Ã–dev eklendi.");
            odevFormTemizle();
            refreshAssignments();
        });
    }

    function odevFormTemizle(){
        document.getElementById('odevOgrenci').value = '';
        document.getElementById('odevTarih').value = '';
        document.getElementById('odevIcerik').value = '';
    }

    function tumOdevleriSil(){
        if(confirm("TÃ¼m Ã¶dev kayÄ±tlarÄ± silinecek! OnaylÄ±yor musunuz?")){
            database.ref("odevler").remove().then(()=>{
                refreshAssignments();
                alert("ğŸ—‘ï¸ Ã–devler silindi.");
            });
        }
    }

    function odevListele(){
      const liste = document.getElementById('odevListesi');
      liste.innerHTML = ''; 
      
      let paginationContainer = document.getElementById('odevPagination');
      if (!paginationContainer) {
         // EÄŸer HTML'de yoksa dinamik oluÅŸturulabilir ama yukarÄ±da ekledik.
      }
      paginationContainer.innerHTML = '';

      database.ref("odevler").once("value").then(snap => {
        const val = snap.val() || {};
        const allEntries = Object.entries(val);
        const filtreSel = document.getElementById('odevFiltreOgrenci');
        const filtreDeger = filtreSel ? filtreSel.value : '';

        // Filtrele
        let filtered = allEntries.filter(([_, odev]) => {
           return !filtreDeger || odev.ogrenci === filtreDeger;
        });

        if (filtered.length === 0) {
           liste.innerHTML = '<div class="text-center text-muted py-3">' + (allEntries.length===0?'KayÄ±tlÄ± Ã¶dev yok.':'SeÃ§ilen Ã¶ÄŸrenci iÃ§in Ã¶dev bulunamadÄ±.') + '</div>';
           return;
        }

        // Tarihe gÃ¶re azalan
        filtered.sort((a, b) => {
           const da = new Date(a[1].tarih);
           const db = new Date(b[1].tarih);
           return db - da; 
        });

        // Sayfalama
        const pageSize = 10;
        const totalPages = Math.ceil(filtered.length / pageSize);
        if (odevCurrentPage > totalPages) odevCurrentPage = totalPages;
        if (odevCurrentPage < 1) odevCurrentPage = 1;

        const startIdx = (odevCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageEntries = filtered.slice(startIdx, endIdx);

        pageEntries.forEach(([key, odev]) => {
          const item = document.createElement('div');
          item.className = 'list-group-item d-flex align-items-start';
          item.innerHTML = `
            <div class="flex-grow-1">
               <div class="d-flex justify-content-between align-items-center mb-1">
                 <h6 class="mb-0 fw-bold text-primary">${odev.ogrenci}</h6>
                 <small class="text-muted bg-light px-2 py-1 rounded border">${formatTurkishDate(odev.tarih)}</small>
               </div>
               <p class="mb-1 text-secondary">${odev.icerik}</p>
            </div>
            <div class="ms-3 d-flex flex-column gap-1">
               <button class="btn btn-sm btn-outline-primary" onclick="odevGuncelleAc('${key}')"><i class="bi bi-pencil"></i></button>
               <button class="btn btn-sm btn-outline-danger" onclick="odevSil('${key}')"><i class="bi bi-trash"></i></button>
            </div>
          `;
          liste.appendChild(item);
        });

        // Sayfalama ButonlarÄ±
        if (totalPages > 1) {
            let pagHtml = '<nav><ul class="pagination justify-content-center">';
            // Geri
            pagHtml += `<li class="page-item ${odevCurrentPage === 1 ? 'disabled' : ''}">
                          <button class="page-link" onclick="odevChangePage(${odevCurrentPage - 1})">Â«</button>
                        </li>`;
            // Sayfalar
            for(let i=1; i<=totalPages; i++){
                pagHtml += `<li class="page-item ${i === odevCurrentPage ? 'active' : ''}">
                              <button class="page-link" onclick="odevChangePage(${i})">${i}</button>
                            </li>`;
            }
            // Ä°leri
            pagHtml += `<li class="page-item ${odevCurrentPage === totalPages ? 'disabled' : ''}">
                          <button class="page-link" onclick="odevChangePage(${odevCurrentPage + 1})">Â»</button>
                        </li>`;
            pagHtml += '</ul></nav>';
            paginationContainer.innerHTML = pagHtml;
        }
      });
    }

    function odevChangePage(p){
        odevCurrentPage = p;
        odevListele();
    }

    function odevSil(key){
        if(confirm("Bu Ã¶devi silmek istiyor musunuz?")){
            database.ref("odevler/"+key).remove().then(()=> refreshAssignments());
        }
    }

    function odevGuncelleAc(key){
        database.ref("odevler/"+key).once("value").then(snap=>{
            const val = snap.val();
            if(!val) return;
            guncellenecekOdevKey = key;
            document.getElementById('guncelleOdevTarih').value = val.tarih || '';
            document.getElementById('guncelleOdevIcerik').value = val.icerik || '';
            bsModal('odevGuncelleModal').show();
        });
    }

    function odevGuncelleKaydet(){
        if(!guncellenecekOdevKey) return;
        const tarih = document.getElementById('guncelleOdevTarih').value;
        const icerik = document.getElementById('guncelleOdevIcerik').value;
        database.ref("odevler/"+guncellenecekOdevKey).update({tarih, icerik}).then(()=>{
            bsModal('odevGuncelleModal').hide();
            refreshAssignments();
            alert("âœ… Ã–dev gÃ¼ncellendi.");
        });
    }

    /************ HAFTALIK DEÄERLENDÄ°RME (Eksik kÄ±sÄ±mlar tamamlandÄ±) ************/
    
    function doldurHaftaOgrenciListesi(){
        const sel = document.getElementById('haftaOgrenci');
        sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§in</option>';
        getOgrenciler(ogrenciler=>{
            ogrenciler.forEach(o=>{
                const opt = document.createElement('option');
                opt.value = o.ad;
                opt.textContent = o.ad;
                sel.appendChild(opt);
            });
        });
        
        // Hafta Ã¶dev selectini Ã¶ÄŸrenci seÃ§ilince doldurmak iÃ§in listener ekleyebiliriz 
        // veya manuel tetikleyebiliriz. Åimdilik basit tutalÄ±m.
        sel.addEventListener('change', function(){
            doldurHaftaOdevListesi(this.value);
        });
    }

    function doldurHaftaOdevListesi(ogrenciAd){
        const sel = document.getElementById('haftaOdev');
        sel.innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
        if(!ogrenciAd) return;

        database.ref("odevler").orderByChild("ogrenci").equalTo(ogrenciAd).once("value").then(snap=>{
            const val = snap.val();
            if(!val) return;
            Object.values(val).forEach(od=>{
                const opt = document.createElement('option');
                opt.value = od.icerik; // Ä°Ã§eriÄŸi deÄŸer olarak kullanÄ±yoruz, istenirse tarih de eklenebilir
                opt.textContent = `${formatTurkishDate(od.tarih)} - ${od.icerik.substring(0,30)}...`;
                sel.appendChild(opt);
            });
        });
    }

    function doldurHaftalikFiltre() {
        const sel = document.getElementById('haftalikFiltreOgrenci');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
        getOgrenciler(ogrenciler=>{
            ogrenciler.forEach(o=>{
                const opt = document.createElement('option');
                opt.value = o.ad;
                opt.textContent = o.ad;
                sel.appendChild(opt);
            });
            sel.value = currentVal;
        });
    }

    function haftalikVeriyiEkle(){
        const ogrenci = document.getElementById('haftaOgrenci').value;
        const odev = document.getElementById('haftaOdev').value;
        const durum = document.getElementById('odevDurumu').value;
        const konu = document.getElementById('buHaftaKonu').value;
        const glcOdev = document.getElementById('gelecekHaftaOdev').value;
        const glcTarih = document.getElementById('gelecekTarih').value;
        const glcKonu = document.getElementById('gelecekHaftaKonu').value;
        const motivasyon = document.getElementById('haftaMotivasyon').value;
        const aciklama = document.getElementById('haftaMotivasyonAciklama').value;

        if(!ogrenci){ alert("Ã–ÄŸrenci seÃ§imi zorunludur."); return; }

        const veri = {
            ogrenci, odev, durum, konu, glcOdev, glcTarih, glcKonu, motivasyon, aciklama,
            timestamp: Date.now()
        };

        database.ref("haftalikDegerlendirme").push(veri).then(()=>{
            alert("âœ… HaftalÄ±k deÄŸerlendirme kaydedildi.");
            haftalikFormYenile();
            refreshWeekly();
        });
    }

    function haftalikFormYenile(){
        document.getElementById('haftaOgrenci').value = '';
        document.getElementById('haftaOdev').innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
        document.getElementById('odevDurumu').value = '';
        document.getElementById('buHaftaKonu').value = '';
        document.getElementById('gelecekHaftaOdev').value = '';
        document.getElementById('gelecekTarih').value = '';
        document.getElementById('gelecekHaftaKonu').value = '';
        document.getElementById('haftaMotivasyon').value = '';
        document.getElementById('haftaMotivasyonAciklama').value = '';
    }

    function tumHaftalikKayitlariSil(){
        if(confirm("TÃ¼m haftalÄ±k kayÄ±tlarÄ± silmek Ã¼zeresiniz. Emin misiniz?")){
            database.ref("haftalikDegerlendirme").remove().then(()=>{
                alert("ğŸ—‘ï¸ KayÄ±tlar silindi.");
                refreshWeekly();
            });
        }
    }

    function haftalikKayitlariListele(){
        const liste = document.getElementById('haftalikKayitListesi');
        liste.innerHTML = '';
        const ozet = document.getElementById('haftalikOzet');
        ozet.innerHTML = '';
        const durumMsj = document.getElementById('haftaDurumMesaji');
        durumMsj.textContent = '';
        
        let paginationContainer = document.getElementById('haftalikPagination');
        if(!paginationContainer) { /* */ }
        paginationContainer.innerHTML = '';

        database.ref("haftalikDegerlendirme").once("value").then(snap=>{
            const val = snap.val() || {};
            const allEntries = Object.entries(val);
            const filtre = document.getElementById('haftalikFiltreOgrenci').value;

            let filtered = allEntries.filter(([_, d]) => !filtre || d.ogrenci === filtre);

            if(filtered.length === 0){
                liste.innerHTML = '<div class="text-center text-muted py-3">KayÄ±t yok.</div>';
                return;
            }

            // Ã–zet Bilgi (Toplam Ders)
            ozet.textContent = `Toplam ${filtered.length} kayÄ±t listelendi.`;

            // SÄ±ralama (Yeniden eskiye)
            filtered.sort((a,b)=> b[1].timestamp - a[1].timestamp);

            // Sayfalama
            const pageSize = 5;
            const totalPages = Math.ceil(filtered.length / pageSize);
            if (haftalikCurrentPage > totalPages) haftalikCurrentPage = totalPages;
            if (haftalikCurrentPage < 1) haftalikCurrentPage = 1;
            
            const pageEntries = filtered.slice((haftalikCurrentPage-1)*pageSize, haftalikCurrentPage*pageSize);

            pageEntries.forEach(([key, d])=>{
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-primary mb-0">${d.ogrenci}</h6>
                        <span class="badge bg-light text-dark border">${durumIcon(d.durum)}</span>
                    </div>
                    <div class="small text-muted mb-2">
                        <div><strong>Konu:</strong> ${d.konu || '-'}</div>
                        <div><strong>Gelecek Ã–dev:</strong> ${d.glcOdev || '-'} (${formatTurkishDate(d.glcTarih)})</div>
                        ${d.motivasyon ? `<div><strong>Motivasyon:</strong> ${d.motivasyon}/10</div>` : ''}
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="haftalikGuncelleAc('${key}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="haftalikSil('${key}')"><i class="bi bi-trash"></i></button>
                    </div>
                `;
                liste.appendChild(item);
            });

             // Sayfalama ButonlarÄ±
            if (totalPages > 1) {
                let pagHtml = '<nav><ul class="pagination justify-content-center mt-2">';
                pagHtml += `<li class="page-item ${haftalikCurrentPage === 1 ? 'disabled' : ''}">
                              <button class="page-link" onclick="haftalikChangePage(${haftalikCurrentPage - 1})">Â«</button>
                            </li>`;
                for(let i=1; i<=totalPages; i++){
                    pagHtml += `<li class="page-item ${i === haftalikCurrentPage ? 'active' : ''}">
                                  <button class="page-link" onclick="haftalikChangePage(${i})">${i}</button>
                                </li>`;
                }
                pagHtml += `<li class="page-item ${haftalikCurrentPage === totalPages ? 'disabled' : ''}">
                              <button class="page-link" onclick="haftalikChangePage(${haftalikCurrentPage + 1})">Â»</button>
                            </li>`;
                pagHtml += '</ul></nav>';
                paginationContainer.innerHTML = pagHtml;
            }
        });
    }

    function haftalikChangePage(p){
        haftalikCurrentPage = p;
        haftalikKayitlariListele();
    }

    function haftalikSil(key){
        if(confirm("Bu kaydÄ± silmek istediÄŸinize emin misiniz?")){
            database.ref("haftalikDegerlendirme/"+key).remove().then(()=> refreshWeekly());
        }
    }

    function haftalikGuncelleAc(key){
        database.ref("haftalikDegerlendirme/"+key).once("value").then(snap=>{
            const d = snap.val();
            if(!d) return;
            guncellenecekHaftaKey = key;
            document.getElementById('guncelleHaftaOgrenci').value = d.ogrenci || '';
            document.getElementById('guncelleHaftaKonu').value = d.konu || '';
            document.getElementById('guncelleHaftaOdev').value = d.odev || '';
            document.getElementById('guncelleHaftaDurum').value = d.durum || '';
            document.getElementById('guncelleHaftaTarih').value = d.glcTarih || '';
            document.getElementById('guncelleGelecekKonu').value = d.glcKonu || '';
            document.getElementById('guncelleGelecekOdev').value = d.glcOdev || '';
            document.getElementById('guncelleHaftaMotivasyon').value = d.motivasyon || '';
            document.getElementById('guncelleHaftaMotivasyonAciklama').value = d.aciklama || '';
            
            bsModal('haftalikGuncelleModal').show();
        });
    }

    function haftalikKaydiGuncelleKaydet(){
        if(!guncellenecekHaftaKey) return;
        const guncelVeri = {
            ogrenci: document.getElementById('guncelleHaftaOgrenci').value,
            konu: document.getElementById('guncelleHaftaKonu').value,
            odev: document.getElementById('guncelleHaftaOdev').value,
            durum: document.getElementById('guncelleHaftaDurum').value,
            glcTarih: document.getElementById('guncelleHaftaTarih').value,
            glcKonu: document.getElementById('guncelleGelecekKonu').value,
            glcOdev: document.getElementById('guncelleGelecekOdev').value,
            motivasyon: document.getElementById('guncelleHaftaMotivasyon').value,
            aciklama: document.getElementById('guncelleHaftaMotivasyonAciklama').value
        };
        database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update(guncelVeri).then(()=>{
            bsModal('haftalikGuncelleModal').hide();
            refreshWeekly();
            alert("âœ… GÃ¼ncellendi.");
        });
    }


    /************ WHATSAPP RAPOR ************/
    function raporOgrenciSecDoldur(){
        const sel = document.getElementById('raporOgrenciSec');
        sel.innerHTML = '';
        getOgrenciler(ogrenciler=>{
            ogrenciler.forEach(o=>{
                const opt = document.createElement('option');
                opt.value = o.ad;
                opt.textContent = o.ad;
                sel.appendChild(opt);
            });
        });
    }

    function raporTipiDegisti(){
        raporMesajiOlustur();
    }
    
    // Rapor oluÅŸturma tetikleyicisi
    document.addEventListener('DOMContentLoaded', ()=>{
        const rSec = document.getElementById('raporOgrenciSec');
        if(rSec) rSec.addEventListener('change', raporMesajiOlustur);
    });

    function raporMesajiOlustur(){
        const ogr = document.getElementById('raporOgrenciSec').value;
        const tip = document.getElementById('raporTipi').value; // haftalik veya aylik
        if(!ogr) return;

        // Son kaydÄ± bul
        database.ref("haftalikDegerlendirme").orderByChild("ogrenci").equalTo(ogr).once("value").then(snap=>{
            const val = snap.val();
            let mesaj = "";
            if(!val) {
                mesaj = `SayÄ±n Velimiz,\n\n${ogr} Ã¶ÄŸrencimizin henÃ¼z sisteme girilmiÅŸ bir deÄŸerlendirmesi bulunmamaktadÄ±r.`;
            } else {
                // En son kaydÄ± al (timestamp'e gÃ¶re)
                const list = Object.values(val).sort((a,b)=> b.timestamp - a.timestamp);
                const son = list[0]; 
                
                // Mesaj TaslaÄŸÄ±
                const tarihStr = formatTurkishDate(new Date().toISOString());
                
                if(tip === 'haftalik'){
                    mesaj = `ğŸ“… *HAFTALIK DEÄERLENDÄ°RME RAPORU* (${tarihStr})\n` +
                            `ğŸ‘¤ *Ã–ÄŸrenci:* ${son.ogrenci}\n\n` +
                            `ğŸ“Œ *Bu Hafta Ä°ÅŸlenen Konu:* ${son.konu || 'Belirtilmedi'}\n` +
                            `ğŸ“š *Ã–dev Durumu:* ${durumIcon(son.durum)}\n` +
                            `ğŸ“ *Verilen Ã–dev:* ${son.odev || '-'}\n\n` +
                            `ğŸ”œ *Gelecek Hafta Ã–devi:* ${son.glcOdev || '-'}\n` +
                            `ğŸ—“ *Teslim Tarihi:* ${formatTurkishDate(son.glcTarih)}\n` +
                            `ğŸ“Š *Motivasyon:* ${son.motivasyon ? son.motivasyon+'/10' : '-'}\n\n` +
                            `ğŸ’¬ *EÄŸitmen Notu:* ${son.aciklama || 'Ä°yi Ã§alÄ±ÅŸmalar dileriz.'}\n\n` +
                            `_Birebir Takip Sistemi_`;
                } else {
                    // AylÄ±k rapor iÃ§in basit bir Ã¶zet (son 4 hafta)
                    const buAy = list.slice(0, 4); 
                    const tamamlanan = buAy.filter(x=> (x.durum||'').toLowerCase() === 'yapti').length;
                    
                    mesaj = `ğŸ“† *AYLIK GELÄ°ÅÄ°M RAPORU*\n` +
                            `ğŸ‘¤ *Ã–ÄŸrenci:* ${ogr}\n\n` +
                            `Son 4 haftada yapÄ±lan ders sayÄ±sÄ±: ${buAy.length}\n` +
                            `Tamamlanan Ã–devler: ${tamamlanan} / ${buAy.length}\n\n` +
                            `Son iÅŸlenen konu: ${son.konu || '-'}\n` +
                            `Genel Durum: ${son.aciklama || 'GeliÅŸim devam ediyor.'}\n\n` +
                            `_Birebir Takip Sistemi_`;
                }
            }
            document.getElementById('raporMesaj').value = mesaj;
        });
    }

    function whatsappMesajGonder(){
        const msg = document.getElementById('raporMesaj').value;
        if(!msg) return;
        const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
    }
    
    function raporFormYenile(){
        raporMesajiOlustur();
    }

    function qrKodModalAc(){
        const msg = document.getElementById('raporMesaj').value;
        if(!msg) { alert("Ã–nce bir mesaj oluÅŸmalÄ±."); return; }
        
        const container = document.getElementById('qrModalCanvas');
        container.innerHTML = '';
        const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        
        new QRCode(container, {
            text: url,
            width: 200,
            height: 200
        });
        
        bsModal('qrModal').show();
    }
    
    // Sayfa YÃ¼klendiÄŸinde
    window.addEventListener('load', ()=>{
      refreshAll(); 
      // Tetikleyiciler
      const raporTipEl = document.getElementById('raporTipi');
      if(raporTipEl) raporTipEl.addEventListener('change', raporMesajiOlustur);
      
      const raporOgrEl = document.getElementById('raporOgrenciSec');
      if(raporOgrEl) raporOgrEl.addEventListener('change', raporMesajiOlustur);
      
      const odevFiltre = document.getElementById('odevFiltreOgrenci');
      if (odevFiltre) {
        odevFiltre.addEventListener('change', () => {
          odevCurrentPage = 1;
          odevListele();
        });
      }
      const haftalikFiltre = document.getElementById('haftalikFiltreOgrenci');
      if (haftalikFiltre) {
        haftalikFiltre.addEventListener('change', () => {
          haftalikCurrentPage = 1;
          haftalikKayitlariListele();
        });
      }
    });

  </script>
</body>
</html>
