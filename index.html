<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ã–zel Ders Takip Sistemi</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary-color: #4f46e5; /* Indigo 600 */
      --primary-hover: #4338ca;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-radius: 1rem;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      padding-bottom: 80px; /* Mobil navbar iÃ§in boÅŸluk */
    }

    /* Modern Kartlar */
    .app-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1px solid rgba(229, 231, 235, 0.5);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin-bottom: 1.5rem;
      padding: 1.5rem;
    }

    .app-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    }

    h1, h2, h3, h4, h5, h6 { font-weight: 600; letter-spacing: -0.025em; }

    /* Form ElemanlarÄ± */
    .form-control, .form-select {
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      padding: 0.625rem 0.75rem;
      font-size: 0.95rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .form-label { font-weight: 500; font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.4rem; }

    /* Butonlar */
    .btn {
      border-radius: 0.5rem;
      font-weight: 500;
      padding: 0.625rem 1.25rem;
      transition: all 0.2s;
    }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    
    /* Navbar & Tabs */
    .top-navbar {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 1030;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .nav-pills {
      background: #e0e7ff;
      padding: 0.25rem;
      border-radius: 0.75rem;
      display: inline-flex;
    }
    .nav-pills .nav-link {
      border-radius: 0.5rem;
      color: #4338ca;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.2s;
    }
    .nav-pills .nav-link.active {
      background-color: #fff;
      color: var(--primary-color);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Listeler */
    .list-group-item {
      border: none;
      border-bottom: 1px solid #f3f4f6;
      padding: 1rem 0;
      background: transparent;
    }
    .list-group-item:last-child { border-bottom: none; }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-badge.success { background: #dcfce7; color: #166534; }
    .status-badge.danger { background: #fee2e2; color: #991b1b; }
    .status-badge.warning { background: #fef9c3; color: #854d0e; }
    .status-badge.info { background: #dbeafe; color: #1e40af; }

    /* QR */
    .qr-container {
      background: #fff;
      padding: 1rem;
      border-radius: 1rem;
      border: 2px dashed #cbd5e1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-pills { width: 100%; display: flex; overflow-x: auto; flex-wrap: nowrap; }
      .nav-pills .nav-link { white-space: nowrap; flex: 1; text-align: center; }
      .app-card { padding: 1rem; }
    }
  </style>

  <script>
    // --- FIREBASE BAÅLATMA ---
    const firebaseConfig = {
      apiKey: "AIzaSyD4Ctf-F5BSU_4fHK2WgTQUj_okrzyI7OI",
      authDomain: "birebir-1df98.firebaseapp.com",
      databaseURL: "https://birebir-1df98-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "birebir-1df98",
      storageBucket: "birebir-1df98.firebasestorage.app",
      messagingSenderId: "145327250159",
      appId: "1:145327250159:web:f4d8be51e312f5552f591a",
      measurementId: "G-8CB54NS9QW"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
</head>
<body>

  <header class="top-navbar">
    <div class="container d-flex align-items-center justify-content-between">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <img src="https://i.ibb.co/F4cDX7MX/logom.jpg" alt="Logo" width="36" height="36" class="rounded-circle shadow-sm" />
        <div>
          <h1 class="h6 mb-0 fw-bold text-primary">Ders Takip</h1>
          <span class="small text-muted" style="font-size: 0.75rem;">YÃ¶netim Paneli</span>
        </div>
      </a>
      <ul class="nav nav-pills ms-auto" id="mainTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pnl-ogrenci" type="button"><i class="bi bi-people-fill"></i> <span class="d-none d-md-inline">Ã–ÄŸrenciler</span></button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pnl-haftalik" type="button"><i class="bi bi-calendar-check-fill"></i> <span class="d-none d-md-inline">HaftalÄ±k</span></button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pnl-rapor" type="button"><i class="bi bi-whatsapp"></i> <span class="d-none d-md-inline">Rapor</span></button>
        </li>
      </ul>
    </div>
  </header>

  <main class="container py-4">
    <div class="tab-content">

      <div class="tab-pane fade show active" id="pnl-ogrenci">
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="app-card sticky-lg-top" style="top: 100px;">
              <h5 class="mb-3 d-flex align-items-center gap-2"><i class="bi bi-person-plus text-primary"></i> Yeni Ã–ÄŸrenci</h5>
              <div class="d-flex flex-column gap-3">
                <div>
                  <label class="form-label">Ad Soyad</label>
                  <input type="text" id="ogrenciAd" class="form-control" placeholder="Ã–rn: Ali Veli" />
                </div>
                <div>
                  <label class="form-label">SÄ±nÄ±f</label>
                  <select id="ogrenciSinif" class="form-select">
                    <option value="">SeÃ§iniz</option>
                    <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option><option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
                  </select>
                </div>
                <div class="d-grid gap-2">
                  <button class="btn btn-primary" onclick="ogrenciEkle()">Kaydet</button>
                  <button class="btn btn-light text-muted" onclick="temizleInputlar()">Temizle</button>
                </div>
              </div>
            </div>
            
            <div class="app-card mt-3">
                <h5 class="mb-3">Ã–ÄŸrenci Listesi</h5>
                <div id="ogrenciListesi" class="list-group list-group-flush"></div>
             </div>
          </div>

          <div class="col-lg-8">
            <div class="app-card">
              <h5 class="mb-4 d-flex align-items-center gap-2"><i class="bi bi-journal-plus text-primary"></i> Ã–dev Atama</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Ã–ÄŸrenci</label>
                  <select id="odevOgrenci" class="form-select"><option value="">YÃ¼kleniyor...</option></select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tarih</label>
                  <input type="date" id="odevTarih" class="form-control"/>
                </div>
                <div class="col-12">
                  <label class="form-label">Ã–dev Ä°Ã§eriÄŸi</label>
                  <textarea id="odevIcerik" class="form-control" rows="3" placeholder="Ã–dev detaylarÄ±nÄ± buraya yazÄ±n..."></textarea>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                  <button class="btn btn-light" onclick="odevFormTemizle()">Temizle</button>
                  <button class="btn btn-success px-4" onclick="odevEkle()"><i class="bi bi-check-lg"></i> Ã–devi Ekle</button>
                </div>
              </div>
            </div>

            <div class="app-card">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Verilen Ã–devler</h5>
                <button class="btn btn-sm btn-outline-danger" onclick="tumOdevleriSil()">TÃ¼mÃ¼nÃ¼ Sil</button>
              </div>
              <div class="row mb-3">
                 <div class="col-md-5">
                   <select id="odevFiltreOgrenci" class="form-select form-select-sm">
                     <option value="">TÃ¼m Ã–ÄŸrenciler</option>
                   </select>
                 </div>
              </div>
              <div id="odevListesi" class="list-group list-group-flush"></div>
              <div id="odevPagination" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pnl-haftalik">
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="app-card">
                    <h5 class="mb-3 text-primary">ğŸ“‹ HaftalÄ±k GiriÅŸ</h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Ã–ÄŸrenci</label>
                            <select id="haftaOgrenci" class="form-select"><option value="">SeÃ§iniz</option></select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Bu HaftanÄ±n Konusu</label>
                            <textarea id="buHaftaKonu" class="form-control" rows="2"></textarea>
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Kontrol Edilecek Ã–dev</label>
                            <select id="haftaOdev" class="form-select"><option value="">Ã–dev SeÃ§in</option></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ã–dev Durumu</label>
                            <select id="odevDurumu" class="form-select">
                                <option value="">SeÃ§iniz</option>
                                <option value="yapti">âœ… YaptÄ±</option>
                                <option value="yapmadi">âŒ YapmadÄ±</option>
                                <option value="eksik">âš ï¸ Eksik</option>
                                <option value="getirmedi">ğŸ“­ Getirmedi</option>
                            </select>
                        </div>
                        <div class="col-12"><hr class="text-muted"></div>
                        <div class="col-12">
                            <label class="form-label">Gelecek Hafta Ã–devi</label>
                            <textarea id="gelecekHaftaOdev" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                             <label class="form-label">Teslim Tarihi</label>
                             <input type="date" id="gelecekTarih" class="form-control" />
                        </div>
                         <div class="col-md-6">
                             <label class="form-label">Gelecek Konu</label>
                             <input type="text" id="gelecekHaftaKonu" class="form-control" />
                        </div>
                        <div class="col-12"><hr class="text-muted"></div>
                        <div class="col-4">
                            <label class="form-label">Motivasyon</label>
                            <input type="number" id="haftaMotivasyon" class="form-control text-center" min="1" max="10" value="10" />
                        </div>
                         <div class="col-8">
                            <label class="form-label">Genel Durum</label>
                            <input type="text" id="haftaMotivasyonAciklama" class="form-control" placeholder="Ders durumu hakkÄ±nda not..." />
                        </div>
                        <div class="col-12 d-grid mt-3">
                            <button class="btn btn-primary" onclick="haftalikVeriyiEkle()">Kaydet ve Listele</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-7">
                <div class="app-card">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">GeÃ§miÅŸ DeÄŸerlendirmeler</h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="tumHaftalikKayitlariSil()">Temizle</button>
                      </div>
                      <div class="mb-3">
                         <select id="haftalikFiltreOgrenci" class="form-select form-select-sm w-50">
                             <option value="">TÃ¼mÃ¼</option>
                         </select>
                      </div>
                      <div id="haftalikKayitListesi" class="list-group list-group-flush"></div>
                      <div id="haftalikOzet" class="mt-2 small text-muted fst-italic"></div>
                      <div id="haftalikPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pnl-rapor">
        <div class="app-card mw-800 mx-auto">
             <h4 class="mb-4 text-center text-success"><i class="bi bi-whatsapp"></i> Veli Bilgilendirme SihirbazÄ±</h4>
             <div class="row g-3 justify-content-center">
                 <div class="col-md-5">
                     <label class="form-label">Ã–ÄŸrenci SeÃ§in</label>
                     <select id="raporOgrenciSec" class="form-select form-select-lg shadow-sm" onchange="raporMesajiOlustur()">
                         <option value="">SeÃ§iniz</option>
                     </select>
                 </div>
                 <div class="col-md-5">
                     <label class="form-label">Rapor Tipi</label>
                     <select id="raporTipi" class="form-select form-select-lg shadow-sm" onchange="raporTipiDegisti()">
                        <option value="haftalik">ğŸ“… HaftalÄ±k Rapor</option>
                        <option value="aylik">ğŸ“† AylÄ±k Rapor</option>
                     </select>
                 </div>
                 
                 <div class="col-12">
                     <div class="p-3 bg-light rounded border mt-2">
                         <label class="form-label text-muted small text-uppercase fw-bold">Mesaj Ã–nizleme</label>
                         <textarea id="raporMesaj" class="form-control border-0 bg-transparent" rows="12" style="font-family: monospace; font-size: 0.9rem;"></textarea>
                     </div>
                 </div>
                 
                 <div class="col-12 d-flex justify-content-center gap-3 mt-3">
                     <button class="btn btn-success btn-lg px-5" onclick="whatsappMesajGonder()">
                         <i class="bi bi-send-fill"></i> WhatsApp'a Aktar
                     </button>
                     <button class="btn btn-dark btn-lg px-4" onclick="qrKodModalAc()">
                         <i class="bi bi-qr-code"></i> QR Kod
                     </button>
                 </div>
                 <div class="col-12 text-center">
                    <button class="btn btn-link text-muted btn-sm" onclick="raporMesajiOlustur()"><i class="bi bi-arrow-clockwise"></i> MesajÄ± Yeniden OluÅŸtur</button>
                 </div>
             </div>
             
             <div id="qrCanvasContainer" class="d-none justify-content-center mt-4 p-3 bg-white border rounded"></div>
        </div>
      </div>

    </div>
  </main>

  <div class="modal fade" id="ogrenciGuncelleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ã–ÄŸrenci DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <input type="text" id="guncelleAd" class="form-control mb-3" placeholder="Ad Soyad">
            <select id="guncelleSinif" class="form-select">
                <option>5. SÄ±nÄ±f</option><option>6. SÄ±nÄ±f</option><option>7. SÄ±nÄ±f</option><option>8. SÄ±nÄ±f</option>
            </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="ogrenciGuncelleKaydet()">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="odevGuncelleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ã–dev DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <label class="small text-muted">Tarih</label>
            <input type="date" id="guncelleOdevTarih" class="form-control mb-3">
            <label class="small text-muted">Ä°Ã§erik</label>
            <textarea id="guncelleOdevIcerik" rows="4" class="form-control"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="odevGuncelleKaydet()">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="haftalikGuncelleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">HaftalÄ±k KayÄ±t DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
           <div class="col-6"><small>Ã–ÄŸrenci</small><input type="text" id="guncelleHaftaOgrenci" class="form-control" readonly></div>
           <div class="col-6"><small>Tarih</small><input type="date" id="guncelleHaftaTarih" class="form-control"></div>
           <div class="col-12"><small>Bu Hafta Konusu</small><input type="text" id="guncelleHaftaKonu" class="form-control"></div>
           <div class="col-6"><small>Ã–dev</small><input type="text" id="guncelleHaftaOdev" class="form-control"></div>
           <div class="col-6"><small>Durum (yapti,yapmadi..)</small><input type="text" id="guncelleHaftaDurum" class="form-control"></div>
           <div class="col-12"><small>Gelecek Konu</small><input type="text" id="guncelleGelecekKonu" class="form-control"></div>
           <div class="col-12"><small>Gelecek Ã–dev</small><input type="text" id="guncelleGelecekOdev" class="form-control"></div>
           <div class="col-4"><small>Motivasyon</small><input type="number" id="guncelleHaftaMotivasyon" class="form-control"></div>
           <div class="col-8"><small>AÃ§Ä±klama</small><input type="text" id="guncelleHaftaMotivasyonAciklama" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="haftalikKaydiGuncelleKaydet()">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
         <div class="modal-body text-center p-4">
            <h5 class="mb-3">WhatsApp QR Kod</h5>
            <div id="qrModalCanvas" class="d-flex justify-content-center"></div>
            <p class="text-muted mt-3 small">Telefon kamerasÄ±nÄ± okutarak mesajÄ± aÃ§abilirsiniz.</p>
         </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ YARDIMCILAR ************/
    let guncellenecekId = null;
    let guncellenecekOdevKey = null;
    let guncellenecekHaftaKey = null;

    const bsModal = (id) => bootstrap.Modal.getOrCreateInstance(document.getElementById(id));

    const durumIcon = (durum) => {
      switch ((durum || '').toLowerCase()) {
        case 'yapti': return '<span class="status-badge success">âœ… YaptÄ±</span>';
        case 'yapmadi': return '<span class="status-badge danger">âŒ YapmadÄ±</span>';
        case 'eksik': return '<span class="status-badge warning">âš ï¸ Eksik</span>';
        case 'getirmedi': return '<span class="status-badge info">ğŸ“­ Getirmedi</span>';
        default: return '<span class="badge bg-secondary">â– Belirsiz</span>';
      }
    };

    function formatTurkishDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    let odevCurrentPage = 1;
    let haftalikCurrentPage = 1;

    // --- REFRESH FONKSÄ°YONLARI ---
    window.addEventListener('load', ()=>{
        refreshAll();
        // Event Listeners for Filters
        const odevFiltre = document.getElementById('odevFiltreOgrenci');
        if(odevFiltre) odevFiltre.addEventListener('change', () => { odevCurrentPage=1; odevListele(); });

        const haftalikFiltre = document.getElementById('haftalikFiltreOgrenci');
        if(haftalikFiltre) haftalikFiltre.addEventListener('change', () => { haftalikCurrentPage=1; haftalikKayitlariListele(); });
    });

    function refreshStudents() {
      ogrenciListele();
      doldurOgrenciSecimi(); 
      doldurHaftaOgrenciListesi();
      raporOgrenciSecDoldur();
      doldurOdevFiltre();
      doldurHaftalikFiltre();
    }
    function refreshAssignments() { odevListele(); }
    function refreshWeekly() { haftalikKayitlariListele(); }
    function refreshAll() {
      refreshStudents();
      refreshAssignments();
      refreshWeekly();
    }

    // --- VERÄ°TABANI Ä°ÅLEMLERÄ° ---
    function getOgrenciler(cb){
      database.ref("ogrenciler").once("value").then(s => {
        const val = s.val();
        const arr = Array.isArray(val) ? (val.filter(Boolean) || []) : (Object.values(val || {}));
        cb(arr || []);
      }).catch(_ => cb([]));
    }
    function setOgrenciler(arr){ return database.ref("ogrenciler").set(arr || []); }

    function temizleInputlar(){
      document.getElementById('ogrenciAd').value = '';
      document.getElementById('ogrenciSinif').value = '';
    }

    function ogrenciEkle(){
      const ad = document.getElementById('ogrenciAd').value.trim();
      const sinif = document.getElementById('ogrenciSinif').value;
      if(!ad || !sinif){ alert("LÃ¼tfen ad ve sÄ±nÄ±f giriniz."); return; }

      getOgrenciler(ogrenciler=>{
        const id = Date.now();
        const yeni = { id, ad, sinif };
        const guncel = [...ogrenciler, yeni];
        setOgrenciler(guncel).then(()=>{
          // alert("Ã–ÄŸrenci eklendi."); // Modern yapÄ±da alert yerine sessiz gÃ¼ncelleme daha ÅŸÄ±ktÄ±r ama orijinali koruduk.
          temizleInputlar();
          refreshStudents();
        });
      });
    }

    function ogrenciSil(id){
      if(!confirm("Silmek istediÄŸinize emin misiniz?")) return;
      getOgrenciler(ogrenciler=>{
        const guncel = ogrenciler.filter(o=>o.id !== id);
        setOgrenciler(guncel).then(()=>{ refreshStudents(); });
      });
    }

    function ogrenciGuncelleAc(id){
      getOgrenciler(ogrenciler=>{
        const o = ogrenciler.find(x=>x.id===id);
        if(!o) return;
        guncellenecekId = id;
        document.getElementById('guncelleAd').value = o.ad;
        document.getElementById('guncelleSinif').value = o.sinif;
        bsModal('ogrenciGuncelleModal').show();
      });
    }

    function ogrenciGuncelleKaydet(){
       const ad = document.getElementById('guncelleAd').value.trim();
       const sinif = document.getElementById('guncelleSinif').value;
       getOgrenciler(ogrenciler=>{
           const guncel = ogrenciler.map(o=> o.id === guncellenecekId ? {...o, ad, sinif} : o);
           setOgrenciler(guncel).then(()=>{
               bsModal('ogrenciGuncelleModal').hide();
               refreshStudents();
           });
       });
    }

    function ogrenciListele(){
      const liste = document.getElementById('ogrenciListesi');
      liste.innerHTML = '<div class="text-muted p-3">YÃ¼kleniyor...</div>';
      getOgrenciler(ogrenciler=>{
        liste.innerHTML = '';
        if(!ogrenciler.length) { liste.innerHTML = '<div class="text-muted p-3">KayÄ±t yok.</div>'; return; }
        ogrenciler.forEach(o=>{
            const div = document.createElement('div');
            div.className = 'list-group-item d-flex justify-content-between align-items-center';
            div.innerHTML = `
               <div><span class="fw-bold">${o.ad}</span> <span class="badge bg-light text-dark border ms-2">${o.sinif}</span></div>
               <div class="btn-group">
                 <button class="btn btn-sm btn-outline-primary" onclick="ogrenciGuncelleAc(${o.id})"><i class="bi bi-pencil"></i></button>
                 <button class="btn btn-sm btn-outline-danger" onclick="ogrenciSil(${o.id})"><i class="bi bi-trash"></i></button>
               </div>
            `;
            liste.appendChild(div);
        });
      });
    }

    // --- Ã–DEV Ä°ÅLEMLERÄ° ---
    function doldurOgrenciSecimi(){
        const sel = document.getElementById('odevOgrenci');
        sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
        getOgrenciler(ogrenciler=>{
            ogrenciler.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.ad; opt.textContent = o.ad;
                sel.appendChild(opt);
            });
        });
    }

    function doldurOdevFiltre(){
        const sel = document.getElementById('odevFiltreOgrenci');
        const val = sel.value;
        sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
        getOgrenciler(ogrenciler=>{
            ogrenciler.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.ad; opt.textContent = o.ad;
                sel.appendChild(opt);
            });
            sel.value = val;
        });
    }

    function odevEkle(){
        const ogrenci = document.getElementById('odevOgrenci').value;
        const tarih = document.getElementById('odevTarih').value;
        const icerik = document.getElementById('odevIcerik').value;
        if(!ogrenci || !tarih){ alert("Ã–ÄŸrenci ve Tarih seÃ§iniz."); return; }
        
        const yeniOdev = { ogrenci, tarih, icerik };
        database.ref("odevler").push(yeniOdev).then(()=>{
            alert("Ã–dev eklendi.");
            odevFormTemizle();
            refreshAssignments();
        });
    }

    function odevFormTemizle(){
        document.getElementById('odevIcerik').value = '';
        document.getElementById('odevTarih').value = '';
    }
    
    function tumOdevleriSil(){
        if(confirm("TÃ¼m Ã¶dev kayÄ±tlarÄ± silinecek! Emin misiniz?")){
            database.ref("odevler").remove().then(()=> refreshAssignments());
        }
    }
    
    function odevSil(key){
        if(confirm("Bu Ã¶devi silmek istiyor musunuz?")){
            database.ref("odevler/"+key).remove().then(()=> refreshAssignments());
        }
    }

    function odevGuncelleModalAc(key){
        database.ref("odevler/"+key).once("value").then(s=>{
            const o = s.val();
            guncellenecekOdevKey = key;
            document.getElementById('guncelleOdevTarih').value = o.tarih;
            document.getElementById('guncelleOdevIcerik').value = o.icerik;
            bsModal('odevGuncelleModal').show();
        });
    }
    
    function odevGuncelleKaydet(){
        const tarih = document.getElementById('guncelleOdevTarih').value;
        const icerik = document.getElementById('guncelleOdevIcerik').value;
        database.ref("odevler/"+guncellenecekOdevKey).update({ tarih, icerik }).then(()=>{
            bsModal('odevGuncelleModal').hide();
            refreshAssignments();
        });
    }

    function odevListele(){
        const liste = document.getElementById('odevListesi');
        const paginationContainer = document.getElementById('odevPagination');
        
        database.ref("odevler").once("value").then(snap => {
            const val = snap.val() || {};
            const allEntries = Object.entries(val);
            const filterVal = document.getElementById('odevFiltreOgrenci')?.value;
            
            let filtered = allEntries.filter(([_, odev]) => !filterVal || odev.ogrenci === filterVal);
            filtered.sort((a,b) => new Date(b[1].tarih) - new Date(a[1].tarih)); // Tarihe gÃ¶re azalan
            
            // Pagination Logic
            const pageSize = 5;
            const totalPages = Math.ceil(filtered.length / pageSize);
            if(odevCurrentPage > totalPages) odevCurrentPage = totalPages || 1;
            
            const pageEntries = filtered.slice((odevCurrentPage-1)*pageSize, odevCurrentPage*pageSize);
            
            liste.innerHTML = '';
            if(filtered.length === 0){ liste.innerHTML = '<div class="text-muted text-center py-4">KayÄ±t bulunamadÄ±.</div>'; return; }

            pageEntries.forEach(([key, odev])=>{
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-start mb-2 border rounded bg-white';
                item.innerHTML = `
                  <div class="ms-2 me-auto">
                    <div class="fw-bold text-primary">${odev.ogrenci} <span class="text-muted fw-normal small ms-2"><i class="bi bi-clock"></i> ${formatTurkishDate(odev.tarih)}</span></div>
                    <p class="mb-0 small text-secondary mt-1">${odev.icerik}</p>
                  </div>
                  <div class="d-flex gap-1">
                     <button class="btn btn-sm btn-light text-primary" onclick="odevGuncelleModalAc('${key}')"><i class="bi bi-pencil-square"></i></button>
                     <button class="btn btn-sm btn-light text-danger" onclick="odevSil('${key}')"><i class="bi bi-trash"></i></button>
                  </div>
                `;
                liste.appendChild(item);
            });
            
            // Basit Pagination Kontrolleri
            let html = '<nav><ul class="pagination justify-content-center pagination-sm">';
            html += `<li class="page-item ${odevCurrentPage===1?'disabled':''}"><button class="page-link" onclick="if(odevCurrentPage>1){odevCurrentPage--; odevListele();}">Â«</button></li>`;
            html += `<li class="page-item disabled"><span class="page-link">${odevCurrentPage} / ${totalPages || 1}</span></li>`;
            html += `<li class="page-item ${odevCurrentPage===totalPages?'disabled':''}"><button class="page-link" onclick="if(odevCurrentPage<${totalPages}){odevCurrentPage++; odevListele();}">Â»</button></li>`;
            html += '</ul></nav>';
            paginationContainer.innerHTML = html;
        });
    }

    // --- HAFTALIK DEÄERLENDÄ°RME ---
    function doldurHaftaOgrenciListesi(){
        const sel = document.getElementById('haftaOgrenci');
        sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§in</option>';
        getOgrenciler(ogrenciler=>{
            ogrenciler.forEach(o=>{
                const opt = document.createElement('option');
                opt.value = o.ad; opt.textContent = o.ad;
                sel.appendChild(opt);
            });
        });
        
        // Ã–dev listesini de doldurmak iÃ§in listener (BasitÃ§e, seÃ§ilen Ã¶ÄŸrencinin Ã¶devlerini getirir)
        sel.addEventListener('change', function(){
             const ogrenciAdi = this.value;
             const odevSel = document.getElementById('haftaOdev');
             odevSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
             database.ref("odevler").once("value").then(snap=>{
                 odevSel.innerHTML = '<option value="">Ã–dev SeÃ§in</option>';
                 const val = snap.val()||{};
                 Object.values(val).filter(x=>x.ogrenci===ogrenciAdi).forEach(od=>{
                     const opt = document.createElement('option');
                     opt.value = od.icerik; 
                     opt.textContent = `${formatTurkishDate(od.tarih)} - ${od.icerik.substring(0,30)}...`;
                     odevSel.appendChild(opt);
                 });
             });
        });
    }

    function doldurHaftalikFiltre(){
         const sel = document.getElementById('haftalikFiltreOgrenci');
         const current = sel.value;
         sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
         getOgrenciler(ogrenciler=>{
             ogrenciler.forEach(o=>{
                 const opt = document.createElement('option');
                 opt.value = o.ad; opt.textContent = o.ad;
                 sel.appendChild(opt);
             });
             sel.value = current;
         });
    }

    function haftalikVeriyiEkle(){
        const veri = {
            ogrenci: document.getElementById('haftaOgrenci').value,
            konu: document.getElementById('buHaftaKonu').value,
            odev: document.getElementById('haftaOdev').value,
            durum: document.getElementById('odevDurumu').value,
            gelecekOdev: document.getElementById('gelecekHaftaOdev').value,
            teslimTarihi: document.getElementById('gelecekTarih').value,
            gelecekKonu: document.getElementById('gelecekHaftaKonu').value,
            motivasyon: document.getElementById('haftaMotivasyon').value,
            aciklama: document.getElementById('haftaMotivasyonAciklama').value,
            tarih: new Date().toISOString().split('T')[0] // KayÄ±t tarihi
        };
        
        if(!veri.ogrenci){ alert("Ã–ÄŸrenci seÃ§melisiniz."); return; }
        
        database.ref("haftalikDegerlendirme").push(veri).then(()=>{
            alert("HaftalÄ±k kayÄ±t eklendi.");
            // Formu temizle
            document.getElementById('buHaftaKonu').value = '';
            document.getElementById('gelecekHaftaOdev').value = '';
            document.getElementById('haftaMotivasyonAciklama').value = '';
            refreshWeekly();
        });
    }
    
    function tumHaftalikKayitlariSil(){
        if(confirm("TÃœM haftalÄ±k kayÄ±tlar silinecek. Emin misiniz?")){
            database.ref("haftalikDegerlendirme").remove().then(()=>refreshWeekly());
        }
    }
    
    function haftalikSil(key){
        if(confirm("Silinsin mi?")){
            database.ref("haftalikDegerlendirme/"+key).remove().then(()=>refreshWeekly());
        }
    }
    
    function haftalikGuncelleModalAc(key){
        database.ref("haftalikDegerlendirme/"+key).once("value").then(s=>{
             const d = s.val();
             guncellenecekHaftaKey = key;
             document.getElementById('guncelleHaftaOgrenci').value = d.ogrenci;
             document.getElementById('guncelleHaftaTarih').value = d.tarih;
             document.getElementById('guncelleHaftaKonu').value = d.konu;
             document.getElementById('guncelleHaftaOdev').value = d.odev;
             document.getElementById('guncelleHaftaDurum').value = d.durum;
             document.getElementById('guncelleGelecekKonu').value = d.gelecekKonu || '';
             document.getElementById('guncelleGelecekOdev').value = d.gelecekOdev || '';
             document.getElementById('guncelleHaftaMotivasyon').value = d.motivasyon || '';
             document.getElementById('guncelleHaftaMotivasyonAciklama').value = d.aciklama || '';
             bsModal('haftalikGuncelleModal').show();
        });
    }
    
    function haftalikKaydiGuncelleKaydet(){
        const updates = {
             ogrenci: document.getElementById('guncelleHaftaOgrenci').value,
             tarih: document.getElementById('guncelleHaftaTarih').value,
             konu: document.getElementById('guncelleHaftaKonu').value,
             odev: document.getElementById('guncelleHaftaOdev').value,
             durum: document.getElementById('guncelleHaftaDurum').value,
             gelecekKonu: document.getElementById('guncelleGelecekKonu').value,
             gelecekOdev: document.getElementById('guncelleGelecekOdev').value,
             motivasyon: document.getElementById('guncelleHaftaMotivasyon').value,
             aciklama: document.getElementById('guncelleHaftaMotivasyonAciklama').value
        };
        database.ref("haftalikDegerlendirme/"+guncellenecekHaftaKey).update(updates).then(()=>{
             bsModal('haftalikGuncelleModal').hide();
             refreshWeekly();
        });
    }

    function haftalikKayitlariListele(){
        const liste = document.getElementById('haftalikKayitListesi');
        const ozet = document.getElementById('haftalikOzet');
        const pagination = document.getElementById('haftalikPagination');
        
        database.ref("haftalikDegerlendirme").once("value").then(snap=>{
            const val = snap.val() || {};
            const all = Object.entries(val);
            const filter = document.getElementById('haftalikFiltreOgrenci')?.value;
            
            let filtered = all.filter(([_, d]) => !filter || d.ogrenci === filter);
            filtered.sort((a,b) => new Date(b[1].tarih) - new Date(a[1].tarih));

            ozet.textContent = filter ? `Toplam ${filtered.length} kayÄ±t bulundu.` : '';

            // Pagination
            const pageSize = 5;
            const totalPages = Math.ceil(filtered.length / pageSize);
            if(haftalikCurrentPage > totalPages) haftalikCurrentPage = totalPages || 1;
            const pageEntries = filtered.slice((haftalikCurrentPage-1)*pageSize, haftalikCurrentPage*pageSize);

            liste.innerHTML = '';
            if(!filtered.length){ liste.innerHTML = '<div class="text-center text-muted p-3">KayÄ±t Yok</div>'; return; }

            pageEntries.forEach(([key, d])=>{
                const item = document.createElement('div');
                item.className = 'list-group-item bg-white border rounded mb-2 shadow-sm p-3';
                item.innerHTML = `
                   <div class="d-flex justify-content-between">
                      <h6 class="fw-bold mb-1 text-primary">${d.ogrenci}</h6>
                      <small class="text-muted">${formatTurkishDate(d.tarih)}</small>
                   </div>
                   <div class="row g-2 mt-2 font-monospace small">
                      <div class="col-12"><span class="fw-bold text-dark">Konu:</span> ${d.konu}</div>
                      <div class="col-12"><span class="fw-bold text-dark">Ã–dev:</span> ${durumIcon(d.durum)} <span class="text-muted">${d.odev||''}</span></div>
                      ${d.aciklama ? `<div class="col-12 text-secondary fst-italic">"${d.aciklama}"</div>` : ''}
                   </div>
                   <div class="d-flex justify-content-end mt-2 gap-2">
                       <button class="btn btn-sm btn-outline-primary" onclick="haftalikGuncelleModalAc('${key}')">DÃ¼zenle</button>
                       <button class="btn btn-sm btn-outline-danger" onclick="haftalikSil('${key}')">Sil</button>
                   </div>
                `;
                liste.appendChild(item);
            });
            
             // Pagination Controls
            let html = '<nav><ul class="pagination justify-content-center pagination-sm">';
            html += `<li class="page-item ${haftalikCurrentPage===1?'disabled':''}"><button class="page-link" onclick="if(haftalikCurrentPage>1){haftalikCurrentPage--; haftalikKayitlariListele();}">Â«</button></li>`;
            html += `<li class="page-item disabled"><span class="page-link">${haftalikCurrentPage} / ${totalPages || 1}</span></li>`;
            html += `<li class="page-item ${haftalikCurrentPage===totalPages?'disabled':''}"><button class="page-link" onclick="if(haftalikCurrentPage<${totalPages}){haftalikCurrentPage++; haftalikKayitlariListele();}">Â»</button></li>`;
            html += '</ul></nav>';
            pagination.innerHTML = html;
        });
    }

    // --- RAPORLAMA ---
    function raporOgrenciSecDoldur(){
         const sel = document.getElementById('raporOgrenciSec');
         sel.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>';
         getOgrenciler(ogrenciler=>{
             ogrenciler.forEach(o=>{
                 const opt = document.createElement('option');
                 opt.value = o.ad; opt.textContent = o.ad;
                 sel.appendChild(opt);
             });
         });
    }

    function raporTipiDegisti(){
        raporMesajiOlustur();
    }
    
    // YENÄ° FORMATLI MESAJ OLUÅTURUCU
    function raporMesajiOlustur(){
        const ogrenci = document.getElementById('raporOgrenciSec').value;
        const tip = document.getElementById('raporTipi').value;
        if(!ogrenci) { document.getElementById('raporMesaj').value = ''; return; }
        
        // Son kaydÄ± bul
        database.ref("haftalikDegerlendirme").once("value").then(snap=>{
            const val = snap.val()||{};
            const kayitlar = Object.values(val).filter(x=>x.ogrenci === ogrenci);
            // Tarihe gÃ¶re en yeni
            kayitlar.sort((a,b)=> new Date(b.tarih) - new Date(a.tarih));
            const sonKayit = kayitlar[0];

            let mesaj = `SayÄ±n Velimiz,\n\n`;
            mesaj += `Ã–ÄŸrencimiz *${ogrenci}* ile bu hafta yapÄ±lan Ã§alÄ±ÅŸmalarÄ±n Ã¶zeti aÅŸaÄŸÄ±dadÄ±r:\n\n`;

            if(sonKayit){
                mesaj += `ğŸ“š *Ä°ÅŸlenen Konu:* _${sonKayit.konu || 'Belirtilmedi'}_\n`;
                mesaj += `ğŸ“ *Ã–dev Durumu:* ${sonKayit.durum === 'yapti' ? 'âœ… Ã–devini eksiksiz yaptÄ±.' : sonKayit.durum === 'eksik' ? 'âš ï¸ Ã–devi eksik.' : 'âŒ Ã–devini yapmadÄ±.'}\n`;
                if(sonKayit.motivasyon) mesaj += `ğŸŒŸ *Derse KatÄ±lÄ±m/Motivasyon:* ${sonKayit.motivasyon}/10\n`;
                if(sonKayit.gelecekOdev) mesaj += `ğŸ“… *Gelecek Hafta Ã–devi:* _${sonKayit.gelecekOdev}_\n`;
                if(sonKayit.gelecekKonu) mesaj += `ğŸ”œ *Gelecek Hafta Konusu:* ${sonKayit.gelecekKonu}\n`;
                if(sonKayit.aciklama) mesaj += `\nğŸ’¬ *Ã–ÄŸretmen Notu:* _${sonKayit.aciklama}_\n`;
            } else {
                mesaj += "HenÃ¼z bu hafta iÃ§in veri giriÅŸi yapÄ±lmamÄ±ÅŸtÄ±r.\n";
            }
            
            mesaj += `\nÄ°lginiz iÃ§in teÅŸekkÃ¼r ederiz. ğŸ‘‹`;
            document.getElementById('raporMesaj').value = mesaj;
        });
    }
    
    function whatsappMesajGonder(){
        const mesaj = document.getElementById('raporMesaj').value;
        if(!mesaj) return;
        const url = `https://wa.me/?text=${encodeURIComponent(mesaj)}`;
        window.open(url, '_blank');
    }
    
    function qrKodModalAc(){
        const mesaj = document.getElementById('raporMesaj').value;
        if(!mesaj) { alert("Ã–nce mesaj oluÅŸturun."); return; }
        
        const container = document.getElementById('qrModalCanvas');
        container.innerHTML = '';
        new QRCode(container, {
            text: `https://wa.me/?text=${encodeURIComponent(mesaj)}`,
            width: 200,
            height: 200
        });
        bsModal('qrModal').show();
    }
    
    function raporFormYenile(){
        document.getElementById('raporOgrenciSec').value = '';
        document.getElementById('raporMesaj').value = '';
    }
  </script>
</body>
</html>
